<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seminario de Investigaci√≥n</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f9fafb;
            --bg-secondary: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --accent-color: #4D96FF;
            --success-color: #10b981;
            --error-color: #ef4444;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        [data-theme="dark"] {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --border-color: #374151;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3), 0 1px 2px 0 rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .spinner {
            border: 4px solid rgba(77, 150, 255, 0.2);
            border-left-color: var(--accent-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes slideDown {
            from { opacity: 0; max-height: 0; }
            to { opacity: 1; max-height: 1000px; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-slideDown { animation: slideDown 0.3s ease-out; }
        .animate-fadeIn { animation: fadeIn 0.5s ease-out; }
        
        .card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }
        
        .input-field {
            background-color: var(--bg-secondary);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }
        
        .input-field:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(77, 150, 255, 0.1);
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-color), #3b82f6);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn-secondary {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
        }
        
        .theme-toggle {
            background-color: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 9999px;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .theme-toggle:hover {
            border-color: var(--accent-color);
        }
        
        .toast {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 600;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        
        .toast-success { background-color: var(--success-color); }
        .toast-error { background-color: var(--error-color); }
        .toast-info { background-color: var(--accent-color); }
        
        .fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-color), #3b82f6);
            color: white;
            border: none;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s ease;
            z-index: 100;
        }
        
        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(77, 150, 255, 0.4);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const ToastContext = React.createContext();
        
        function ToastProvider({ children }) {
            const [toasts, setToasts] = React.useState([]);
            
            const showToast = (message, type = 'success') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
                setTimeout(() => {
                    setToasts(prev => prev.filter(toast => toast.id !== id));
                }, 3000);
            };
            
            return React.createElement(ToastContext.Provider, { value: { showToast } }, [
                children,
                React.createElement('div', { key: 'toasts' }, 
                    toasts.map(toast => 
                        React.createElement('div', {
                            key: toast.id,
                            className: `toast toast-${toast.type}`
                        }, toast.message)
                    )
                )
            ]);
        }
        
        const useToast = () => React.useContext(ToastContext);
        
        function useTheme() {
            const [theme, setTheme] = React.useState(() => 
                localStorage.getItem('theme') || 'light'
            );
            
            React.useEffect(() => {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
            }, [theme]);
            
            const toggleTheme = () => {
                setTheme(prev => prev === 'light' ? 'dark' : 'light');
            };
            
            return { theme, toggleTheme };
        }
        
        function ThemeToggle() {
            const { theme, toggleTheme } = useTheme();
            return React.createElement('button', {
                className: 'theme-toggle',
                onClick: toggleTheme,
                title: `Cambiar a tema ${theme === 'light' ? 'oscuro' : 'claro'}`
            }, theme === 'light' ? 'üåô' : '‚òÄÔ∏è');
        }
        
        const User = ({ className = '' }) => React.createElement('span', { className }, 'üë§');
        const LogOut = ({ className = '' }) => React.createElement('span', { className }, 'üö™');
        const Loader2 = ({ className = '' }) => React.createElement('div', { className: `spinner ${className}` });

        const LoadingSpinner = () => (
          <div className="flex justify-center items-center py-8 animate-fadeIn">
            <div className="spinner"></div>
            <p className="ml-3" style={{color: 'var(--text-secondary)'}}>Cargando...</p>
          </div>
        );
        
        function AuthPage() {
            const toast = useToast();
            const auth = firebase.auth();
            const db = firebase.firestore();
            const [isLogin, setIsLogin] = React.useState(true);
            const [email, setEmail] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [fullName, setFullName] = React.useState('');
            const [loading, setLoading] = React.useState(false);
            const [showCodeVerification, setShowCodeVerification] = React.useState(false);
            const [verificationCode, setVerificationCode] = React.useState('');
            const [generatedCode, setGeneratedCode] = React.useState('');
            const [pendingUserData, setPendingUserData] = React.useState(null);
            const [userRole, setUserRole] = React.useState('student');
            const [courseCode, setCourseCode] = React.useState('');
            
            const validateEmail = (email) => {
                const icesiBothPattern = /^[a-zA-Z0-9._%+-]+@(icesi\.edu\.co|u\.icesi\.edu\.co)$/;
                return icesiBothPattern.test(email);
            };

            const generateCode = () => Math.floor(100000 + Math.random() * 900000).toString();

            const sendVerificationEmail = async (email, code, fullName) => {
                try {
                    emailjs.init('145MnHTSSDkBVKZAU');
                    
                    const templateParams = {
                        to_name: fullName || email.split('@')[0],
                        to_email: email,
                        verification_code: code,
                        from_name: 'Seminario de Investigaci√≥n'
                    };
                    
                    const result = await emailjs.send(
                        'service_7u1zcni',
                        'template_1129sv3',
                        templateParams
                    );
                    
                    toast.showToast('C√≥digo enviado a tu correo', 'success');
                } catch (error) {
                    console.error('Error enviando email:', error);
                    console.log(`C√≥digo de verificaci√≥n para ${email}: ${code}`);
                    toast.showToast(`Error enviando email. C√≥digo (desarrollo): ${code}`, 'info');
                }
            };

            const handleAuth = async (e) => {
                e.preventDefault();
                setLoading(true);

                if (!validateEmail(email)) {
                    toast.showToast('Usa tu correo institucional (@icesi.edu.co o @u.icesi.edu.co)', 'error');
                    setLoading(false);
                    return;
                }

                try {
                    if (isLogin) {
                        const result = await auth.signInWithEmailAndPassword(email, password);
                        toast.showToast('¬°Bienvenido de vuelta!', 'success');
                    } else {
                        const code = generateCode();
                        setGeneratedCode(code);
                        
                        if (userRole === 'student') {
                            if (!courseCode.startsWith('#')) {
                                toast.showToast('Los estudiantes deben ingresar un c√≥digo de curso v√°lido (#codigo)', 'error');
                                setLoading(false);
                                return;
                            }
                        }
                        
                        const pendingData = {
                            email,
                            password,
                            fullName,
                            userType: userRole
                        };
                        
                        if (userRole === 'student') {
                            pendingData.courseCode = courseCode;
                        }
                        
                        setPendingUserData(pendingData);
                        
                        await sendVerificationEmail(email, code, fullName);
                        setShowCodeVerification(true);
                    }
                } catch (err) {
                    console.error('Error en handleAuth:', err);
                    let errorMessage = 'Error de autenticaci√≥n. Por favor, intenta de nuevo.';
                    
                    if (err.code === 'auth/invalid-email') {
                        errorMessage = 'El correo electr√≥nico no tiene un formato v√°lido.';
                    } else if (err.code === 'auth/user-not-found') {
                        errorMessage = 'Usuario no encontrado. Verifica tu correo o crea una cuenta.';
                    } else if (err.code === 'auth/wrong-password') {
                        errorMessage = 'Contrase√±a incorrecta.';
                    } else if (err.code === 'auth/email-already-in-use') {
                        errorMessage = 'Este correo ya est√° registrado.';
                    } else if (err.code === 'auth/weak-password') {
                        errorMessage = 'La contrase√±a es demasiado d√©bil. Debe tener al menos 6 caracteres.';
                    }
                    
                    toast.showToast(errorMessage, 'error');
                } finally {
                    setLoading(false);
                }
            };

            const handleVerifyCode = async (e) => {
                e.preventDefault();
                setLoading(true);

                if (verificationCode !== generatedCode) {
                    toast.showToast('C√≥digo incorrecto', 'error');
                    setLoading(false);
                    return;
                }

                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(
                        pendingUserData.email,
                        pendingUserData.password
                    );
                    const user = userCredential.user;
                    
                    const appId = 'seminario-investigacion-app';
                    const userDocRef = db.doc(`artifacts/${appId}/users/${user.uid}`);
                    
                    const userData = {
                        email: pendingUserData.email,
                        fullName: pendingUserData.fullName,
                        userType: pendingUserData.userType,
                        emailVerified: true,
                        createdAt: new Date()
                    };

                    if (pendingUserData.userType === 'student') {
                        userData.badgesEarned = [];
                        userData.lastBadgeEarned = null;
                        userData.courseCode = pendingUserData.courseCode;
                    }
                    
                    await userDocRef.set(userData);
                    
                    toast.showToast('¬°Cuenta creada exitosamente! Bienvenido.', 'success');
                    
                    setShowCodeVerification(false);
                    setVerificationCode('');
                    setGeneratedCode('');
                    setPendingUserData(null);
                } catch (err) {
                    console.error('Error creando cuenta:', err);
                    let errorMessage = 'Error creando la cuenta';
                    
                    if (err.code === 'auth/email-already-in-use') {
                        errorMessage = 'Este correo ya est√° registrado';
                    } else if (err.code === 'permission-denied') {
                        errorMessage = 'Error de permisos en Firestore. Verifica las reglas de seguridad.';
                    }
                    
                    toast.showToast(errorMessage, 'error');
                } finally {
                    setLoading(false);
                }
            };

            if (showCodeVerification) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4" style={{backgroundColor: 'var(--bg-primary)'}}>
                        <div className="card rounded-2xl p-8 w-full max-w-md animate-fadeIn">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-3xl font-bold" style={{color: 'var(--text-primary)'}}>
                                    Verificar C√≥digo
                                </h2>
                                <ThemeToggle />
                            </div>
                            
                            <div className="text-center mb-6">
                                <p className="text-sm" style={{color: 'var(--text-secondary)'}}>
                                    Ingresa el c√≥digo de 6 d√≠gitos enviado a <strong>{pendingUserData?.email}</strong>
                                </p>
                            </div>
                            
                            <form onSubmit={handleVerifyCode}>
                                <div className="mb-6">
                                    <input
                                        className="input-field w-full py-3 px-4 rounded-lg focus:outline-none text-center text-2xl tracking-widest"
                                        type="text"
                                        placeholder="000000"
                                        value={verificationCode}
                                        onChange={(e) => setVerificationCode(e.target.value.replace(/\D/g, '').slice(0, 6))}
                                        maxLength="6"
                                        required
                                    />
                                </div>
                                
                                <div className="flex flex-col gap-4">
                                    <button
                                        className="btn btn-primary w-full"
                                        type="submit"
                                        disabled={loading || verificationCode.length !== 6}
                                    >
                                        {loading && <Loader2 className="w-5 h-5" />}
                                        Verificar y Crear Cuenta
                                    </button>
                                    
                                    <button
                                        className="btn btn-secondary w-full"
                                        type="button"
                                        onClick={() => {
                                            setShowCodeVerification(false);
                                            setVerificationCode('');
                                            setGeneratedCode('');
                                            setPendingUserData(null);
                                        }}
                                    >
                                        Volver
                                    </button>
                                </div>
                            </form>
                            <div className="text-center mt-4 text-xs" style={{color: 'var(--text-secondary)'}}>
                                Developed by<br/>Leandro Fl√≥rez-Aristiz√°bal, Ph.D
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen flex items-center justify-center p-4" style={{backgroundColor: 'var(--bg-primary)'}}>
                    <div className="card rounded-2xl p-8 w-full max-w-md animate-fadeIn">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-3xl font-bold" style={{color: 'var(--text-primary)'}}>
                                {isLogin ? 'Iniciar Sesi√≥n' : 'Crear Cuenta'}
                            </h2>
                            <ThemeToggle />
                        </div>
                        
                        <form onSubmit={handleAuth}>
                            <div className="mb-4">
                                <label className="block text-sm font-bold mb-2" style={{color: 'var(--text-primary)'}}>
                                    Correo Institucional
                                </label>
                                <input
                                    className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                    type="email"
                                    placeholder="correo@icesi.edu.co o @u.icesi.edu.co"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    required
                                />
                            </div>
                            
                            {!isLogin && (
                                <>
                                    <div className="mb-4">
                                        <label className="block text-sm font-bold mb-2" style={{color: 'var(--text-primary)'}}>
                                            Nombre Completo
                                        </label>
                                        <input
                                            className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                            type="text"
                                            placeholder="Tu Nombre Completo"
                                            value={fullName}
                                            onChange={(e) => setFullName(e.target.value)}
                                            required
                                        />
                                    </div>
                                    
                                    <div className="mb-4">
                                        <label className="block text-sm font-bold mb-2" style={{color: 'var(--text-primary)'}}>
                                            Tipo de Usuario
                                        </label>
                                        <select
                                            className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                            value={userRole}
                                            onChange={(e) => setUserRole(e.target.value)}
                                            required
                                        >
                                            <option value="student">Estudiante</option>
                                            <option value="professor">Profesor</option>
                                        </select>
                                    </div>
                                    
                                    {userRole === 'student' && (
                                        <div className="mb-4">
                                            <label className="block text-sm font-bold mb-2" style={{color: 'var(--text-primary)'}}>
                                                C√≥digo de Curso
                                            </label>
                                            <input
                                                className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                                type="text"
                                                placeholder="#codigo_del_profesor"
                                                value={courseCode}
                                                onChange={(e) => {
                                                    let value = e.target.value;
                                                    if (value && !value.startsWith('#')) {
                                                        value = '#' + value;
                                                    }
                                                    setCourseCode(value);
                                                }}
                                                required
                                            />
                                            <p className="text-xs mt-1" style={{color: 'var(--text-secondary)'}}>
                                                Ingresa el c√≥digo que te proporcion√≥ tu profesor
                                            </p>
                                        </div>
                                    )}
                                </>
                            )}
                            
                            <div className="mb-4">
                                <label className="block text-sm font-bold mb-2" style={{color: 'var(--text-primary)'}}>
                                    Contrase√±a
                                </label>
                                <input
                                    className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                    type="password"
                                    placeholder="M√≠nimo 6 caracteres"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    required
                                />
                            </div>
                            
                            <div className="flex flex-col gap-4 mt-6">
                                <button
                                    className="btn btn-primary w-full"
                                    type="submit"
                                    disabled={loading}
                                >
                                    {loading && <Loader2 className="w-5 h-5" />}
                                    {isLogin ? 'Iniciar Sesi√≥n' : 'Enviar C√≥digo'}
                                </button>
                                
                                <button
                                    className="btn btn-secondary w-full"
                                    type="button"
                                    onClick={() => {
                                        setIsLogin(!isLogin);
                                        setEmail('');
                                        setPassword('');
                                        setFullName('');
                                        setUserRole('student');
                                        setCourseCode('');
                                    }}
                                >
                                    {isLogin ? '¬øNo tienes cuenta? Reg√≠strate' : '¬øYa tienes cuenta? Inicia Sesi√≥n'}
                                </button>
                            </div>
                        </form>
                        <div className="text-center mt-4 text-xs" style={{color: 'var(--text-secondary)'}}>
                            Developed by<br/>Leandro Fl√≥rez-Aristiz√°bal, Ph.D
                        </div>
                    </div>
                </div>
            );
        }

        function AdminDashboard({ currentUser }) {
            const auth = firebase.auth();
            const db = firebase.firestore();
            const toast = useToast();
            const [courses, setCourses] = React.useState([]);
            const [selectedCourse, setSelectedCourse] = React.useState(null);
            const [students, setStudents] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [userData, setUserData] = React.useState(null);
            const [expandedStudent, setExpandedStudent] = React.useState(null);
            const [showCreateCourse, setShowCreateCourse] = React.useState(false);
            const [showEditContent, setShowEditContent] = React.useState(false);
            const [editingWeek, setEditingWeek] = React.useState(null);
            const [newCourse, setNewCourse] = React.useState({
                name: '',
                code: '',
                university: '',
                description: '',
                weeks: 16,
                weeklyContent: []
            });
            const [showContentPreview, setShowContentPreview] = React.useState(false);
            const [previewContent, setPreviewContent] = React.useState(null);
            const [showRanking, setShowRanking] = React.useState(false);
            const [weekContent, setWeekContent] = React.useState({
                title: '',
                description: '',
                content: '',
                activities: [''],
                badges: [{ name: '', description: '' }]
            });



            React.useEffect(() => {
                loadUserData();
                loadCourses();
            }, []);
            
            React.useEffect(() => {
                if (selectedCourse) {
                    loadStudents();
                }
            }, [selectedCourse]);

            const loadUserData = async () => {
                try {
                    const userDoc = await db.doc(`artifacts/seminario-investigacion-app/users/${currentUser.uid}`).get();
                    if (userDoc.exists) {
                        setUserData(userDoc.data());
                    }
                } catch (error) {
                    console.error('Error cargando datos del usuario:', error);
                }
            };

            const loadCourses = async () => {
                try {
                    const coursesQuery = await db.collection('artifacts/seminario-investigacion-app/courses')
                        .where('professorId', '==', currentUser.uid)
                        .get();
                    
                    const coursesData = coursesQuery.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    setCourses(coursesData);
                    if (coursesData.length > 0 && !selectedCourse) {
                        setSelectedCourse(coursesData[0]);
                    }
                } catch (error) {
                    console.error('Error cargando cursos:', error);
                    toast.showToast('Error cargando cursos', 'error');
                } finally {
                    setLoading(false);
                }
            };
            
            const loadStudents = async () => {
                if (!selectedCourse) return;
                
                try {
                    const studentsQuery = await db.collection('artifacts/seminario-investigacion-app/users')
                        .where('userType', '==', 'student')
                        .where('courseCode', '==', selectedCourse.courseCode)
                        .get();
                    
                    const studentsData = studentsQuery.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    setStudents(studentsData);
                } catch (error) {
                    console.error('Error cargando estudiantes:', error);
                    toast.showToast('Error cargando estudiantes', 'error');
                }
            };

            const createCourse = async () => {
                if (!newCourse.name || !newCourse.code || !newCourse.university) {
                    toast.showToast('Nombre, c√≥digo y universidad son requeridos', 'error');
                    return;
                }
                
                try {
                    const courseCode = newCourse.code.startsWith('#') ? newCourse.code : '#' + newCourse.code;
                    
                    const courseData = {
                        name: newCourse.name,
                        courseCode: courseCode,
                        university: newCourse.university,
                        description: newCourse.description,
                        weeks: newCourse.weeks,
                        professorId: currentUser.uid,
                        professorEmail: currentUser.email,
                        professorName: userData?.fullName || currentUser.email,
                        createdAt: new Date(),
                        studentsCount: 0,
                        weeklyContent: [],
                        badges: []
                    };
                    
                    const docRef = await db.collection('artifacts/seminario-investigacion-app/courses').add(courseData);
                    
                    // Crear estructura inicial de semanas
                    const weeklyContent = [];
                    for (let i = 1; i <= newCourse.weeks; i++) {
                        weeklyContent.push({
                            week: i,
                            title: `Semana ${i}`,
                            description: '',
                            content: '',
                            activities: [],
                            badges: []
                        });
                    }
                    
                    await docRef.update({ weeklyContent });
                    
                    toast.showToast('Curso creado exitosamente', 'success');
                    setShowCreateCourse(false);
                    setNewCourse({ name: '', code: '', university: '', description: '', weeks: 16, weeklyContent: [] });
                    loadCourses();
                } catch (error) {
                    console.error('Error creando curso:', error);
                    toast.showToast('Error creando curso', 'error');
                }
            };
            
            const assignBadge = async (studentId, badgeId, earned = true) => {
                try {
                    const studentRef = db.doc(`artifacts/seminario-investigacion-app/users/${studentId}`);
                    const studentDoc = await studentRef.get();
                    
                    if (studentDoc.exists) {
                        const studentData = studentDoc.data();
                        const currentBadges = studentData.badgesEarned || [];
                        const currentBadgeStatus = studentData.badgeStatus || {};
                        
                        if (!currentBadges.includes(badgeId)) {
                            await studentRef.update({
                                badgesEarned: [...currentBadges, badgeId],
                                badgeStatus: {
                                    ...currentBadgeStatus,
                                    [badgeId]: earned ? 'earned' : 'assigned'
                                },
                                lastBadgeEarned: new Date()
                            });
                            
                            toast.showToast(`Badge ${earned ? 'ganado' : 'asignado'} exitosamente`, 'success');
                            loadStudents();
                        } else {
                            toast.showToast('El estudiante ya tiene este badge', 'error');
                        }
                    }
                } catch (error) {
                    console.error('Error asignando badge:', error);
                    if (error.code === 'permission-denied') {
                        toast.showToast('Error de permisos. Aplica las reglas de Firestore del README.', 'error');
                    } else {
                        toast.showToast('Error asignando badge', 'error');
                    }
                }
            };
            
            const [showPasswordModal, setShowPasswordModal] = React.useState(false);
            const [passwordData, setPasswordData] = React.useState({ password: '', showPassword: false, studentId: '', badgeId: '', newStatus: '' });
            const [isUpdatingBadge, setIsUpdatingBadge] = React.useState(false);
            const [showDeleteConfirm, setShowDeleteConfirm] = React.useState(null);
            const [deletePassword, setDeletePassword] = React.useState('');
            const [showDeletePassword, setShowDeletePassword] = React.useState(false);
            
            const changeBadgeStatus = (studentId, badgeId, newStatus) => {
                if (confirm(`¬øEst√°s seguro de cambiar el badge a ${newStatus === 'earned' ? 'ganado' : 'asignado'}?`)) {
                    updateBadgeStatus(studentId, badgeId, newStatus);
                }
            };
            

            
            const updateBadgeStatus = async (studentId, badgeId, newStatus) => {
                try {
                    const studentRef = db.doc(`artifacts/seminario-investigacion-app/users/${studentId}`);
                    const studentDoc = await studentRef.get();
                    
                    if (studentDoc.exists) {
                        const studentData = studentDoc.data();
                        const currentBadgeStatus = studentData.badgeStatus || {};
                        
                        await studentRef.update({
                            badgeStatus: {
                                ...currentBadgeStatus,
                                [badgeId]: newStatus
                            }
                        });
                        
                        toast.showToast(`Badge cambiado a ${newStatus === 'earned' ? 'ganado' : 'asignado'}`, 'success');
                        loadStudents();
                    }
                } catch (error) {
                    console.error('Error actualizando badge:', error);
                    toast.showToast('Error actualizando badge', 'error');
                }
            };
            
            const removeStudent = async (studentId) => {
                if (!confirm('¬øEst√°s seguro de que quieres remover este estudiante del curso?')) {
                    return;
                }
                
                try {
                    await db.doc(`artifacts/seminario-investigacion-app/users/${studentId}`).delete();
                    toast.showToast('Estudiante removido exitosamente', 'success');
                    loadStudents();
                } catch (error) {
                    console.error('Error removiendo estudiante:', error);
                    toast.showToast('Error removiendo estudiante', 'error');
                }
            };
            
            const deleteCourse = async () => {
                if (!deletePassword) return;
                
                try {
                    const credential = firebase.auth.EmailAuthProvider.credential(currentUser.email, deletePassword);
                    await currentUser.reauthenticateWithCredential(credential);
                    
                    await db.doc(`artifacts/seminario-investigacion-app/courses/${showDeleteConfirm}`).delete();
                    
                    toast.showToast('Curso eliminado exitosamente', 'success');
                    setShowDeleteConfirm(null);
                    setDeletePassword('');
                    loadCourses();
                    setSelectedCourse(null);
                } catch (error) {
                    if (error.code === 'auth/wrong-password') {
                        toast.showToast('Contrase√±a incorrecta', 'error');
                    } else {
                        console.error('Error eliminando curso:', error);
                        toast.showToast('Error eliminando curso', 'error');
                    }
                }
            };
            
            const editWeekContent = (weekNumber) => {
                if (weekNumber === 0) {
                    // Editar informaci√≥n general
                    setWeekContent({
                        university: selectedCourse.university || '',
                        courseName: selectedCourse.name || '',
                        courseCode: selectedCourse.courseCode || '',
                        period: selectedCourse.period || '',
                        group: selectedCourse.group || '',
                        programs: selectedCourse.programs || '',
                        intensity: selectedCourse.intensity || '',
                        credits: selectedCourse.credits || '',
                        introduction: selectedCourse.introduction || '',
                        iagAgreements: selectedCourse.iagAgreements || '',
                        availableBadges: selectedCourse.availableBadges || []
                    });
                } else {
                    const week = selectedCourse.weeklyContent?.find(w => w.week === weekNumber) || {
                        title: `Semana ${weekNumber}`,
                        description: '',
                        content: '',
                        activities: [''],
                        badges: [{ name: '', description: '' }]
                    };
                    setWeekContent(week);
                }
                setEditingWeek(weekNumber);
                setShowEditContent(true);
            };
            
            const saveWeekContent = async () => {
                try {
                    const courseRef = db.doc(`artifacts/seminario-investigacion-app/courses/${selectedCourse.id}`);
                    
                    if (editingWeek === 0) {
                        // Guardar informaci√≥n general
                        await courseRef.update({
                            university: weekContent.university,
                            name: weekContent.courseName,
                            courseCode: weekContent.courseCode,
                            period: weekContent.period,
                            group: weekContent.group,
                            programs: weekContent.programs,
                            intensity: weekContent.intensity,
                            credits: weekContent.credits,
                            introduction: weekContent.introduction,
                            iagAgreements: weekContent.iagAgreements,
                            availableBadges: weekContent.availableBadges || []
                        });
                    } else {
                        // Guardar contenido de semana
                        const courseDoc = await courseRef.get();
                        const courseData = courseDoc.data();
                        
                        let weeklyContent = courseData.weeklyContent || [];
                        const weekIndex = weeklyContent.findIndex(w => w.week === editingWeek);
                        
                        const updatedWeek = {
                            ...weekContent,
                            week: editingWeek,
                            activities: weekContent.activities?.filter(a => a.trim()) || [],
                            badges: weekContent.badges?.filter(b => b.name?.trim()) || []
                        };
                        
                        if (weekIndex >= 0) {
                            weeklyContent[weekIndex] = updatedWeek;
                        } else {
                            weeklyContent.push(updatedWeek);
                        }
                        
                        await courseRef.update({ weeklyContent });
                    }
                    
                    toast.showToast('Contenido guardado exitosamente', 'success');
                    setShowEditContent(false);
                    await loadCourses();
                    // Actualizar el curso seleccionado con los nuevos datos
                    const updatedCourseData = await db.doc(`artifacts/seminario-investigacion-app/courses/${selectedCourse.id}`).get();
                    if (updatedCourseData.exists) {
                        setSelectedCourse({id: selectedCourse.id, ...updatedCourseData.data()});
                    }
                } catch (error) {
                    console.error('Error guardando contenido:', error);
                    toast.showToast('Error guardando contenido', 'error');
                }
            };

            const handleLogout = async () => {
                try {
                    await auth.signOut();
                    toast.showToast('¬°Hasta luego!', 'success');
                } catch (err) {
                    toast.showToast("Error al cerrar sesi√≥n. Intenta de nuevo.", 'error');
                }
            };

            if (loading) {
                return <LoadingSpinner />;
            }
            
            if (showDeleteConfirm) {
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div className="card rounded-xl p-6 w-full max-w-md mx-4">
                            <h3 className="text-lg font-bold mb-4">Eliminar Curso</h3>
                            <p className="text-sm mb-4" style={{color: 'var(--text-secondary)'}}>
                                Ingresa tu contrase√±a para confirmar la eliminaci√≥n del curso:
                            </p>
                            <div className="relative mb-4">
                                <input
                                    className="input-field w-full py-3 px-4 pr-12 rounded-lg focus:outline-none"
                                    type={showDeletePassword ? 'text' : 'password'}
                                    placeholder="Contrase√±a"
                                    value={deletePassword}
                                    onChange={(e) => setDeletePassword(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && deleteCourse()}
                                />
                                <button
                                    type="button"
                                    className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                                    onClick={() => setShowDeletePassword(!showDeletePassword)}
                                >
                                    {showDeletePassword ? 'üôà' : 'üëÅÔ∏è'}
                                </button>
                            </div>
                            <div className="flex gap-3">
                                <button
                                    onClick={() => {
                                        setShowDeleteConfirm(null);
                                        setDeletePassword('');
                                    }}
                                    className="btn btn-secondary flex-1"
                                >
                                    Cancelar
                                </button>
                                <button
                                    onClick={deleteCourse}
                                    className="btn btn-primary flex-1 bg-red-500 hover:bg-red-600"
                                    disabled={!deletePassword}
                                >
                                    Eliminar Curso
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }
            
            if (showEditContent) {
                return (
                    <div className="min-h-screen p-4 md:p-8" style={{backgroundColor: 'var(--bg-primary)'}}>
                        <div className="max-w-4xl mx-auto">
                            <div className="card rounded-xl p-6">
                                <h2 className="text-2xl font-bold mb-6">{editingWeek === 0 ? 'Editar Informaci√≥n General' : `Editar Contenido - Semana ${editingWeek}`}</h2>
                                
                                {editingWeek === 0 ? (
                                    <div className="space-y-6">
                                        <div>
                                            <h4 className="font-semibold text-lg mb-4 text-gray-800">Datos del Curso</h4>
                                            <div className="grid md:grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-sm font-bold mb-2">Universidad</label>
                                                    <input
                                                        className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                                        type="text"
                                                        value={weekContent.university || ''}
                                                        onChange={(e) => setWeekContent({...weekContent, university: e.target.value})}
                                                        placeholder="Universidad Icesi"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-bold mb-2">Nombre</label>
                                                    <input
                                                        className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                                        type="text"
                                                        value={weekContent.courseName || ''}
                                                        onChange={(e) => setWeekContent({...weekContent, courseName: e.target.value})}
                                                        placeholder="Seminario de Investigaci√≥n"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-bold mb-2">C√≥digo</label>
                                                    <input
                                                        className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                                        type="text"
                                                        value={weekContent.courseCode || ''}
                                                        onChange={(e) => setWeekContent({...weekContent, courseCode: e.target.value})}
                                                        placeholder="INGE-3032"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-bold mb-2">Periodo</label>
                                                    <input
                                                        className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                                        type="text"
                                                        value={weekContent.period || ''}
                                                        onChange={(e) => setWeekContent({...weekContent, period: e.target.value})}
                                                        placeholder="2024-2"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-bold mb-2">Grupo</label>
                                                    <input
                                                        className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                                        type="text"
                                                        value={weekContent.group || ''}
                                                        onChange={(e) => setWeekContent({...weekContent, group: e.target.value})}
                                                        placeholder="01"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-bold mb-2">Programa/s</label>
                                                    <input
                                                        className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                                        type="text"
                                                        value={weekContent.programs || ''}
                                                        onChange={(e) => setWeekContent({...weekContent, programs: e.target.value})}
                                                        placeholder="Ingenier√≠a de Sistemas"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-bold mb-2">Intensidad Horaria</label>
                                                    <input
                                                        className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                                        type="text"
                                                        value={weekContent.intensity || ''}
                                                        onChange={(e) => setWeekContent({...weekContent, intensity: e.target.value})}
                                                        placeholder="4 horas semanales"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-bold mb-2">Cr√©ditos</label>
                                                    <input
                                                        className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                                        type="text"
                                                        value={weekContent.credits || ''}
                                                        onChange={(e) => setWeekContent({...weekContent, credits: e.target.value})}
                                                        placeholder="3"
                                                    />
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div>
                                            <h4 className="font-semibold text-lg mb-4 text-gray-800">Introducci√≥n</h4>
                                            <textarea
                                                className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                                rows="4"
                                                value={weekContent.introduction || ''}
                                                onChange={(e) => setWeekContent({...weekContent, introduction: e.target.value})}
                                                placeholder="Introducci√≥n del curso..."
                                            />
                                        </div>
                                        
                                        <div>
                                            <h4 className="font-semibold text-lg mb-4 text-gray-800">Acuerdos sobre el Uso de Inteligencia Artificial Generativa (IAG)</h4>
                                            <textarea
                                                className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                                rows="6"
                                                value={weekContent.iagAgreements || ''}
                                                onChange={(e) => setWeekContent({...weekContent, iagAgreements: e.target.value})}
                                                placeholder="Acuerdos sobre el uso de Inteligencia Artificial Generativa..."
                                            />
                                        </div>
                                        
                                        <div>
                                            <h4 className="font-semibold text-lg mb-4 text-gray-800">Badges Disponibles en el Curso</h4>
                                            <div className="space-y-3">
                                                {(weekContent.availableBadges || []).map((badge, index) => (
                                                    <div key={index} className="border rounded p-3 bg-gray-50">
                                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                                            <div>
                                                                <label className="block text-sm font-medium mb-1">Nombre del Badge:</label>
                                                                <input
                                                                    type="text"
                                                                    value={badge.name || ''}
                                                                    onChange={(e) => {
                                                                        const newBadges = [...(weekContent.availableBadges || [])];
                                                                        newBadges[index] = {...badge, name: e.target.value};
                                                                        setWeekContent({...weekContent, availableBadges: newBadges});
                                                                    }}
                                                                    className="input-field w-full p-2 rounded"
                                                                    placeholder="Badge de Iniciaci√≥n"
                                                                />
                                                            </div>
                                                            <div>
                                                                <label className="block text-sm font-medium mb-1">Descripci√≥n:</label>
                                                                <input
                                                                    type="text"
                                                                    value={badge.description || ''}
                                                                    onChange={(e) => {
                                                                        const newBadges = [...(weekContent.availableBadges || [])];
                                                                        newBadges[index] = {...badge, description: e.target.value};
                                                                        setWeekContent({...weekContent, availableBadges: newBadges});
                                                                    }}
                                                                    className="input-field w-full p-2 rounded"
                                                                    placeholder="Descripci√≥n del badge"
                                                                />
                                                            </div>
                                                            <div>
                                                                <label className="block text-sm font-medium mb-1">Semana M√°xima:</label>
                                                                <select
                                                                    value={badge.maxWeek || 1}
                                                                    onChange={(e) => {
                                                                        const newBadges = [...(weekContent.availableBadges || [])];
                                                                        newBadges[index] = {...badge, maxWeek: parseInt(e.target.value)};
                                                                        setWeekContent({...weekContent, availableBadges: newBadges});
                                                                    }}
                                                                    className="input-field w-full p-2 rounded"
                                                                >
                                                                    {Array.from({length: selectedCourse?.weeks || 16}, (_, i) => i + 1).map(week => (
                                                                        <option key={week} value={week}>Semana {week}</option>
                                                                    ))}
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <button
                                                            onClick={() => {
                                                                const newBadges = (weekContent.availableBadges || []).filter((_, i) => i !== index);
                                                                setWeekContent({...weekContent, availableBadges: newBadges});
                                                            }}
                                                            className="mt-2 text-red-600 text-sm hover:text-red-800"
                                                        >
                                                            Eliminar Badge
                                                        </button>
                                                    </div>
                                                ))}
                                                <button
                                                    onClick={() => {
                                                        const newBadges = [...(weekContent.availableBadges || []), {name: '', description: '', maxWeek: 1}];
                                                        setWeekContent({...weekContent, availableBadges: newBadges});
                                                    }}
                                                    className="w-full p-3 border-2 border-dashed border-gray-300 rounded text-gray-600 hover:border-gray-400 hover:text-gray-800"
                                                >
                                                    + Agregar Badge
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-bold mb-2">T√≠tulo</label>
                                            <input
                                                className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                                type="text"
                                                value={weekContent.title || ''}
                                                onChange={(e) => setWeekContent({...weekContent, title: e.target.value})}
                                            />
                                        </div>
                                        
                                        <div>
                                            <label className="block text-sm font-bold mb-2">Descripci√≥n</label>
                                            <input
                                                className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                                type="text"
                                                value={weekContent.description || ''}
                                                onChange={(e) => setWeekContent({...weekContent, description: e.target.value})}
                                            />
                                        </div>
                                        
                                        <div>
                                            <label className="block text-sm font-bold mb-2">Contenido</label>
                                            <textarea
                                                className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                                rows="4"
                                                value={weekContent.content || ''}
                                                onChange={(e) => setWeekContent({...weekContent, content: e.target.value})}
                                            />
                                        </div>
                                        
                                        <div>
                                            <label className="block text-sm font-bold mb-2">Actividades</label>
                                            {(weekContent.activities || ['']).map((activity, index) => (
                                                <div key={index} className="flex gap-2 mb-2">
                                                    <input
                                                        className="input-field flex-1 py-2 px-3 rounded-lg focus:outline-none"
                                                        type="text"
                                                        value={activity}
                                                        onChange={(e) => {
                                                            const newActivities = [...(weekContent.activities || [''])];
                                                            newActivities[index] = e.target.value;
                                                            setWeekContent({...weekContent, activities: newActivities});
                                                        }}
                                                        placeholder="Actividad..."
                                                    />
                                                    <button
                                                        onClick={() => {
                                                            const newActivities = (weekContent.activities || ['']).filter((_, i) => i !== index);
                                                            setWeekContent({...weekContent, activities: newActivities});
                                                        }}
                                                        className="px-3 py-2 bg-red-100 text-red-600 rounded hover:bg-red-200"
                                                    >
                                                        ‚úï
                                                    </button>
                                                </div>
                                            ))}
                                            <button
                                                onClick={() => setWeekContent({...weekContent, activities: [...(weekContent.activities || ['']), '']})}
                                                className="btn btn-secondary text-sm"
                                            >
                                                + Agregar Actividad
                                            </button>
                                        </div>
                                        

                                    </div>
                                )}
                                
                                <div className="flex gap-4 mt-6">
                                    <button
                                        onClick={() => setShowEditContent(false)}
                                        className="btn btn-secondary"
                                    >
                                        Cancelar
                                    </button>
                                    <button
                                        onClick={saveWeekContent}
                                        className="btn btn-primary"
                                    >
                                        Guardar Contenido
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }
            
            if (showCreateCourse) {
                return (
                    <div className="min-h-screen p-4 md:p-8" style={{backgroundColor: 'var(--bg-primary)'}}>
                        <div className="max-w-2xl mx-auto">
                            <div className="card rounded-xl p-6">
                                <h2 className="text-2xl font-bold mb-6">Crear Nuevo Curso</h2>
                                
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Universidad</label>
                                        <input
                                            className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                            type="text"
                                            placeholder="Universidad Icesi"
                                            value={newCourse.university}
                                            onChange={(e) => setNewCourse({...newCourse, university: e.target.value})}
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Nombre del Curso</label>
                                        <input
                                            className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                            type="text"
                                            placeholder="Seminario de Investigaci√≥n"
                                            value={newCourse.name}
                                            onChange={(e) => setNewCourse({...newCourse, name: e.target.value})}
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-bold mb-2">C√≥digo del Curso</label>
                                        <input
                                            className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                            type="text"
                                            placeholder="#SEMINARIO_2024"
                                            value={newCourse.code}
                                            onChange={(e) => {
                                                let value = e.target.value;
                                                if (value && !value.startsWith('#')) {
                                                    value = '#' + value;
                                                }
                                                setNewCourse({...newCourse, code: value});
                                            }}
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Descripci√≥n</label>
                                        <textarea
                                            className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                            rows="3"
                                            placeholder="Descripci√≥n del curso..."
                                            value={newCourse.description}
                                            onChange={(e) => setNewCourse({...newCourse, description: e.target.value})}
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-bold mb-2">N√∫mero de Semanas</label>
                                        <input
                                            className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                            type="number"
                                            min="1"
                                            max="20"
                                            value={newCourse.weeks}
                                            onChange={(e) => setNewCourse({...newCourse, weeks: parseInt(e.target.value)})}
                                        />
                                    </div>
                                </div>
                                
                                <div className="flex gap-4 mt-6">
                                    <button
                                        onClick={() => setShowCreateCourse(false)}
                                        className="btn btn-secondary"
                                    >
                                        Cancelar
                                    </button>
                                    <button
                                        onClick={createCourse}
                                        className="btn btn-primary"
                                    >
                                        Crear Curso
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen p-4 md:p-8" style={{backgroundColor: 'var(--bg-primary)'}}>
                    <header className="card rounded-xl p-6 mb-8 animate-fadeIn">
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div className="flex-1">
                                <h1 className="text-3xl font-bold mb-2">Panel de Administraci√≥n</h1>
                                <p className="text-sm" style={{color: 'var(--text-secondary)'}}>
                                    Profesor: {currentUser.email}
                                </p>
                                {selectedCourse && (
                                    <p className="text-xs" style={{color: 'var(--text-secondary)'}}>
                                        Curso actual: {selectedCourse.name} ({selectedCourse.courseCode})
                                    </p>
                                )}
                            </div>
                            <div className="flex items-center gap-3">
                                <ThemeToggle />
                                <button
                                    onClick={handleLogout}
                                    className="btn btn-secondary flex items-center gap-2"
                                >
                                    <LogOut />
                                    Cerrar Sesi√≥n
                                </button>
                            </div>
                        </div>
                    </header>
                    
                    {/* Pills de cursos */}
                    <div className="card rounded-xl p-6 mb-6">
                        <h2 className="text-xl font-bold mb-4">Mis Cursos</h2>
                        <div className="flex flex-wrap gap-3">
                            {courses.map(course => (
                                <div key={course.id} className="relative group">
                                    <button
                                        onClick={() => setSelectedCourse(course)}
                                        className={`px-4 py-2 rounded-full text-sm font-medium transition-all ${
                                            selectedCourse?.id === course.id 
                                                ? 'bg-blue-500 text-white' 
                                                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                        }`}
                                    >
                                        {course.name}
                                    </button>
                                    {selectedCourse?.id === course.id && (
                                        <button
                                            onClick={() => setShowDeleteConfirm(course.id)}
                                            className="absolute -top-2 -right-2 w-5 h-5 bg-red-500 text-white rounded-full text-xs hover:bg-red-600 flex items-center justify-center"
                                            title="Eliminar curso"
                                        >
                                            √ó
                                        </button>
                                    )}
                                </div>
                            ))}
                            <button
                                onClick={() => setShowCreateCourse(true)}
                                className="px-4 py-2 rounded-full text-sm font-medium bg-green-100 text-green-700 hover:bg-green-200 transition-all"
                            >
                                + Crear Nuevo Curso
                            </button>
                        </div>
                        {courses.length === 0 && (
                            <p className="text-center py-8" style={{color: 'var(--text-secondary)'}}>No tienes cursos creados a√∫n.</p>
                        )}
                    </div>
                    
                    {selectedCourse && (
                        <div className="grid gap-6">
                            {/* Vista de contenido del curso */}
                            <div className="card rounded-xl p-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-xl font-bold">Contenido del Curso</h2>
                                    <button
                                        onClick={() => editWeekContent(0)}
                                        className="btn btn-secondary text-sm"
                                    >
                                        ‚úèÔ∏è Editar Informaci√≥n General
                                    </button>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                                    {Array.from({ length: selectedCourse.weeks }, (_, i) => i + 1).map(weekNum => {
                                        const weekData = selectedCourse.weeklyContent?.find(w => w.week === weekNum);
                                        return (
                                            <div key={weekNum} className="border rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer"
                                                 onClick={() => {
                                                     setPreviewContent({...weekData, week: weekNum, title: weekData?.title || `Semana ${weekNum}`});
                                                     setShowContentPreview(true);
                                                 }}>
                                                <h3 className="font-semibold text-sm mb-2">Semana {weekNum}</h3>
                                                <h4 className="font-medium mb-2 line-clamp-2">{weekData?.title || 'Sin t√≠tulo'}</h4>
                                                <p className="text-xs text-gray-600 mb-3 line-clamp-3">{weekData?.description || 'Sin descripci√≥n'}</p>
                                                <div className="flex justify-between items-center text-xs text-gray-500">
                                                    <span>{weekData?.activities?.length || 0} actividades</span>
                                                    <button
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            editWeekContent(weekNum);
                                                        }}
                                                        className="text-blue-600 hover:text-blue-800 font-medium"
                                                    >
                                                        Editar
                                                    </button>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                            
                            <div className="card rounded-xl p-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-xl font-bold">Estudiantes Registrados ({students.length})</h2>
                                    <div className="flex items-center gap-4">
                                        <button
                                            onClick={() => setShowRanking(!showRanking)}
                                            className="btn btn-secondary text-sm"
                                        >
                                            {showRanking ? 'üë• Vista Normal' : 'üèÜ Ver Ranking'}
                                        </button>
                                        <p className="text-sm" style={{color: 'var(--text-secondary)'}}>
                                            C√≥digo para compartir: <strong>{selectedCourse.courseCode}</strong>
                                        </p>
                                    </div>
                                </div>
                                
                                {students.length === 0 ? (
                                    <p style={{color: 'var(--text-secondary)'}}>No hay estudiantes registrados a√∫n.</p>
                                ) : showRanking ? (
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-sm">
                                            <thead>
                                                <tr className="border-b" style={{borderColor: 'var(--border-color)'}}>
                                                    <th className="text-left p-3 font-semibold">#</th>
                                                    <th className="text-left p-3 font-semibold">Estudiante</th>
                                                    <th className="text-center p-3 font-semibold">Badges Ganados</th>
                                                    <th className="text-center p-3 font-semibold">Badges Asignados</th>
                                                    <th className="text-center p-3 font-semibold">Total</th>
                                                    <th className="text-left p-3 font-semibold">Detalle de Badges</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {students
                                                    .sort((a, b) => {
                                                        const aEarned = (a.badgesEarned || []).filter(badgeId => a.badgeStatus?.[badgeId] === 'earned').length;
                                                        const bEarned = (b.badgesEarned || []).filter(badgeId => b.badgeStatus?.[badgeId] === 'earned').length;
                                                        return bEarned - aEarned;
                                                    })
                                                    .map((student, index) => {
                                                        const earnedBadges = (student.badgesEarned || []).filter(badgeId => student.badgeStatus?.[badgeId] === 'earned');
                                                        const assignedBadges = (student.badgesEarned || []).filter(badgeId => student.badgeStatus?.[badgeId] === 'assigned');
                                                        return (
                                                            <tr key={student.id} className="border-b hover:bg-gray-50" style={{borderColor: 'var(--border-color)'}}>
                                                                <td className="p-3 font-semibold">{index + 1}</td>
                                                                <td className="p-3">
                                                                    <div>
                                                                        <div className="font-medium">{student.fullName}</div>
                                                                        <div className="text-xs" style={{color: 'var(--text-secondary)'}}>{student.email}</div>
                                                                    </div>
                                                                </td>
                                                                <td className="p-3 text-center">
                                                                    <span className="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">
                                                                        üèÜ {earnedBadges.length}
                                                                    </span>
                                                                </td>
                                                                <td className="p-3 text-center">
                                                                    <span className="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-medium">
                                                                        üî¥ {assignedBadges.length}
                                                                    </span>
                                                                </td>
                                                                <td className="p-3 text-center font-semibold">{(student.badgesEarned || []).length}</td>
                                                                <td className="p-3">
                                                                    <div className="flex flex-wrap gap-1">
                                                                        {(selectedCourse.availableBadges || []).map((badge, badgeIndex) => {
                                                                            const badgeId = `${badge.maxWeek}-${badgeIndex}`;
                                                                            const hasEarned = (student.badgesEarned || []).includes(badgeId);
                                                                            const badgeStatus = student.badgeStatus?.[badgeId];
                                                                            if (!hasEarned) return null;
                                                                            return (
                                                                                <span key={badgeId} className={`px-1 py-0.5 text-xs rounded ${
                                                                                    badgeStatus === 'earned' 
                                                                                        ? 'bg-green-100 text-green-800' 
                                                                                        : 'bg-red-100 text-red-800'
                                                                                }`}>
                                                                                    {badgeStatus === 'earned' ? 'üèÜ' : 'üî¥'} {badge.name}
                                                                                </span>
                                                                            );
                                                                        })}
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        );
                                                    })}
                                            </tbody>
                                        </table>
                                    </div>
                                ) : (
                                    <div className="space-y-4">
                                        {students.map(student => {
                                            const isExpanded = expandedStudent === student.id;
                                            return (
                                                <div key={student.id} className="border rounded-lg overflow-hidden" style={{borderColor: 'var(--border-color)'}}>
                                                    <div 
                                                        className="p-4 cursor-pointer hover:bg-gray-50 transition-colors"
                                                        onClick={() => setExpandedStudent(isExpanded ? null : student.id)}
                                                    >
                                                        <div className="flex justify-between items-center">
                                                            <div>
                                                                <h3 className="font-semibold">{student.fullName}</h3>
                                                                <p className="text-sm" style={{color: 'var(--text-secondary)'}}>{student.email}</p>
                                                                <div className="text-sm mt-1" style={{color: 'var(--text-secondary)'}}>
                                                                    Badges: {(student.badgesEarned || []).length}/20
                                                                </div>
                                                            </div>
                                                            <div className="flex items-center gap-2">
                                                                <button
                                                                    onClick={(e) => {
                                                                        e.stopPropagation();
                                                                        removeStudent(student.id);
                                                                    }}
                                                                    className="text-red-500 hover:text-red-700 px-2 py-1 rounded"
                                                                    title="Remover estudiante"
                                                                >
                                                                    üóëÔ∏è
                                                                </button>
                                                                <div className="text-gray-400">
                                                                    {isExpanded ? '‚ñ≤' : '‚ñº'}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    {isExpanded && (
                                                        <div className="px-4 pb-4 border-t" style={{borderColor: 'var(--border-color)'}}>
                                                            <div className="mt-4">
                                                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                                                                    {(selectedCourse.availableBadges || []).sort((a, b) => a.maxWeek - b.maxWeek).map((badge, globalIndex) => {
                                                                        const badgeId = `${badge.maxWeek}-${globalIndex}`;
                                                                        const hasEarned = (student.badgesEarned || []).includes(badgeId);
                                                                        const badgeStatus = student.badgeStatus?.[badgeId];
                                                                        const isEarned = badgeStatus === 'earned';
                                                                        const isAssigned = badgeStatus === 'assigned';
                                                                        
                                                                        return (
                                                                            <div key={badgeId} className="border rounded p-2 flex flex-col">
                                                                                <div className="text-sm font-medium mb-1">{badge.name}</div>
                                                                                <div className="text-xs text-gray-600 mb-1">Semana {badge.maxWeek}</div>
                                                                                <div className="text-xs text-gray-600 mb-2 overflow-hidden" style={{
                                                                                    display: '-webkit-box',
                                                                                    WebkitLineClamp: 2,
                                                                                    WebkitBoxOrient: 'vertical'
                                                                                }}>{badge.description}</div>
                                                                                <div className="mt-auto">
                                                                                    {!hasEarned ? (
                                                                                        <div className="flex gap-1">
                                                                                            <button
                                                                                                onClick={() => assignBadge(student.id, badgeId, true)}
                                                                                                className="flex-1 px-2 py-1 bg-green-100 text-green-800 rounded text-xs hover:bg-green-200"
                                                                                            >
                                                                                                ‚úì Ganado
                                                                                            </button>
                                                                                            <button
                                                                                                onClick={() => assignBadge(student.id, badgeId, false)}
                                                                                                className="flex-1 px-2 py-1 bg-red-100 text-red-800 rounded text-xs hover:bg-red-200"
                                                                                            >
                                                                                                ‚Üí Asignar
                                                                                            </button>
                                                                                        </div>
                                                                                    ) : (
                                                                                        <button
                                                                                            onClick={() => changeBadgeStatus(student.id, badgeId, isEarned ? 'assigned' : 'earned')}
                                                                                            className={`w-full px-2 py-1 rounded text-xs hover:opacity-80 ${
                                                                                                isEarned 
                                                                                                    ? 'bg-green-100 text-green-800' 
                                                                                                    : 'bg-red-100 text-red-800'
                                                                                            }`}
                                                                                            title={`Cambiar a ${isEarned ? 'asignado' : 'ganado'}`}
                                                                                        >
                                                                                            {isEarned ? 'üèÜ Ganado' : 'üî¥ Solo Asignado'}
                                                                                        </button>
                                                                                    )}
                                                                                </div>
                                                                            </div>
                                                                        );
                                                                    })}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                    
                    {/* Modal de Preview de Contenido */}
                    {showContentPreview && previewContent && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-lg max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                                <div className="p-6">
                                    <div className="flex justify-between items-start mb-4">
                                        <h3 className="text-lg font-semibold">Semana {previewContent.week}: {previewContent.title}</h3>
                                        <button
                                            onClick={() => setShowContentPreview(false)}
                                            className="text-gray-500 hover:text-gray-700"
                                        >
                                            ‚úï
                                        </button>
                                    </div>
                                    <div className="space-y-4">
                                        <div>
                                            <h4 className="font-medium mb-2">Descripci√≥n</h4>
                                            <p className="text-gray-600">{previewContent.description || 'Sin descripci√≥n'}</p>
                                        </div>
                                        <div>
                                            <h4 className="font-medium mb-2">Contenido</h4>
                                            <div className="prose max-w-none text-gray-600">{previewContent.content || 'Sin contenido'}</div>
                                        </div>
                                        {previewContent.activities && previewContent.activities.length > 0 && (
                                            <div>
                                                <h4 className="font-medium mb-2">Actividades ({previewContent.activities.length})</h4>
                                                <ul className="list-disc list-inside space-y-1">
                                                    {previewContent.activities.map((activity, idx) => (
                                                        <li key={idx} className="text-gray-600">{activity}</li>
                                                    ))}
                                                </ul>
                                            </div>
                                        )}
                                    </div>
                                    <div className="flex justify-end gap-2 mt-6">
                                        <button
                                            onClick={() => {
                                                setShowContentPreview(false);
                                                editWeekContent(previewContent.week);
                                            }}
                                            className="btn btn-primary"
                                        >
                                            Editar
                                        </button>
                                        <button
                                            onClick={() => setShowContentPreview(false)}
                                            className="btn btn-secondary"
                                        >
                                            Cerrar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    <footer className="mt-8 text-center text-xs" style={{color: 'var(--text-secondary)'}}>
                        Developed by<br/>Leandro Fl√≥rez-Aristiz√°bal, Ph.D
                    </footer>
                </div>
            );
        }

        function CoursePage({ currentUser }) {
            const auth = firebase.auth();
            const db = firebase.firestore();
            const toast = useToast();
            const { theme } = useTheme();
            const isDarkMode = theme === 'dark';
            const [userData, setUserData] = React.useState(null);
            const [loading, setLoading] = React.useState(true);
            const [expandedWeek, setExpandedWeek] = React.useState(null);
            const [professorName, setProfessorName] = React.useState('');
            const [dynamicContent, setDynamicContent] = React.useState([]);
            const [courseInfo, setCourseInfo] = React.useState(null);



            React.useEffect(() => {
                loadUserData();
                loadCourseData();
            }, []);

            const loadUserData = async () => {
                try {
                    const userDoc = await db.doc(`artifacts/seminario-investigacion-app/users/${currentUser.uid}`).get();
                    if (userDoc.exists) {
                        setUserData(userDoc.data());
                    }
                } catch (error) {
                    console.error('Error cargando datos del usuario:', error);
                } finally {
                    setLoading(false);
                }
            };
            
            const loadCourseData = async () => {
                try {
                    const userDoc = await db.doc(`artifacts/seminario-investigacion-app/users/${currentUser.uid}`).get();
                    if (userDoc.exists) {
                        const studentData = userDoc.data();
                        const courseCode = studentData.courseCode;
                        
                        if (courseCode) {
                            const coursesQuery = await db.collection('artifacts/seminario-investigacion-app/courses')
                                .where('courseCode', '==', courseCode)
                                .limit(1)
                                .get();
                            
                            if (!coursesQuery.empty) {
                                const courseData = coursesQuery.docs[0].data();
                                setProfessorName(courseData.professorName || 'No asignado');
                                setCourseInfo(courseData);
                                
                                // Crear contenido din√°mico
                                const contentArray = [];
                                
                                // Informaci√≥n general
                                contentArray.push({
                                    id: 'info',
                                    type: 'info',
                                    title: 'Informaci√≥n General del Curso',
                                    description: 'Datos del curso y badges disponibles',
                                    unlocked: true
                                });
                                
                                // Semanas din√°micas
                                for (let i = 1; i <= courseData.weeks; i++) {
                                    const weekData = courseData.weeklyContent?.find(w => w.week === i);
                                    // Asignar badges a esta semana seg√∫n la configuraci√≥n del profesor
                                    const weekBadges = courseData.availableBadges?.filter(badge => badge.maxWeek === i) || [];
                                    contentArray.push({
                                        id: i,
                                        week: i,
                                        title: weekData?.title || `Semana ${i}`,
                                        description: weekData?.description || 'Contenido por definir',
                                        content: weekData?.content || '',
                                        activities: weekData?.activities || [],
                                        badges: weekBadges,
                                        unlocked: i === 1 // Solo la primera semana desbloqueada por defecto
                                    });
                                }
                                
                                setDynamicContent(contentArray);
                            } else {
                                setProfessorName('Curso no encontrado');
                            }
                        } else {
                            setProfessorName('Sin asignar');
                        }
                    }
                } catch (error) {
                    console.error('Error cargando datos del curso:', error);
                    setProfessorName('Error cargando');
                }
            };

            const handleLogout = async () => {
                try {
                    await auth.signOut();
                    toast.showToast('¬°Hasta luego!', 'success');
                } catch (err) {
                    toast.showToast("Error al cerrar sesi√≥n. Intenta de nuevo.", 'error');
                }
            };

            const getBadgeStatus = (badgeId) => {
                if (!userData || !userData.badgesEarned) return false;
                return userData.badgesEarned.includes(badgeId);
            };
            
            const getBadgeStatusType = (badgeId) => {
                if (!userData || !userData.badgeStatus) return null;
                return userData.badgeStatus[badgeId] || null;
            };

            const getProgressPercentage = () => {
                if (!userData || !userData.badgesEarned) return 0;
                return Math.round((userData.badgesEarned.length / 20) * 100);
            };

            const isContentUnlocked = (content) => {
                if (content.unlocked) return true;
                // Cada semana se desbloquea si todas las semanas anteriores tienen todos sus badges ganados
                if (content.week && content.week > 1) {
                    for (let week = 1; week < content.week; week++) {
                        const weekBadges = dynamicContent.find(c => c.week === week)?.badges || [];
                        if (weekBadges.length === 0) continue; // Si no hay badges, continuar
                        const hasAllBadges = weekBadges.every((badge, index) => {
                            // Encontrar el √≠ndice global del badge en availableBadges
                            const globalIndex = courseInfo?.availableBadges?.findIndex(b => b.name === badge.name && b.maxWeek === week) ?? index;
                            const badgeId = `${week}-${globalIndex}`;
                            return getBadgeStatus(badgeId);
                        });
                        if (!hasAllBadges) {
                            return false; // Si no tiene todos los badges de alguna semana anterior, bloquear
                        }
                    }
                    return true;
                }
                return true;
            };

            if (loading) {
                return <LoadingSpinner />;
            }

            return (
                <div className="min-h-screen p-4 md:p-8" style={{backgroundColor: 'var(--bg-primary)'}}>
                    <header className="card rounded-xl p-6 mb-8 animate-fadeIn">
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div className="flex-1">
                                <h1 className="text-3xl font-bold mb-2" style={{color: 'var(--text-primary)'}}>
                                    {courseInfo?.name || 'Cargando...'}
                                </h1>
                                <div className="flex items-center gap-2 text-sm" style={{color: 'var(--text-secondary)'}}>
                                    <User />
                                    <span>Hola, <strong>{userData?.fullName || currentUser.email.split('@')[0]}</strong></span>
                                </div>
                                <div className="mt-2">
                                    <div className="flex items-center gap-2 text-sm" style={{color: 'var(--text-secondary)'}}>
                                        <span>Progreso: {getProgressPercentage()}% ({userData?.badgesEarned?.length || 0}/20 badges)</span>
                                    </div>
                                    <div className="w-full bg-gray-200 rounded-full h-2 mt-1">
                                        <div 
                                            className="h-2 rounded-full transition-all duration-300" 
                                            style={{
                                                width: `${getProgressPercentage()}%`,
                                                background: 'linear-gradient(90deg, #ef4444 0%, #f97316 25%, #eab308 50%, #22c55e 75%, #3b82f6 100%)'
                                            }}
                                        ></div>
                                    </div>
                                </div>
                            </div>
                            <div className="flex items-center gap-3">
                                <ThemeToggle />
                                <button
                                    onClick={handleLogout}
                                    className="btn btn-secondary flex items-center gap-2"
                                    title="Cerrar sesi√≥n"
                                >
                                    <LogOut />
                                    <span className="hidden md:inline">Cerrar Sesi√≥n</span>
                                </button>
                            </div>
                        </div>
                    </header>

                    <main className="container mx-auto max-w-6xl">
                        <div className="grid gap-6">
                            {dynamicContent.map((content) => {
                                const unlocked = isContentUnlocked(content);
                                const isExpanded = expandedWeek === content.id;
                                
                                return (
                                    <div key={content.id} className={`card rounded-xl overflow-hidden ${
                                        !unlocked ? 'opacity-50' : ''
                                    } ${content.type === 'info' ? 'bg-slate-100' : ''}`} style={content.type === 'info' ? {borderColor: 'var(--accent-color)'} : {}}>
                                        <div 
                                            className={`p-6 transition-colors ${
                                                unlocked ? 'cursor-pointer' : 'cursor-not-allowed'
                                            }`}
                                            onClick={() => unlocked && setExpandedWeek(isExpanded ? null : content.id)}
                                        >
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center gap-4">
                                                    <div className={`w-12 h-12 min-w-12 rounded-full flex items-center justify-center text-white font-bold ${
                                                        unlocked ? 'bg-blue-500' : 'bg-gray-400'
                                                    }`}>
                                                        {unlocked ? (content.type === 'info' ? 'üìö' : (content.week || (content.weeks === '2-5' ? '2' : content.weeks))) : 'üîí'}
                                                    </div>
                                                    <div>
                                                        <h3 className="text-lg font-semibold">
                                                            {content.type === 'info' ? content.title : (content.week ? `Semana ${content.week}: ${content.title}` : `Semanas ${content.weeks}: ${content.title}`)}
                                                        </h3>
                                                        <p className="text-sm" style={{color: 'var(--text-secondary)'}}>
                                                            {content.description}
                                                        </p>
                                                        {!unlocked && (
                                                            <span className="inline-block mt-1 px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">
                                                                Bloqueado - Completa badge anterior
                                                            </span>
                                                        )}
                                                        {unlocked && content.badges && content.badges.length > 0 && (
                                                            <div className="mt-2 flex flex-wrap gap-1">
                                                                {content.badges.map((badge, index) => {
                                                                    // Encontrar el √≠ndice global del badge en availableBadges
                                                                    const globalIndex = courseInfo?.availableBadges?.findIndex(b => b.name === badge.name && b.maxWeek === content.week) ?? index;
                                                                    const badgeId = `${content.week}-${globalIndex}`;
                                                                    const badgeEarned = getBadgeStatus(badgeId);
                                                                    const badgeStatusType = getBadgeStatusType(badgeId);
                                                                    return (
                                                                        <span key={index} className={`px-2 py-1 text-xs rounded-full ${
                                                                            badgeEarned 
                                                                                ? (badgeStatusType === 'earned' 
                                                                                    ? 'bg-green-100 text-green-800' 
                                                                                    : 'bg-red-100 text-red-800')
                                                                                : 'bg-gray-100 text-gray-600'
                                                                        }`}>
                                                                            {badgeEarned 
                                                                                ? (badgeStatusType === 'earned' ? 'üèÜ' : 'üî¥')
                                                                                : '‚óã'} {badge.name}
                                                                        </span>
                                                                    );
                                                                })}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                                <div className="text-gray-400">
                                                    {unlocked ? (isExpanded ? '‚ñ≤' : '‚ñº') : ''}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {isExpanded && unlocked && (
                                            <div className="px-6 pb-6 border-t" style={{borderColor: 'var(--border-color)'}}>
                                                <div className="mt-4">
                                                    {content.type === 'info' ? (
                                                        <div>
                                                            <div className="grid md:grid-cols-2 gap-6 mb-6">
                                                                <div>
                                                                    <h3 className="font-semibold mb-2 text-gray-800">Datos del Curso</h3>
                                                                    <ul className="space-y-1 text-sm text-gray-600">
                                                                        <li><strong>Universidad:</strong> {courseInfo?.university || 'Por definir'}</li>
                                                                        <li><strong>Nombre:</strong> {courseInfo?.courseName || courseInfo?.name || 'Por definir'}</li>
                                                                        <li><strong>C√≥digo:</strong> {courseInfo?.courseCode || 'Por definir'}</li>
                                                                        <li><strong>Periodo:</strong> {courseInfo?.period || 'Por definir'}</li>
                                                                        <li><strong>Grupo:</strong> {courseInfo?.group || 'Por definir'}</li>
                                                                        <li><strong>Programa/s:</strong> {courseInfo?.programs || 'Por definir'}</li>
                                                                        <li><strong>Intensidad Horaria:</strong> {courseInfo?.intensity || 'Por definir'}</li>
                                                                        <li><strong>Cr√©ditos:</strong> {courseInfo?.credits || 'Por definir'}</li>
                                                                        <li><strong>Docente:</strong> {professorName || 'Cargando...'}</li>
                                                                    </ul>
                                                                </div>
                                                                <div>
                                                                    <h3 className="font-semibold mb-2 text-gray-800">Introducci√≥n</h3>
                                                                    <p className="text-sm text-gray-600">
                                                                        {courseInfo?.introduction || 'Por definir'}
                                                                    </p>
                                                                </div>
                                                            </div>
                                                            
                                                            <div className="mb-6">
                                                                <h3 className="font-semibold mb-2 text-gray-800">Acuerdos sobre el Uso de Inteligencia Artificial Generativa (IAG)</h3>
                                                                <p className="text-sm text-gray-600">
                                                                    {courseInfo?.iagAgreements || 'Por definir'}
                                                                </p>
                                                            </div>
                                                            
                                                            <div>
                                                                <h3 className="font-semibold mb-3 text-gray-800">üèÜ Badges Disponibles en el Curso</h3>
                                                                {courseInfo?.availableBadges && courseInfo.availableBadges.length > 0 ? (
                                                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 text-xs">
                                                                        {courseInfo.availableBadges.map((badge, index) => (
                                                                            <div key={index} className="p-2 bg-white rounded border">
                                                                                <div className="font-bold text-green-600">{badge.name}</div>
                                                                                <div className="text-gray-600">{badge.description}</div>
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                ) : (
                                                                    <div className="p-4 bg-gray-50 rounded border text-center text-gray-600">
                                                                        <p>El profesor a√∫n no ha configurado los badges para este curso.</p>
                                                                        <p className="text-xs mt-1">Los badges aparecer√°n aqu√≠ una vez que sean definidos.</p>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    ) : (
                                                        <div>
                                                            {content.content && (
                                                                <div>
                                                                    <h4 className="font-semibold mb-2">Contenido:</h4>
                                                                    <p className="mb-4" style={{color: 'var(--text-secondary)'}}>
                                                                        {content.content}
                                                                    </p>
                                                                </div>
                                                            )}
                                                            
                                                            {content.activities && content.activities.length > 0 && (
                                                                <div>
                                                                    <h4 className="font-semibold mb-2">Actividades:</h4>
                                                                    <ul className="space-y-1 mb-6">
                                                                        {content.activities.map((activity, index) => (
                                                                            <li key={index} className="flex items-start gap-2">
                                                                                <span className="text-blue-500 mt-1">‚Ä¢</span>
                                                                                <span style={{color: 'var(--text-secondary)'}}>{activity}</span>
                                                                            </li>
                                                                        ))}
                                                                    </ul>
                                                                </div>
                                                            )}
                                                            
                                                            {content.badges && content.badges.length > 0 && (
                                                                <div>
                                                                    <h4 className="font-semibold mb-2">üèÜ Badges de esta Semana:</h4>
                                                                    <div className="grid gap-2">
                                                                        {content.badges.map((badge, index) => (
                                                                            <div key={index} className="p-2 bg-gray-50 rounded border">
                                                                                <div className="font-medium text-sm">{badge.name}</div>
                                                                                <div className="text-xs text-gray-600">{badge.description}</div>
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    )}
                                                    
                                                    {content.weeks === "2-5" && (
                                                        <div className="mt-6">
                                                            <h4 className="font-semibold mb-3">üìã R√∫brica de Evaluaci√≥n</h4>
                                                            <div className="overflow-x-auto">
                                                                <table className="w-full text-sm border-collapse border" style={{borderColor: 'var(--border-color)'}}>
                                                                    <thead>
                                                                        <tr className="bg-gray-50">
                                                                            <th className="border p-2 text-left font-semibold text-gray-800" style={{borderColor: 'var(--border-color)'}}></th>
                                                                            <th className="border p-2 text-center font-semibold bg-green-100 text-gray-800" style={{borderColor: 'var(--border-color)'}}>Excelente</th>
                                                                            <th className="border p-2 text-center font-semibold bg-yellow-100 text-gray-800" style={{borderColor: 'var(--border-color)'}}>Bueno</th>
                                                                            <th className="border p-2 text-center font-semibold bg-orange-100 text-gray-800" style={{borderColor: 'var(--border-color)'}}>Regular</th>
                                                                            <th className="border p-2 text-center font-semibold bg-red-100 text-gray-800" style={{borderColor: 'var(--border-color)'}}>Necesita Mejorar</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                        <tr>
                                                                            <td className="border p-2 font-semibold bg-gray-50 text-gray-800" style={{borderColor: 'var(--border-color)'}}>Creatividad</td>
                                                                            <td className="border p-2 text-xs bg-green-50 text-gray-800" style={{borderColor: 'var(--border-color)'}}>Presenta el contenido de manera altamente innovadora y original. Utiliza recursos visuales y/o interactivos √∫nicos que captan la atenci√≥n. Demuestra un pensamiento fuera de lo convencional.</td>
                                                                            <td className="border p-2 text-xs bg-yellow-50 text-gray-800" style={{borderColor: 'var(--border-color)'}}>Demuestra creatividad en la presentaci√≥n del contenido. Utiliza algunos recursos originales. Las ideas se presentan de forma interesante.</td>
                                                                            <td className="border p-2 text-xs bg-orange-50 text-gray-800" style={{borderColor: 'var(--border-color)'}}>La presentaci√≥n es convencional pero correcta. Utiliza recursos comunes. Hay algunos intentos de originalidad.</td>
                                                                            <td className="border p-2 text-xs bg-red-50 text-gray-800" style={{borderColor: 'var(--border-color)'}}>La presentaci√≥n carece de elementos creativos. Utiliza m√©todos muy b√°sicos o repetitivos. No hay originalidad en el enfoque.</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <td className="border p-2 font-semibold bg-gray-50 text-gray-800" style={{borderColor: 'var(--border-color)'}}>Claridad</td>
                                                                            <td className="border p-2 text-xs bg-green-50 text-gray-800" style={{borderColor: 'var(--border-color)'}}>La exposici√≥n es extraordinariamente clara y bien estructurada. Las ideas fluyen de manera l√≥gica y coherente. El lenguaje es preciso y adecuado. La informaci√≥n se transmite de forma efectiva.</td>
                                                                            <td className="border p-2 text-xs bg-yellow-50 text-gray-800" style={{borderColor: 'var(--border-color)'}}>La exposici√≥n es clara y comprensible. La mayor√≠a de las ideas est√°n bien organizadas. El lenguaje es apropiado aunque con algunas imprecisiones.</td>
                                                                            <td className="border p-2 text-xs bg-orange-50 text-gray-800" style={{borderColor: 'var(--border-color)'}}>La exposici√≥n es algo confusa en ciertos puntos. Algunas ideas no est√°n bien conectadas. El lenguaje puede ser impreciso o inadecuado ocasionalmente.</td>
                                                                            <td className="border p-2 text-xs bg-red-50 text-gray-800" style={{borderColor: 'var(--border-color)'}}>La exposici√≥n es dif√≠cil de seguir. Las ideas est√°n desorganizadas. El lenguaje es confuso o inapropiado frecuentemente.</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <td className="border p-2 font-semibold bg-gray-50 text-gray-800" style={{borderColor: 'var(--border-color)'}}>Conclusiones</td>
                                                                            <td className="border p-2 text-xs bg-green-50 text-gray-800" style={{borderColor: 'var(--border-color)'}}>Las conclusiones son profundas y bien fundamentadas. Formula preguntas originales y estimulantes que generan discusi√≥n significativa. Demuestra una comprensi√≥n excepcional del tema.</td>
                                                                            <td className="border p-2 text-xs bg-yellow-50 text-gray-800" style={{borderColor: 'var(--border-color)'}}>Las conclusiones son v√°lidas y est√°n bien presentadas. Las preguntas son relevantes y promueven cierta discusi√≥n. Demuestra buena comprensi√≥n del tema.</td>
                                                                            <td className="border p-2 text-xs bg-orange-50 text-gray-800" style={{borderColor: 'var(--border-color)'}}>Las conclusiones son b√°sicas o superficiales. Las preguntas son simples o poco elaboradas. Demuestra comprensi√≥n parcial del tema.</td>
                                                                            <td className="border p-2 text-xs bg-red-50 text-gray-800" style={{borderColor: 'var(--border-color)'}}>Las conclusiones son d√©biles o ausentes. Las preguntas son irrelevantes o no se formulan. Demuestra poca comprensi√≥n del tema.</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <td className="border p-2 font-semibold bg-gray-50 text-gray-800" style={{borderColor: 'var(--border-color)'}}>Preguntas</td>
                                                                            <td className="border p-2 text-xs bg-green-50 text-gray-800" style={{borderColor: 'var(--border-color)'}}>Participa activamente en todas las exposiciones. Hace comentarios constructivos y preguntas relevantes. Demuestra inter√©s genuino y respeto por el trabajo de otros.</td>
                                                                            <td className="border p-2 text-xs bg-yellow-50 text-gray-800" style={{borderColor: 'var(--border-color)'}}>Participa regularmente en las exposiciones. Hace algunos comentarios y preguntas √∫tiles. Muestra inter√©s por el trabajo de otros.</td>
                                                                            <td className="border p-2 text-xs bg-orange-50 text-gray-800" style={{borderColor: 'var(--border-color)'}}>Participa ocasionalmente en las exposiciones. Los comentarios son limitados o poco elaborados. Muestra inter√©s intermitente.</td>
                                                                            <td className="border p-2 text-xs bg-red-50 text-gray-800" style={{borderColor: 'var(--border-color)'}}>Raramente participa en las exposiciones. No hace comentarios ni preguntas. Muestra poco inter√©s por el trabajo de otros.</td>
                                                                        </tr>
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </main>
                    <footer className="mt-8 text-center text-xs" style={{color: 'var(--text-secondary)'}}>
                        Developed by<br/>Leandro Fl√≥rez-Aristiz√°bal, Ph.D
                    </footer>
                </div>
            );
        }

        function AppContent() {
            const [currentUser, setCurrentUser] = React.useState(null);
            const [userData, setUserData] = React.useState(null);
            const [authReady, setAuthReady] = React.useState(false);
            const toast = useToast();

            const firebaseConfig = {
                apiKey: "AIzaSyBEKzy25wj-qIVJcyqkCors2b8zPostu7E",
                authDomain: "seminario-de-investigaci-283c8.firebaseapp.com",
                projectId: "seminario-de-investigaci-283c8",
                storageBucket: "seminario-de-investigaci-283c8.firebasestorage.app",
                messagingSenderId: "253114435967",
                appId: "1:253114435967:web:b83b9413f663f283b7724a",
                measurementId: "G-7J76P5D7Z3"
            };

            React.useEffect(() => {
                firebase.initializeApp(firebaseConfig);
                const auth = firebase.auth();
                
                const unsubscribe = auth.onAuthStateChanged(async (user) => {
                    setCurrentUser(user);
                    
                    if (user) {
                        try {
                            const db = firebase.firestore();
                            const userDoc = await db.doc(`artifacts/seminario-investigacion-app/users/${user.uid}`).get();
                            if (userDoc.exists) {
                                setUserData(userDoc.data());
                            }
                        } catch (error) {
                            console.error('Error cargando datos del usuario:', error);
                        }
                    } else {
                        setUserData(null);
                    }
                    
                    setAuthReady(true);
                });
                
                return () => unsubscribe();
            }, []);

            if (!authReady) {
                return <LoadingSpinner />;
            }

            return (
                <>
                    {currentUser ? (
                        userData?.userType === 'professor' ? (
                            <AdminDashboard currentUser={currentUser} />
                        ) : (
                            <CoursePage currentUser={currentUser} />
                        )
                    ) : (
                        <AuthPage />
                    )}
                </>
            );
        }
        
        function App() {
            return (
                <ToastProvider>
                    <AppContent />
                </ToastProvider>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>