<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seminario de Investigaci√≥n</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f9fafb;
            --bg-secondary: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --accent-color: #4D96FF;
            --success-color: #10b981;
            --error-color: #ef4444;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        [data-theme="dark"] {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --border-color: #374151;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3), 0 1px 2px 0 rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .spinner {
            border: 4px solid rgba(77, 150, 255, 0.2);
            border-left-color: var(--accent-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
            }

            to {
                opacity: 1;
                max-height: 1000px;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-slideDown {
            animation: slideDown 0.3s ease-out;
        }

        .animate-fadeIn {
            animation: fadeIn 0.5s ease-out;
        }

        .card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .input-field {
            background-color: var(--bg-secondary);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        .input-field:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(77, 150, 255, 0.1);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-color), #3b82f6);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        .theme-toggle {
            background-color: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 9999px;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .theme-toggle:hover {
            border-color: var(--accent-color);
        }

        .toast {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 600;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .toast-success {
            background-color: var(--success-color);
        }

        .toast-error {
            background-color: var(--error-color);
        }

        .toast-info {
            background-color: var(--accent-color);
        }

        .fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-color), #3b82f6);
            color: white;
            border: none;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s ease;
            z-index: 100;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(77, 150, 255, 0.4);
        }

        #qr-reader {
            border-radius: 0.75rem;
            overflow: hidden;
        }

        #qr-reader video {
            width: 100% !important;
            height: auto !important;
            object-fit: cover;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const ToastContext = React.createContext();

        function ToastProvider({ children }) {
            const [toasts, setToasts] = React.useState([]);

            const showToast = (message, type = 'success') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
                setTimeout(() => {
                    setToasts(prev => prev.filter(toast => toast.id !== id));
                }, 3000);
            };

            return React.createElement(ToastContext.Provider, { value: { showToast } }, [
                children,
                React.createElement('div', { key: 'toasts' },
                    toasts.map(toast =>
                        React.createElement('div', {
                            key: toast.id,
                            className: `toast toast-${toast.type}`
                        }, toast.message)
                    )
                )
            ]);
        }

        const useToast = () => React.useContext(ToastContext);

        function useTheme() {
            const [theme, setTheme] = React.useState(() =>
                localStorage.getItem('theme') || 'light'
            );

            React.useEffect(() => {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
            }, [theme]);

            const toggleTheme = () => {
                setTheme(prev => prev === 'light' ? 'dark' : 'light');
            };

            return { theme, toggleTheme };
        }

        function ThemeToggle() {
            const { theme, toggleTheme } = useTheme();
            return React.createElement('button', {
                className: 'theme-toggle',
                onClick: toggleTheme,
                title: `Cambiar a tema ${theme === 'light' ? 'oscuro' : 'claro'}`
            }, theme === 'light' ? 'üåô' : '‚òÄÔ∏è');
        }

        const User = ({ className = '' }) => React.createElement('span', { className }, 'üë§');
        const LogOut = ({ className = '' }) => React.createElement('span', { className }, '‚èª');
        const Loader2 = ({ className = '' }) => React.createElement('div', { className: `spinner ${className}` });

        const LoadingSpinner = () => (
            <div className="flex justify-center items-center py-8 animate-fadeIn">
                <div className="spinner"></div>
                <p className="ml-3" style={{ color: 'var(--text-secondary)' }}>Cargando...</p>
            </div>
        );

        function AuthPage() {
            const toast = useToast();
            const auth = firebase.auth();
            const db = firebase.firestore();
            const [isLogin, setIsLogin] = React.useState(true);
            const [email, setEmail] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [fullName, setFullName] = React.useState('');
            const [loading, setLoading] = React.useState(false);
            const [showCodeVerification, setShowCodeVerification] = React.useState(false);
            const [verificationCode, setVerificationCode] = React.useState('');
            const [generatedCode, setGeneratedCode] = React.useState('');
            const [pendingUserData, setPendingUserData] = React.useState(null);
            const [userRole, setUserRole] = React.useState('student');
            const [courseCode, setCourseCode] = React.useState('');
            const [showPasswordReset, setShowPasswordReset] = React.useState(false);
            const [newPassword, setNewPassword] = React.useState('');
            const [showPassword, setShowPassword] = React.useState(false);

            const validateEmail = (email) => {
                const validDomains = /^[a-zA-Z0-9._%+-]+@(icesi\.edu\.co|u\.icesi\.edu\.co|estudiante\.uniajc\.edu\.co|profesores\.uniajc\.edu\.co)$/;
                return validDomains.test(email);
            };

            const generateCode = () => Math.floor(100000 + Math.random() * 900000).toString();

            const sendVerificationEmail = async (email, code, fullName) => {
                try {
                    emailjs.init('145MnHTSSDkBVKZAU');

                    const templateParams = {
                        to_name: fullName || email.split('@')[0],
                        to_email: email,
                        verification_code: code,
                        from_name: 'Seminario de Investigaci√≥n'
                    };

                    const result = await emailjs.send(
                        'service_7u1zcni',
                        'template_1129sv3',
                        templateParams
                    );

                    toast.showToast('C√≥digo enviado a tu correo', 'success');
                } catch (error) {
                    console.error('Error enviando email:', error);
                    console.log(`C√≥digo de verificaci√≥n para ${email}: ${code}`);
                    toast.showToast(`Error enviando email. C√≥digo (desarrollo): ${code}`, 'info');
                }
            };

            const handleAuth = async (e) => {
                e.preventDefault();
                setLoading(true);

                if (!validateEmail(email)) {
                    toast.showToast('Usa tu correo institucional (@icesi.edu.co, @u.icesi.edu.co, @estudiante.uniajc.edu.co o @profesores.uniajc.edu.co)', 'error');
                    setLoading(false);
                    return;
                }

                try {
                    if (isLogin) {
                        const result = await auth.signInWithEmailAndPassword(email, password);
                        toast.showToast('¬°Bienvenido de vuelta!', 'success');
                    } else {
                        const code = generateCode();
                        setGeneratedCode(code);

                        if (userRole === 'student') {
                            if (!courseCode.startsWith('#')) {
                                toast.showToast('Los estudiantes deben ingresar un c√≥digo de curso v√°lido (#codigo)', 'error');
                                setLoading(false);
                                return;
                            }
                        }

                        const pendingData = {
                            email,
                            password,
                            fullName,
                            userType: userRole
                        };

                        if (userRole === 'student') {
                            pendingData.courseCode = courseCode;
                        }

                        setPendingUserData(pendingData);

                        await sendVerificationEmail(email, code, fullName);
                        setShowCodeVerification(true);
                    }
                } catch (err) {
                    console.error('Error en handleAuth:', err);
                    let errorMessage = 'Error de autenticaci√≥n. Por favor, intenta de nuevo.';

                    if (err.code === 'auth/invalid-email') {
                        errorMessage = 'El correo electr√≥nico no tiene un formato v√°lido.';
                    } else if (err.code === 'auth/user-not-found') {
                        errorMessage = 'Usuario no encontrado. Verifica tu correo o crea una cuenta.';
                    } else if (err.code === 'auth/wrong-password') {
                        errorMessage = 'Contrase√±a incorrecta.';
                    } else if (err.code === 'auth/email-already-in-use') {
                        errorMessage = 'Este correo ya est√° registrado.';
                    } else if (err.code === 'auth/weak-password') {
                        errorMessage = 'La contrase√±a es demasiado d√©bil. Debe tener al menos 6 caracteres.';
                    }

                    toast.showToast(errorMessage, 'error');
                } finally {
                    setLoading(false);
                }
            };

            const handlePasswordReset = async (e) => {
                e.preventDefault();
                setLoading(true);

                if (!validateEmail(email)) {
                    toast.showToast('Ingresa tu correo institucional', 'error');
                    setLoading(false);
                    return;
                }

                try {
                    const code = generateCode();
                    setGeneratedCode(code);

                    await sendVerificationEmail(email, code, email.split('@')[0]);
                    setShowCodeVerification(true);
                    toast.showToast('C√≥digo enviado para restablecer contrase√±a', 'success');
                } catch (error) {
                    console.error('Error enviando c√≥digo:', error);
                    toast.showToast('Error enviando c√≥digo', 'error');
                } finally {
                    setLoading(false);
                }
            };

            const handleResetPassword = async (e) => {
                e.preventDefault();
                setLoading(true);

                if (verificationCode !== generatedCode) {
                    toast.showToast('C√≥digo incorrecto', 'error');
                    setLoading(false);
                    return;
                }

                try {
                    await auth.sendPasswordResetEmail(email);
                    toast.showToast('Se envi√≥ un enlace de restablecimiento a tu correo', 'success');
                    setShowPasswordReset(false);
                    setShowCodeVerification(false);
                } catch (error) {
                    toast.showToast('Error restableciendo contrase√±a', 'error');
                } finally {
                    setLoading(false);
                }
            };

            const handleVerifyCode = async (e) => {
                e.preventDefault();
                setLoading(true);

                if (verificationCode !== generatedCode) {
                    toast.showToast('C√≥digo incorrecto', 'error');
                    setLoading(false);
                    return;
                }

                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(
                        pendingUserData.email,
                        pendingUserData.password
                    );
                    const user = userCredential.user;

                    const userData = {
                        email: pendingUserData.email,
                        fullName: pendingUserData.fullName,
                        userType: pendingUserData.userType,
                        emailVerified: true,
                        createdAt: new Date()
                    };

                    if (pendingUserData.userType === 'professor') {
                        // Crear profesor con estructura profile
                        await db.doc(`artifacts/seminario-investigacion-app/professors/${user.uid}/profile/data`)
                            .set(userData);
                    } else {
                        // Para estudiantes, solo guardamos los datos b√°sicos
                        // El profesor los agregar√° manualmente a su curso
                        userData.badgesEarned = [];
                        userData.lastBadgeEarned = null;
                        userData.courseCode = pendingUserData.courseCode;

                        // Crear documento temporal del estudiante
                        await db.doc(`artifacts/seminario-investigacion-app/temp-students/${user.uid}`)
                            .set(userData);
                    }

                    toast.showToast('¬°Cuenta creada exitosamente! Bienvenido.', 'success');

                    setShowCodeVerification(false);
                    setVerificationCode('');
                    setGeneratedCode('');
                    setPendingUserData(null);
                } catch (err) {
                    console.error('Error creando cuenta:', err);
                    let errorMessage = 'Error creando la cuenta';

                    if (err.code === 'auth/email-already-in-use') {
                        errorMessage = 'Este correo ya est√° registrado';
                    } else if (err.code === 'permission-denied') {
                        errorMessage = 'Error de permisos en Firestore. Verifica las reglas de seguridad.';
                    } else if (err.message === 'Curso no encontrado') {
                        errorMessage = 'El c√≥digo de curso no existe. Verifica con tu profesor.';
                    }

                    toast.showToast(errorMessage, 'error');
                } finally {
                    setLoading(false);
                }
            };

            if (showPasswordReset && !showCodeVerification) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4" style={{ backgroundColor: 'var(--bg-primary)' }}>
                        <div className="card rounded-2xl p-8 w-full max-w-md animate-fadeIn">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-3xl font-bold" style={{ color: 'var(--text-primary)' }}>
                                    Restablecer Contrase√±a
                                </h2>
                                <ThemeToggle />
                            </div>

                            <form onSubmit={handlePasswordReset}>
                                <div className="mb-4">
                                    <label className="block text-sm font-bold mb-2" style={{ color: 'var(--text-primary)' }}>
                                        Correo Institucional
                                    </label>
                                    <input
                                        className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                        type="email"
                                        placeholder="Correo institucional"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        required
                                    />
                                </div>

                                <div className="flex flex-col gap-4">
                                    <button
                                        className="btn btn-primary w-full"
                                        type="submit"
                                        disabled={loading}
                                    >
                                        {loading && <Loader2 className="w-5 h-5" />}
                                        Enviar C√≥digo
                                    </button>

                                    <button
                                        className="btn btn-secondary w-full"
                                        type="button"
                                        onClick={() => {
                                            setShowPasswordReset(false);
                                            setEmail('');
                                        }}
                                    >
                                        Volver
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                );
            }

            if (showCodeVerification) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4" style={{ backgroundColor: 'var(--bg-primary)' }}>
                        <div className="card rounded-2xl p-8 w-full max-w-md animate-fadeIn">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-3xl font-bold" style={{ color: 'var(--text-primary)' }}>
                                    Verificar C√≥digo
                                </h2>
                                <ThemeToggle />
                            </div>

                            <div className="text-center mb-6">
                                <p className="text-sm" style={{ color: 'var(--text-secondary)' }}>
                                    Ingresa el c√≥digo de 6 d√≠gitos enviado a <strong>{pendingUserData?.email || email}</strong>
                                </p>
                            </div>

                            <form onSubmit={handleVerifyCode}>
                                <div className="mb-6">
                                    <input
                                        className="input-field w-full py-3 px-4 rounded-lg focus:outline-none text-center text-2xl tracking-widest"
                                        type="text"
                                        placeholder="000000"
                                        value={verificationCode}
                                        onChange={(e) => setVerificationCode(e.target.value.replace(/\D/g, '').slice(0, 6))}
                                        maxLength="6"
                                        required
                                    />
                                </div>

                                <div className="flex flex-col gap-4">
                                    <button
                                        className="btn btn-primary w-full"
                                        type="submit"
                                        disabled={loading || verificationCode.length !== 6}
                                        onClick={showPasswordReset ? handleResetPassword : handleVerifyCode}
                                    >
                                        {loading && <Loader2 className="w-5 h-5" />}
                                        {showPasswordReset ? 'Restablecer Contrase√±a' : 'Verificar y Crear Cuenta'}
                                    </button>

                                    <button
                                        className="btn btn-secondary w-full"
                                        type="button"
                                        onClick={() => {
                                            setShowCodeVerification(false);
                                            setVerificationCode('');
                                            setGeneratedCode('');
                                            setPendingUserData(null);
                                            setShowPasswordReset(false);
                                        }}
                                    >
                                        Volver
                                    </button>
                                </div>
                            </form>
                            <div className="text-center mt-4 text-xs" style={{ color: 'var(--text-secondary)' }}>
                                Developed by<br />Leandro Fl√≥rez-Aristiz√°bal, Ph.D
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen flex items-center justify-center p-4" style={{ backgroundColor: 'var(--bg-primary)' }}>
                    <div className="card rounded-2xl p-8 w-full max-w-md animate-fadeIn">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-3xl font-bold" style={{ color: 'var(--text-primary)' }}>
                                {isLogin ? 'Iniciar Sesi√≥n' : 'Crear Cuenta'}
                            </h2>
                            <ThemeToggle />
                        </div>

                        <form onSubmit={handleAuth}>
                            <div className="mb-4">
                                <label className="block text-sm font-bold mb-2" style={{ color: 'var(--text-primary)' }}>
                                    Correo Institucional
                                </label>
                                <input
                                    className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                    type="email"
                                    placeholder="Correo institucional"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    required
                                />
                            </div>

                            {!isLogin && (
                                <>
                                    <div className="mb-4">
                                        <label className="block text-sm font-bold mb-2" style={{ color: 'var(--text-primary)' }}>
                                            Nombre Completo
                                        </label>
                                        <input
                                            className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                            type="text"
                                            placeholder="Tu Nombre Completo"
                                            value={fullName}
                                            onChange={(e) => setFullName(e.target.value)}
                                            required
                                        />
                                    </div>

                                    <div className="mb-4">
                                        <label className="block text-sm font-bold mb-2" style={{ color: 'var(--text-primary)' }}>
                                            Tipo de Usuario
                                        </label>
                                        <select
                                            className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                            value={userRole}
                                            onChange={(e) => setUserRole(e.target.value)}
                                            required
                                        >
                                            <option value="student">Estudiante</option>
                                            <option value="professor">Profesor</option>
                                        </select>
                                    </div>

                                    {userRole === 'student' && (
                                        <div className="mb-4">
                                            <label className="block text-sm font-bold mb-2" style={{ color: 'var(--text-primary)' }}>
                                                C√≥digo de Curso
                                            </label>
                                            <input
                                                className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                                type="text"
                                                placeholder="#codigo_del_profesor"
                                                value={courseCode}
                                                onChange={(e) => {
                                                    let value = e.target.value;
                                                    if (value && !value.startsWith('#')) {
                                                        value = '#' + value;
                                                    }
                                                    setCourseCode(value);
                                                }}
                                                required
                                            />
                                            <p className="text-xs mt-1" style={{ color: 'var(--text-secondary)' }}>
                                                Ingresa el c√≥digo que te proporcion√≥ tu profesor
                                            </p>
                                        </div>
                                    )}

                                </>
                            )}

                            <div className="mb-4">
                                <label className="block text-sm font-bold mb-2" style={{ color: 'var(--text-primary)' }}>
                                    Contrase√±a
                                </label>
                                <div className="relative">
                                    <input
                                        className="input-field w-full py-3 px-4 pr-10 rounded-lg focus:outline-none"
                                        type={showPassword ? 'text' : 'password'}
                                        placeholder="M√≠nimo 6 caracteres"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        required
                                    />
                                    <button
                                        type="button"
                                        className="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                                        onClick={() => setShowPassword(!showPassword)}
                                    >
                                        {showPassword ? 'üôâ' : 'üôà'}
                                    </button>
                                </div>
                            </div>

                            <div className="flex flex-col gap-4 mt-6">
                                <button
                                    className="btn btn-primary w-full"
                                    type="submit"
                                    disabled={loading}
                                >
                                    {loading && <Loader2 className="w-5 h-5" />}
                                    {isLogin ? 'Iniciar Sesi√≥n' : 'Enviar C√≥digo'}
                                </button>

                                <button
                                    className="btn btn-secondary w-full"
                                    type="button"
                                    onClick={() => {
                                        setIsLogin(!isLogin);
                                        setEmail('');
                                        setPassword('');
                                        setFullName('');
                                        setCourseCode('');
                                        setShowPassword(false);
                                    }}
                                >
                                    {isLogin ? '¬øNo tienes cuenta? Reg√≠strate' : '¬øYa tienes cuenta? Inicia Sesi√≥n'}
                                </button>

                                {isLogin && (
                                    <button
                                        className="btn btn-secondary w-full text-sm"
                                        type="button"
                                        onClick={() => setShowPasswordReset(true)}
                                    >
                                        ¬øOlvidaste tu contrase√±a?
                                    </button>
                                )}
                            </div>
                        </form>
                        <div className="text-center mt-4 text-xs" style={{ color: 'var(--text-secondary)' }}>
                            Developed by<br />Leandro Fl√≥rez-Aristiz√°bal, Ph.D
                        </div>
                    </div>
                </div>
            );
        }

        function AdminDashboard({ currentUser }) {
            const auth = firebase.auth();
            const db = firebase.firestore();
            const toast = useToast();
            const [courses, setCourses] = React.useState([]);
            const [selectedCourse, setSelectedCourse] = React.useState(null);
            const [students, setStudents] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [userData, setUserData] = React.useState(null);
            const [expandedStudent, setExpandedStudent] = React.useState(null);
            const [showCreateCourse, setShowCreateCourse] = React.useState(false);
            const [showEditContent, setShowEditContent] = React.useState(false);
            const [editingWeek, setEditingWeek] = React.useState(null);
            const [newCourse, setNewCourse] = React.useState({
                name: '',
                code: '',
                university: '',
                description: '',
                weeks: 16,
                weeklyContent: [],
                courseSchedule: []
            });
            const [showContentPreview, setShowContentPreview] = React.useState(false);
            const [previewContent, setPreviewContent] = React.useState(null);
            const [showRanking, setShowRanking] = React.useState(false);
            const [pendingStudents, setPendingStudents] = React.useState([]);
            const [showPendingStudents, setShowPendingStudents] = React.useState(false);
            const [showAttendance, setShowAttendance] = React.useState(false);
            const [qrTeacherVisible, setQrTeacherVisible] = React.useState(true);
            const [showQRTeacherWarning, setShowQRTeacherWarning] = React.useState(false);
            const [forceShowTeacherQR, setForceShowTeacherQR] = React.useState(false);
            const [attendanceData, setAttendanceData] = React.useState({});
            const qrCodeRef = React.useRef(null);
            const [weekContent, setWeekContent] = React.useState({
                title: '',
                description: '',
                content: '',
                activities: [''],
                badges: [{ name: '', description: '' }]
            });

            const courseDayOptions = [
                { key: 'SUN', label: 'D', name: 'Domingo' },
                { key: 'MON', label: 'L', name: 'Lunes' },
                { key: 'TUE', label: 'M', name: 'Martes' },
                { key: 'WED', label: 'M', name: 'Mi√©rcoles' },
                { key: 'THU', label: 'J', name: 'Jueves' },
                { key: 'FRI', label: 'V', name: 'Viernes' },
                { key: 'SAT', label: 'S', name: 'S√°bado' }
            ];
            const courseShiftOptions = ['DIURNO', 'TARDE', 'NOCTURNO'];

            const normalizeCourseSchedule = (schedule = []) => {
                return courseDayOptions
                    .map((dayOption) => schedule.find((item) => item.dayKey === dayOption.key))
                    .filter(Boolean)
                    .map((item) => ({
                        ...item,
                        shift: item.shift || 'DIURNO'
                    }));
            };

            const toggleScheduleDay = (currentSchedule = [], dayOption) => {
                const exists = currentSchedule.some((item) => item.dayKey === dayOption.key);

                if (exists) {
                    return normalizeCourseSchedule(currentSchedule.filter((item) => item.dayKey !== dayOption.key));
                }

                return normalizeCourseSchedule([
                    ...currentSchedule,
                    {
                        dayKey: dayOption.key,
                        dayLabel: dayOption.label,
                        dayName: dayOption.name,
                        shift: 'DIURNO'
                    }
                ]);
            };

            const updateScheduleShift = (currentSchedule = [], dayKey, shift) => {
                const updated = currentSchedule.map((item) => (
                    item.dayKey === dayKey ? { ...item, shift } : item
                ));
                return normalizeCourseSchedule(updated);
            };

            const getShiftForHour = (hour) => {
                if (hour >= 6 && hour < 12) return 'DIURNO';
                if (hour >= 12 && hour < 18) return 'TARDE';
                if (hour >= 18 && hour < 22) return 'NOCTURNO';
                return null;
            };

            const getDefaultCourseForNow = (coursesArray = []) => {
                if (coursesArray.length === 0) return null;

                const now = new Date();
                const dayOfWeek = now.getDay();
                const hour = now.getHours();
                const currentShift = getShiftForHour(hour);

                const dayKeys = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
                const currentDayKey = dayKeys[dayOfWeek];

                // 1. Buscar curso de HOY con JORNADA ACTUAL
                if (currentShift) {
                    const todayMatchingShift = coursesArray.find((course) => {
                        const schedule = normalizeCourseSchedule(course.courseSchedule || []);
                        return schedule.some((item) => item.dayKey === currentDayKey && item.shift === currentShift);
                    });
                    if (todayMatchingShift) return todayMatchingShift;
                }

                // 2. Buscar cualquier curso de HOY (sin importar jornada)
                const todayAny = coursesArray.find((course) => {
                    const schedule = normalizeCourseSchedule(course.courseSchedule || []);
                    return schedule.some((item) => item.dayKey === currentDayKey);
                });
                if (todayAny) return todayAny;

                // 3. Buscar primer curso para jornada actual de cualquier d√≠a
                if (currentShift) {
                    const anyMatchingShift = coursesArray.find((course) => {
                        const schedule = normalizeCourseSchedule(course.courseSchedule || []);
                        return schedule.some((item) => item.shift === currentShift);
                    });
                    if (anyMatchingShift) return anyMatchingShift;
                }

                // 4. Devolver el primer curso disponible
                return coursesArray[0];
            };

            const isCurrentClassTimeTeacher = (course) => {
                const now = new Date();
                const dayOfWeek = now.getDay();
                const hour = now.getHours();

                console.log(`[TEACHER-QR-CHECK] Verificando hora: ${now.toLocaleTimeString()}`);
                console.log(`[TEACHER-QR-CHECK] D√≠a: ${dayOfWeek}, Hora: ${hour}`);

                if (!course || !course.courseSchedule || course.courseSchedule.length === 0) {
                    console.log('[TEACHER-QR-CHECK] ERROR: course o courseSchedule vac√≠o');
                    return false;
                }

                const dayKeys = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
                const currentDayKey = dayKeys[dayOfWeek];
                const currentShift = getShiftForHour(hour);

                console.log(`[TEACHER-QR-CHECK] D√≠a: ${currentDayKey}, Jornada: ${currentShift}`);

                // Si no hay jornada activa, NO permitir QR
                if (!currentShift) {
                    console.log('[TEACHER-QR-CHECK] BLOQUEADO: Fuera de horario de clases');
                    return false;
                }

                // Verificar si el curso est√° programado para hoy
                const todaySchedule = course.courseSchedule.find((item) => item.dayKey === currentDayKey);

                if (!todaySchedule) {
                    console.log(`[TEACHER-QR-CHECK] Curso no programado para ${currentDayKey}`);
                    return false;
                }

                // Verificar si la jornada coincide
                if (todaySchedule.shift === currentShift) {
                    console.log('[TEACHER-QR-CHECK] ‚úì PERMITIDO: Hora y jornada correctas');
                    return true;
                }

                console.log(`[TEACHER-QR-CHECK] BLOQUEADO: Jornada no coincide. Esperada: ${todaySchedule.shift}, Actual: ${currentShift}`);
                return false;
            };

            React.useEffect(() => {
                loadUserData();
                loadCourses();
            }, []);

            React.useEffect(() => {
                if (selectedCourse) {
                    loadStudents();
                    loadPendingStudents();
                    if (showAttendance) {
                        loadAttendanceData();

                        // Verificar si es la hora correcta para mostrar el QR
                        const isCorrectTime = isCurrentClassTimeTeacher(selectedCourse);
                        console.log('[TEACHER-QR] isCorrectTime:', isCorrectTime, 'forceShowTeacherQR:', forceShowTeacherQR);

                        if (isCorrectTime || forceShowTeacherQR) {
                            setQrTeacherVisible(true);
                            generateTodayQR();
                        } else {
                            setQrTeacherVisible(false);
                            setShowQRTeacherWarning(true);
                        }
                    }
                }
            }, [selectedCourse, showAttendance, forceShowTeacherQR]);

            const loadUserData = async () => {
                try {
                    const userDoc = await db.doc(`artifacts/seminario-investigacion-app/professors/${currentUser.uid}/profile/data`).get();
                    if (userDoc.exists) {
                        setUserData(userDoc.data());
                    }
                } catch (error) {
                    console.error('Error cargando datos del usuario:', error);
                }
            };

            const loadCourses = async () => {
                try {
                    const coursesQuery = await db.collection(`artifacts/seminario-investigacion-app/professors/${currentUser.uid}/courses`).get();

                    const coursesData = coursesQuery.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));

                    setCourses(coursesData);
                    if (coursesData.length > 0 && !selectedCourse) {
                        const defaultCourse = getDefaultCourseForNow(coursesData);
                        setSelectedCourse(defaultCourse);
                    }
                } catch (error) {
                    console.error('Error cargando cursos:', error);
                    toast.showToast('Error cargando cursos', 'error');
                } finally {
                    setLoading(false);
                }
            };

            const loadStudents = async () => {
                if (!selectedCourse) return;

                try {
                    const studentsQuery = await db.collection(`artifacts/seminario-investigacion-app/professors/${currentUser.uid}/courses/${selectedCourse.id}/students`)
                        .get();

                    const studentsData = studentsQuery.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));

                    setStudents(studentsData);
                } catch (error) {
                    console.error('Error cargando estudiantes:', error);
                    toast.showToast('Error cargando estudiantes', 'error');
                }
            };

            const loadPendingStudents = async () => {
                if (!selectedCourse) return;

                try {
                    const tempStudentsQuery = await db.collection('artifacts/seminario-investigacion-app/temp-students')
                        .where('courseCode', '==', selectedCourse.courseCode)
                        .get();

                    const pendingData = tempStudentsQuery.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));

                    setPendingStudents(pendingData);
                } catch (error) {
                    console.error('Error cargando estudiantes pendientes:', error);
                }
            };

            const approveStudent = async (studentData) => {
                try {
                    const studentInfo = {
                        ...studentData,
                        approvedAt: new Date(),
                        badgesEarned: [],
                        badgeStatus: {},
                        lastBadgeEarned: null
                    };

                    await db.doc(`artifacts/seminario-investigacion-app/professors/${currentUser.uid}/courses/${selectedCourse.id}/students/${studentData.id}`)
                        .set(studentInfo);

                    // Agregar a enrollments en la colecci√≥n global
                    await db.doc(`artifacts/seminario-investigacion-app/courses/${selectedCourse.id}/enrollments/${studentData.id}`)
                        .set({
                            studentId: studentData.id,
                            fullName: studentData.fullName,
                            email: studentData.email,
                            enrolledAt: new Date()
                        });

                    await db.doc(`artifacts/seminario-investigacion-app/temp-students/${studentData.id}`).delete();

                    toast.showToast('Estudiante aprobado exitosamente', 'success');
                    loadStudents();
                    loadPendingStudents();
                } catch (error) {
                    console.error('Error aprobando estudiante:', error);
                    toast.showToast('Error aprobando estudiante', 'error');
                }
            };

            const rejectStudent = async (studentId) => {
                try {
                    await db.doc(`artifacts/seminario-investigacion-app/temp-students/${studentId}`).delete();
                    toast.showToast('Estudiante rechazado', 'success');
                    loadPendingStudents();
                } catch (error) {
                    console.error('Error rechazando estudiante:', error);
                    toast.showToast('Error rechazando estudiante', 'error');
                }
            };

            const generateTodayQR = () => {
                const now = new Date();
                const today = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                const qrData = JSON.stringify({
                    courseId: selectedCourse.id,
                    date: today,
                    professorId: currentUser.uid
                });

                setTimeout(() => {
                    if (qrCodeRef.current) {
                        qrCodeRef.current.innerHTML = '';
                        new QRCode(qrCodeRef.current, {
                            text: qrData,
                            width: 512,
                            height: 512,
                            colorDark: '#000000',
                            colorLight: '#ffffff'
                        });
                    }
                }, 100);
            };

            const loadAttendanceData = async () => {
                if (!selectedCourse) return;

                try {
                    const attendanceSnapshot = await db.collection(`artifacts/seminario-investigacion-app/courses/${selectedCourse.id}/attendance`).get();

                    const attendanceByDate = {};
                    attendanceSnapshot.docs.forEach(doc => {
                        attendanceByDate[doc.id] = doc.data().students || [];
                    });

                    setAttendanceData(attendanceByDate);
                } catch (error) {
                    console.error('Error cargando asistencia:', error);
                }
            };

            const markManualAttendance = async (student, date) => {
                if (!selectedCourse) return;

                try {
                    const attendanceRef = db.doc(`artifacts/seminario-investigacion-app/courses/${selectedCourse.id}/attendance/${date}`);
                    const attendanceDoc = await attendanceRef.get();

                    const attendanceRecord = {
                        studentId: student.id,
                        studentName: student.fullName || student.email || 'Estudiante',
                        timestamp: new Date(),
                        source: 'manual'
                    };

                    if (attendanceDoc.exists) {
                        const existingData = attendanceDoc.data();
                        const studentsForDate = existingData.students || [];
                        const alreadyMarked = studentsForDate.some(record => record.studentId === student.id);

                        if (alreadyMarked) {
                            toast.showToast('La asistencia ya estaba registrada', 'info');
                            return;
                        }

                        await attendanceRef.update({
                            students: [...studentsForDate, attendanceRecord]
                        });
                    } else {
                        await attendanceRef.set({
                            date,
                            courseId: selectedCourse.id,
                            professorId: currentUser.uid,
                            students: [attendanceRecord]
                        });
                    }

                    setAttendanceData(prev => {
                        const current = prev[date] || [];
                        return {
                            ...prev,
                            [date]: [...current, attendanceRecord]
                        };
                    });

                    toast.showToast(`Asistencia manual registrada para ${student.fullName || student.email}`, 'success');
                } catch (error) {
                    console.error('Error registrando asistencia manual:', error);
                    toast.showToast('Error registrando asistencia manual', 'error');
                }
            };

            const createCourse = async () => {
                if (!newCourse.name || !newCourse.code || !newCourse.university) {
                    toast.showToast('Nombre, c√≥digo y universidad son requeridos', 'error');
                    return;
                }

                try {
                    const courseCode = newCourse.code.startsWith('#') ? newCourse.code : '#' + newCourse.code;

                    const courseData = {
                        name: newCourse.name,
                        courseCode: courseCode,
                        university: newCourse.university,
                        description: newCourse.description,
                        courseSchedule: normalizeCourseSchedule(newCourse.courseSchedule || []),
                        weeks: newCourse.weeks,
                        professorId: currentUser.uid,
                        professorEmail: currentUser.email,
                        professorName: userData?.fullName || currentUser.email,
                        createdAt: new Date(),
                        studentsCount: 0,
                        weeklyContent: [],
                        badges: []
                    };

                    const docRef = await db.collection(`artifacts/seminario-investigacion-app/professors/${currentUser.uid}/courses`).add(courseData);

                    // Crear estructura inicial de semanas
                    const weeklyContent = [];
                    for (let i = 1; i <= newCourse.weeks; i++) {
                        weeklyContent.push({
                            week: i,
                            title: `Semana ${i}`,
                            description: '',
                            content: '',
                            activities: [],
                            badges: []
                        });
                    }

                    await docRef.update({ weeklyContent });

                    // Crear documento en la colecci√≥n global courses
                    try {
                        await db.doc(`artifacts/seminario-investigacion-app/courses/${docRef.id}`).set({
                            courseName: `Cat√°logo: ${newCourse.name}`,
                            courseCode: courseCode,
                            professorId: currentUser.uid,
                            professorName: userData?.fullName || currentUser.email,
                            createdAt: new Date(),
                            content: newCourse.description || '',
                            courseSchedule: normalizeCourseSchedule(newCourse.courseSchedule || [])
                        });
                        console.log('‚úì Documento creado en colecci√≥n global courses:', docRef.id);
                    } catch (globalError) {
                        console.error('Error creando documento en colecci√≥n global:', globalError);
                        toast.showToast('Curso creado pero error en cat√°logo global', 'info');
                    }

                    toast.showToast('Curso creado exitosamente', 'success');
                    setShowCreateCourse(false);
                    setNewCourse({ name: '', code: '', university: '', description: '', weeks: 16, weeklyContent: [], courseSchedule: [] });
                    loadCourses();
                } catch (error) {
                    console.error('Error creando curso:', error);
                    toast.showToast('Error creando curso', 'error');
                }
            };

            const assignBadge = async (studentId, badgeId, earned = true) => {
                try {
                    const studentRef = db.doc(`artifacts/seminario-investigacion-app/professors/${currentUser.uid}/courses/${selectedCourse.id}/students/${studentId}`);
                    const studentDoc = await studentRef.get();

                    if (studentDoc.exists) {
                        const studentData = studentDoc.data();
                        const currentBadges = studentData.badgesEarned || [];
                        const currentBadgeStatus = studentData.badgeStatus || {};

                        if (!currentBadges.includes(badgeId)) {
                            await studentRef.update({
                                badgesEarned: [...currentBadges, badgeId],
                                badgeStatus: {
                                    ...currentBadgeStatus,
                                    [badgeId]: earned ? 'earned' : 'assigned'
                                },
                                lastBadgeEarned: new Date()
                            });

                            toast.showToast(`Badge ${earned ? 'ganado' : 'asignado'} exitosamente`, 'success');
                            loadStudents();
                        } else {
                            toast.showToast('El estudiante ya tiene este badge', 'error');
                        }
                    }
                } catch (error) {
                    console.error('Error asignando badge:', error);
                    if (error.code === 'permission-denied') {
                        toast.showToast('Error de permisos. Aplica las reglas de Firestore del README.', 'error');
                    } else {
                        toast.showToast('Error asignando badge', 'error');
                    }
                }
            };

            const [showPasswordModal, setShowPasswordModal] = React.useState(false);
            const [passwordData, setPasswordData] = React.useState({ password: '', showPassword: false, studentId: '', badgeId: '', newStatus: '' });
            const [isUpdatingBadge, setIsUpdatingBadge] = React.useState(false);
            const [showDeleteConfirm, setShowDeleteConfirm] = React.useState(null);
            const [deletePassword, setDeletePassword] = React.useState('');
            const [showDeletePassword, setShowDeletePassword] = React.useState(false);
            const [showProfile, setShowProfile] = React.useState(false);
            const [showProfileCurrentPassword, setShowProfileCurrentPassword] = React.useState(false);
            const [showProfileNewPassword, setShowProfileNewPassword] = React.useState(false);
            const [showChangeCourseCode, setShowChangeCourseCode] = React.useState(false);
            const [profileData, setProfileData] = React.useState({
                fullName: '',
                currentPassword: '',
                newPassword: '',
                confirmPassword: ''
            });
            const [newCourseCode, setNewCourseCode] = React.useState('');

            const changeBadgeStatus = (studentId, badgeId, newStatus) => {
                if (confirm(`¬øEst√°s seguro de cambiar el badge a ${newStatus === 'earned' ? 'ganado' : 'asignado'}?`)) {
                    updateBadgeStatus(studentId, badgeId, newStatus);
                }
            };



            const updateBadgeStatus = async (studentId, badgeId, newStatus) => {
                try {
                    const studentRef = db.doc(`artifacts/seminario-investigacion-app/professors/${currentUser.uid}/courses/${selectedCourse.id}/students/${studentId}`);
                    const studentDoc = await studentRef.get();

                    if (studentDoc.exists) {
                        const studentData = studentDoc.data();
                        const currentBadgeStatus = studentData.badgeStatus || {};

                        await studentRef.update({
                            badgeStatus: {
                                ...currentBadgeStatus,
                                [badgeId]: newStatus
                            }
                        });

                        toast.showToast(`Badge cambiado a ${newStatus === 'earned' ? 'ganado' : 'asignado'}`, 'success');
                        loadStudents();
                    }
                } catch (error) {
                    console.error('Error actualizando badge:', error);
                    toast.showToast('Error actualizando badge', 'error');
                }
            };

            const removeStudent = async (studentId) => {
                if (!confirm('¬øEst√°s seguro de que quieres remover este estudiante del curso?')) {
                    return;
                }

                try {
                    await db.doc(`artifacts/seminario-investigacion-app/professors/${currentUser.uid}/courses/${selectedCourse.id}/students/${studentId}`).delete();

                    // Remover de enrollments en la colecci√≥n global
                    await db.doc(`artifacts/seminario-investigacion-app/courses/${selectedCourse.id}/enrollments/${studentId}`).delete();

                    toast.showToast('Estudiante removido exitosamente', 'success');
                    loadStudents();
                } catch (error) {
                    console.error('Error removiendo estudiante:', error);
                    toast.showToast('Error removiendo estudiante', 'error');
                }
            };

            const deleteCourse = async () => {
                if (!deletePassword) return;

                try {
                    const credential = firebase.auth.EmailAuthProvider.credential(currentUser.email, deletePassword);
                    await currentUser.reauthenticateWithCredential(credential);

                    // Eliminar de la colecci√≥n del profesor
                    await db.doc(`artifacts/seminario-investigacion-app/professors/${currentUser.uid}/courses/${showDeleteConfirm}`).delete();

                    // Eliminar de la colecci√≥n global courses
                    await db.doc(`artifacts/seminario-investigacion-app/courses/${showDeleteConfirm}`).delete();

                    toast.showToast('Curso eliminado exitosamente', 'success');
                    setShowDeleteConfirm(null);
                    setDeletePassword('');
                    loadCourses();
                    setSelectedCourse(null);
                } catch (error) {
                    if (error.code === 'auth/wrong-password') {
                        toast.showToast('Contrase√±a incorrecta', 'error');
                    } else {
                        console.error('Error eliminando curso:', error);
                        toast.showToast('Error eliminando curso', 'error');
                    }
                }
            };

            const handleUpdateProfile = async (e) => {
                e.preventDefault();

                try {
                    if (profileData.newPassword) {
                        if (profileData.newPassword !== profileData.confirmPassword) {
                            toast.showToast('Las contrase√±as no coinciden', 'error');
                            return;
                        }

                        const credential = firebase.auth.EmailAuthProvider.credential(
                            currentUser.email,
                            profileData.currentPassword
                        );
                        await currentUser.reauthenticateWithCredential(credential);
                        await currentUser.updatePassword(profileData.newPassword);
                        toast.showToast('Contrase√±a actualizada', 'success');
                    }

                    if (profileData.fullName && profileData.fullName !== userData?.fullName) {
                        await db.doc(`artifacts/seminario-investigacion-app/professors/${currentUser.uid}/profile/data`)
                            .update({ fullName: profileData.fullName });
                        toast.showToast('Nombre actualizado', 'success');
                        loadUserData();
                    }

                    setShowProfile(false);
                    setProfileData({ fullName: '', currentPassword: '', newPassword: '', confirmPassword: '' });
                } catch (error) {
                    if (error.code === 'auth/wrong-password') {
                        toast.showToast('Contrase√±a actual incorrecta', 'error');
                    } else {
                        toast.showToast('Error actualizando perfil', 'error');
                    }
                }
            };

            const handleChangeCourseCode = async (e) => {
                e.preventDefault();

                if (!newCourseCode.startsWith('#')) {
                    toast.showToast('El c√≥digo debe comenzar con #', 'error');
                    return;
                }

                try {
                    await db.doc(`artifacts/seminario-investigacion-app/professors/${currentUser.uid}/courses/${selectedCourse.id}`)
                        .update({ courseCode: newCourseCode });

                    toast.showToast('C√≥digo del curso actualizado', 'success');
                    setShowChangeCourseCode(false);
                    loadCourses();
                } catch (error) {
                    console.error('Error actualizando c√≥digo:', error);
                    toast.showToast('Error actualizando c√≥digo del curso', 'error');
                }
            };

            const editWeekContent = (weekNumber) => {
                if (weekNumber === 0) {
                    // Editar informaci√≥n general
                    setWeekContent({
                        university: selectedCourse.university || '',
                        courseName: selectedCourse.name || '',
                        courseCode: selectedCourse.courseCode || '',
                        courseSchedule: normalizeCourseSchedule(selectedCourse.courseSchedule || []),
                        period: selectedCourse.period || '',
                        group: selectedCourse.group || '',
                        programs: selectedCourse.programs || '',
                        intensity: selectedCourse.intensity || '',
                        credits: selectedCourse.credits || '',
                        introduction: selectedCourse.introduction || '',
                        iagAgreements: selectedCourse.iagAgreements || '',
                        availableBadges: selectedCourse.availableBadges || []
                    });
                } else {
                    const week = selectedCourse.weeklyContent?.find(w => w.week === weekNumber) || {
                        title: `Semana ${weekNumber}`,
                        description: '',
                        content: '',
                        activities: [''],
                        badges: [{ name: '', description: '' }]
                    };
                    setWeekContent(week);
                }
                setEditingWeek(weekNumber);
                setShowEditContent(true);
            };

            const saveWeekContent = async () => {
                try {
                    const courseRef = db.doc(`artifacts/seminario-investigacion-app/professors/${currentUser.uid}/courses/${selectedCourse.id}`);

                    if (editingWeek === 0) {
                        // Guardar informaci√≥n general
                        await courseRef.update({
                            university: weekContent.university,
                            name: weekContent.courseName,
                            courseCode: weekContent.courseCode,
                            courseSchedule: normalizeCourseSchedule(weekContent.courseSchedule || []),
                            period: weekContent.period,
                            group: weekContent.group,
                            programs: weekContent.programs,
                            intensity: weekContent.intensity,
                            credits: weekContent.credits,
                            introduction: weekContent.introduction,
                            iagAgreements: weekContent.iagAgreements,
                            availableBadges: weekContent.availableBadges || []
                        });
                    } else {
                        // Guardar contenido de semana
                        const courseDoc = await courseRef.get();
                        const courseData = courseDoc.data();

                        let weeklyContent = courseData.weeklyContent || [];
                        const weekIndex = weeklyContent.findIndex(w => w.week === editingWeek);

                        const updatedWeek = {
                            ...weekContent,
                            week: editingWeek,
                            activities: weekContent.activities?.filter(a => a.trim()) || [],
                            badges: weekContent.badges?.filter(b => b.name?.trim()) || []
                        };

                        if (weekIndex >= 0) {
                            weeklyContent[weekIndex] = updatedWeek;
                        } else {
                            weeklyContent.push(updatedWeek);
                        }

                        await courseRef.update({ weeklyContent });
                    }

                    toast.showToast('Contenido guardado exitosamente', 'success');
                    setShowEditContent(false);
                    await loadCourses();
                    // Actualizar el curso seleccionado con los nuevos datos
                    const updatedCourseData = await db.doc(`artifacts/seminario-investigacion-app/professors/${currentUser.uid}/courses/${selectedCourse.id}`).get();
                    if (updatedCourseData.exists) {
                        setSelectedCourse({ id: selectedCourse.id, ...updatedCourseData.data() });
                    }
                } catch (error) {
                    console.error('Error guardando contenido:', error);
                    toast.showToast('Error guardando contenido', 'error');
                }
            };

            const handleLogout = async () => {
                try {
                    await auth.signOut();
                    toast.showToast('¬°Hasta luego!', 'success');
                } catch (err) {
                    toast.showToast("Error al cerrar sesi√≥n. Intenta de nuevo.", 'error');
                }
            };

            if (loading) {
                return <LoadingSpinner />;
            }

            if (showProfile) {
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div className="card rounded-xl p-6 w-full max-w-md">
                            <h3 className="text-lg font-bold mb-4">Perfil de Usuario</h3>
                            <form onSubmit={handleUpdateProfile}>
                                <div className="mb-4">
                                    <label className="block text-sm font-bold mb-2">Nombre Completo</label>
                                    <input
                                        className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                        type="text"
                                        placeholder={userData?.fullName || 'Tu nombre completo'}
                                        value={profileData.fullName}
                                        onChange={(e) => setProfileData({ ...profileData, fullName: e.target.value })}
                                    />
                                </div>

                                <div className="border-t pt-4 mb-4">
                                    <h4 className="font-semibold mb-2">Cambiar Contrase√±a (Opcional)</h4>
                                    <div className="space-y-3">
                                        <div>
                                            <label className="block text-sm font-bold mb-2">Contrase√±a Actual</label>
                                            <div className="relative">
                                                <input
                                                    className="input-field w-full py-2 px-3 pr-10 rounded-lg focus:outline-none"
                                                    type={showProfileCurrentPassword ? 'text' : 'password'}
                                                    placeholder="Contrase√±a actual"
                                                    value={profileData.currentPassword}
                                                    onChange={(e) => setProfileData({ ...profileData, currentPassword: e.target.value })}
                                                />
                                                <button
                                                    type="button"
                                                    className="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                                                    onClick={() => setShowProfileCurrentPassword(!showProfileCurrentPassword)}
                                                >
                                                    {showProfileCurrentPassword ? 'üôâ' : 'üôà'}
                                                </button>
                                            </div>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold mb-2">Nueva Contrase√±a</label>
                                            <div className="relative">
                                                <input
                                                    className="input-field w-full py-2 px-3 pr-10 rounded-lg focus:outline-none"
                                                    type={showProfileNewPassword ? 'text' : 'password'}
                                                    placeholder="Nueva contrase√±a"
                                                    value={profileData.newPassword}
                                                    onChange={(e) => setProfileData({ ...profileData, newPassword: e.target.value })}
                                                />
                                                <button
                                                    type="button"
                                                    className="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                                                    onClick={() => setShowProfileNewPassword(!showProfileNewPassword)}
                                                >
                                                    {showProfileNewPassword ? 'üôâ' : 'üôà'}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="flex gap-3">
                                    <button
                                        type="button"
                                        onClick={() => {
                                            setShowProfile(false);
                                            setProfileData({ fullName: '', currentPassword: '', newPassword: '', confirmPassword: '' });
                                        }}
                                        className="btn btn-secondary flex-1"
                                    >
                                        Cancelar
                                    </button>
                                    <button
                                        type="submit"
                                        className="btn btn-primary flex-1"
                                    >
                                        Guardar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                );
            }

            if (showChangeCourseCode) {
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div className="card rounded-xl p-6 w-full max-w-md">
                            <h3 className="text-lg font-bold mb-4">Cambiar C√≥digo del Curso</h3>
                            <form onSubmit={handleChangeCourseCode}>
                                <div className="mb-4">
                                    <label className="block text-sm font-bold mb-2">Nuevo C√≥digo del Curso</label>
                                    <input
                                        className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                        type="text"
                                        placeholder="#NUEVO_CODIGO"
                                        value={newCourseCode}
                                        onChange={(e) => {
                                            let value = e.target.value;
                                            if (value && !value.startsWith('#')) {
                                                value = '#' + value;
                                            }
                                            setNewCourseCode(value);
                                        }}
                                        required
                                    />
                                    <p className="text-xs mt-1" style={{ color: 'var(--text-secondary)' }}>
                                        Los estudiantes usar√°n este c√≥digo para unirse al curso
                                    </p>
                                </div>

                                <div className="flex gap-3">
                                    <button
                                        type="button"
                                        onClick={() => {
                                            setShowChangeCourseCode(false);
                                            setNewCourseCode('');
                                        }}
                                        className="btn btn-secondary flex-1"
                                    >
                                        Cancelar
                                    </button>
                                    <button
                                        type="submit"
                                        className="btn btn-primary flex-1"
                                    >
                                        Actualizar C√≥digo
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                );
            }

            if (showAttendance) {
                const now = new Date();
                const today = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                const dates = Object.keys(attendanceData).sort();
                const sortedStudents = [...students].sort((a, b) => {
                    const nameA = (a.fullName || a.email || '').toLowerCase();
                    const nameB = (b.fullName || b.email || '').toLowerCase();
                    return nameA.localeCompare(nameB, 'es');
                });

                const formatDateMmmDD = (dateStr) => {
                    const date = new Date(dateStr + 'T00:00:00');
                    const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                    return {
                        month: months[date.getMonth()],
                        day: String(date.getDate()).padStart(2, '0')
                    };
                };

                const formatDateMmmDDYY = (dateStr) => {
                    const date = new Date(dateStr + 'T00:00:00');
                    const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                    const year = String(date.getFullYear()).slice(-2);
                    return `${months[date.getMonth()]}-${String(date.getDate()).padStart(2, '0')}-${year}`;
                };

                return (
                    <div className="min-h-screen p-4 md:p-8" style={{ backgroundColor: 'var(--bg-primary)' }}>
                        <div className="max-w-6xl mx-auto">
                            <div className="card rounded-xl p-6 mb-6">
                                <div className="flex justify-end items-center mb-4">
                                    <button
                                        onClick={() => {
                                            setShowAttendance(false);
                                            setForceShowTeacherQR(false);
                                            setShowQRTeacherWarning(false);
                                        }}
                                        className="btn btn-secondary"
                                    >
                                        ‚Üê Volver
                                    </button>
                                </div>

                                <div className="grid md:grid-cols-2 gap-6">
                                    <div className="flex flex-col items-center">
                                        <h2 className="text-2xl font-bold mb-2">Control de Asistencia</h2>
                                        <p className="text-2xl font-bold mb-4" style={{ color: 'var(--accent-color)' }}>{selectedCourse.name}</p>
                                        <h3 className="font-semibold mb-4">QR de hoy ({formatDateMmmDDYY(today)})</h3>

                                        {qrTeacherVisible ? (
                                            <>
                                                <div className="bg-white p-8 rounded-lg inline-block shadow-lg" style={{ border: '4px solid #f0f0f0' }}>
                                                    <div ref={qrCodeRef}></div>
                                                </div>
                                                <p className="text-sm text-gray-600 mt-2">Escanea desde cualquier distancia</p>
                                            </>
                                        ) : (
                                            <div className="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-6 w-full max-w-sm text-center">
                                                <div className="text-3xl mb-3">üîí</div>
                                                <h4 className="font-semibold text-yellow-900 mb-2">QR Oculto</h4>
                                                <p className="text-sm text-yellow-800 mb-4">
                                                    La clase no est√° programada para este momento
                                                </p>
                                                <button
                                                    onClick={() => {
                                                        setForceShowTeacherQR(true);
                                                        setQrTeacherVisible(true);
                                                        setTimeout(() => generateTodayQR(), 100);
                                                    }}
                                                    className="btn btn-primary text-sm"
                                                >
                                                    Mostrar QR
                                                </button>
                                            </div>
                                        )}
                                    </div>

                                    <div className="flex flex-col h-full min-h-0">
                                        <h3 className="font-semibold mb-4">Asistencia de Hoy</h3>
                                        <div className="bg-gray-50 rounded-lg p-4 flex-1 min-h-0 overflow-y-auto">
                                            {attendanceData[today] && attendanceData[today].length > 0 ? (
                                                <ul className="space-y-2">
                                                    {attendanceData[today].map((record, idx) => (
                                                        <li key={idx} className="flex items-center gap-2 text-sm">
                                                            <span className="text-green-600">‚úì</span>
                                                            <span>{record.studentName}</span>
                                                            <span className="text-xs text-gray-500">
                                                                ({new Date(record.timestamp?.toDate ? record.timestamp.toDate() : record.timestamp).toLocaleTimeString()})
                                                            </span>
                                                        </li>
                                                    ))}
                                                </ul>
                                            ) : (
                                                <p className="text-gray-500 text-center">A√∫n no hay asistencias registradas hoy</p>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="card rounded-xl p-6">
                                <h3 className="font-semibold mb-4">Historial de Asistencia</h3>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-xs">
                                        <thead>
                                            <tr className="border-b">
                                                <th className="text-left p-3">Estudiante</th>
                                                {dates.slice(0, 10).map(date => {
                                                    const dateFormatted = formatDateMmmDD(date);
                                                    return (
                                                        <th key={date} className="text-center p-3">
                                                            <div className="flex flex-col items-center">
                                                                <div>{dateFormatted.month}</div>
                                                                <div className="font-bold">{dateFormatted.day}</div>
                                                            </div>
                                                        </th>
                                                    );
                                                })}
                                                <th className="text-center p-3">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {sortedStudents.map(student => {
                                                const attendanceCount = dates.filter(date =>
                                                    attendanceData[date]?.some(record => record.studentId === student.id)
                                                ).length;

                                                return (
                                                    <tr key={student.id} className="border-b hover:bg-gray-50">
                                                        <td className="p-3">{student.fullName}</td>
                                                        {dates.slice(0, 10).map(date => {
                                                            const attended = attendanceData[date]?.some(record => record.studentId === student.id);
                                                            return (
                                                                <td key={date} className="text-center p-3">
                                                                    {attended ? (
                                                                        <span className="text-green-600">‚úì</span>
                                                                    ) : (
                                                                        <button
                                                                            type="button"
                                                                            className="text-gray-400 hover:text-green-600 font-semibold"
                                                                            title="Registrar asistencia manual"
                                                                            onClick={() => markManualAttendance(student, date)}
                                                                        >
                                                                            -
                                                                        </button>
                                                                    )}
                                                                </td>
                                                            );
                                                        })}
                                                        <td className="text-center p-3 font-semibold">{attendanceCount}</td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (showDeleteConfirm) {
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div className="card rounded-xl p-6 w-full max-w-md mx-4">
                            <h3 className="text-lg font-bold mb-4">Eliminar Curso</h3>
                            <p className="text-sm mb-4" style={{ color: 'var(--text-secondary)' }}>
                                Ingresa tu contrase√±a para confirmar la eliminaci√≥n del curso:
                            </p>
                            <div className="relative mb-4">
                                <input
                                    className="input-field w-full py-3 px-4 pr-12 rounded-lg focus:outline-none"
                                    type={showDeletePassword ? 'text' : 'password'}
                                    placeholder="Contrase√±a"
                                    value={deletePassword}
                                    onChange={(e) => setDeletePassword(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && deleteCourse()}
                                />
                                <button
                                    type="button"
                                    className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                                    onClick={() => setShowDeletePassword(!showDeletePassword)}
                                >
                                    {showDeletePassword ? 'üôà' : 'üëÅÔ∏è'}
                                </button>
                            </div>
                            <div className="flex gap-3">
                                <button
                                    onClick={() => {
                                        setShowDeleteConfirm(null);
                                        setDeletePassword('');
                                    }}
                                    className="btn btn-secondary flex-1"
                                >
                                    Cancelar
                                </button>
                                <button
                                    onClick={deleteCourse}
                                    className="btn btn-primary flex-1 bg-red-500 hover:bg-red-600"
                                    disabled={!deletePassword}
                                >
                                    Eliminar Curso
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (showEditContent) {
                return (
                    <div className="min-h-screen p-4 md:p-8" style={{ backgroundColor: 'var(--bg-primary)' }}>
                        <div className="max-w-4xl mx-auto">
                            <div className="card rounded-xl p-6">
                                <h2 className="text-2xl font-bold mb-6">{editingWeek === 0 ? 'Editar Informaci√≥n General' : `Editar Contenido - Semana ${editingWeek}`}</h2>

                                {editingWeek === 0 ? (
                                    <div className="space-y-6">
                                        <div>
                                            <h4 className="font-semibold text-lg mb-4 text-gray-800">Datos del Curso</h4>
                                            <div className="grid md:grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-sm font-bold mb-2">Universidad</label>
                                                    <input
                                                        className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                                        type="text"
                                                        value={weekContent.university || ''}
                                                        onChange={(e) => setWeekContent({ ...weekContent, university: e.target.value })}
                                                        placeholder="Nombre de la universidad"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-bold mb-2">Nombre</label>
                                                    <input
                                                        className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                                        type="text"
                                                        value={weekContent.courseName || ''}
                                                        onChange={(e) => setWeekContent({ ...weekContent, courseName: e.target.value })}
                                                        placeholder="Nombre del curso"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-bold mb-2">C√≥digo</label>
                                                    <input
                                                        className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                                        type="text"
                                                        value={weekContent.courseCode || ''}
                                                        onChange={(e) => setWeekContent({ ...weekContent, courseCode: e.target.value })}
                                                        placeholder="INGE-3032"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-bold mb-2">Periodo</label>
                                                    <input
                                                        className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                                        type="text"
                                                        value={weekContent.period || ''}
                                                        onChange={(e) => setWeekContent({ ...weekContent, period: e.target.value })}
                                                        placeholder="2024-2"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-bold mb-2">Grupo</label>
                                                    <input
                                                        className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                                        type="text"
                                                        value={weekContent.group || ''}
                                                        onChange={(e) => setWeekContent({ ...weekContent, group: e.target.value })}
                                                        placeholder="01"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-bold mb-2">Programa/s</label>
                                                    <input
                                                        className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                                        type="text"
                                                        value={weekContent.programs || ''}
                                                        onChange={(e) => setWeekContent({ ...weekContent, programs: e.target.value })}
                                                        placeholder="Ingenier√≠a de Sistemas"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-bold mb-2">Intensidad Horaria</label>
                                                    <input
                                                        className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                                        type="text"
                                                        value={weekContent.intensity || ''}
                                                        onChange={(e) => setWeekContent({ ...weekContent, intensity: e.target.value })}
                                                        placeholder="4 horas semanales"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-bold mb-2">Cr√©ditos</label>
                                                    <input
                                                        className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                                        type="text"
                                                        value={weekContent.credits || ''}
                                                        onChange={(e) => setWeekContent({ ...weekContent, credits: e.target.value })}
                                                        placeholder="3"
                                                    />
                                                </div>
                                            </div>

                                            <div className="mt-4">
                                                <label className="block text-sm font-bold mb-2">D√≠as y Jornada del Curso</label>
                                                <div className="flex flex-wrap gap-2">
                                                    {courseDayOptions.map((dayOption) => {
                                                        const isSelected = (weekContent.courseSchedule || []).some((item) => item.dayKey === dayOption.key);
                                                        return (
                                                            <button
                                                                key={dayOption.key}
                                                                type="button"
                                                                onClick={() => setWeekContent({
                                                                    ...weekContent,
                                                                    courseSchedule: toggleScheduleDay(weekContent.courseSchedule || [], dayOption)
                                                                })}
                                                                className={`w-10 h-10 rounded-full text-sm font-bold border-2 transition-all ${isSelected
                                                                    ? 'bg-blue-500 text-white border-blue-500'
                                                                    : 'bg-transparent border-gray-300 text-gray-600 hover:border-blue-500 hover:text-blue-500'
                                                                    }`}
                                                                title={dayOption.name}
                                                            >
                                                                {dayOption.label}
                                                            </button>
                                                        );
                                                    })}
                                                </div>

                                                {(weekContent.courseSchedule || []).length > 0 && (
                                                    <div className="grid md:grid-cols-2 gap-3 mt-4">
                                                        {normalizeCourseSchedule(weekContent.courseSchedule || []).map((scheduleItem) => (
                                                            <div key={scheduleItem.dayKey}>
                                                                <label className="block text-sm font-medium mb-1">
                                                                    {scheduleItem.dayName}
                                                                </label>
                                                                <select
                                                                    className="input-field w-full py-2 px-3 rounded-lg focus:outline-none"
                                                                    value={scheduleItem.shift || 'DIURNO'}
                                                                    onChange={(e) => setWeekContent({
                                                                        ...weekContent,
                                                                        courseSchedule: updateScheduleShift(weekContent.courseSchedule || [], scheduleItem.dayKey, e.target.value)
                                                                    })}
                                                                >
                                                                    {courseShiftOptions.map((shiftOption) => (
                                                                        <option key={shiftOption} value={shiftOption}>{shiftOption}</option>
                                                                    ))}
                                                                </select>
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        </div>

                                        <div>
                                            <h4 className="font-semibold text-lg mb-4 text-gray-800">Introducci√≥n</h4>
                                            <textarea
                                                className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                                rows="4"
                                                value={weekContent.introduction || ''}
                                                onChange={(e) => setWeekContent({ ...weekContent, introduction: e.target.value })}
                                                placeholder="Introducci√≥n del curso..."
                                            />
                                        </div>

                                        <div>
                                            <h4 className="font-semibold text-lg mb-4 text-gray-800">Acuerdos sobre el Uso de Inteligencia Artificial Generativa (IAG)</h4>
                                            <textarea
                                                className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                                rows="6"
                                                value={weekContent.iagAgreements || ''}
                                                onChange={(e) => setWeekContent({ ...weekContent, iagAgreements: e.target.value })}
                                                placeholder="Acuerdos sobre el uso de Inteligencia Artificial Generativa..."
                                            />
                                        </div>

                                        <div>
                                            <h4 className="font-semibold text-lg mb-4 text-gray-800">Badges Disponibles en el Curso</h4>
                                            <div className="space-y-3">
                                                {(weekContent.availableBadges || []).map((badge, index) => (
                                                    <div key={index} className="border rounded p-3 bg-gray-50">
                                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                                            <div>
                                                                <label className="block text-sm font-medium mb-1">Nombre del Badge:</label>
                                                                <input
                                                                    type="text"
                                                                    value={badge.name || ''}
                                                                    onChange={(e) => {
                                                                        const newBadges = [...(weekContent.availableBadges || [])];
                                                                        newBadges[index] = { ...badge, name: e.target.value };
                                                                        setWeekContent({ ...weekContent, availableBadges: newBadges });
                                                                    }}
                                                                    className="input-field w-full p-2 rounded"
                                                                    placeholder="Badge de Iniciaci√≥n"
                                                                />
                                                            </div>
                                                            <div>
                                                                <label className="block text-sm font-medium mb-1">Descripci√≥n:</label>
                                                                <input
                                                                    type="text"
                                                                    value={badge.description || ''}
                                                                    onChange={(e) => {
                                                                        const newBadges = [...(weekContent.availableBadges || [])];
                                                                        newBadges[index] = { ...badge, description: e.target.value };
                                                                        setWeekContent({ ...weekContent, availableBadges: newBadges });
                                                                    }}
                                                                    className="input-field w-full p-2 rounded"
                                                                    placeholder="Descripci√≥n del badge"
                                                                />
                                                            </div>
                                                            <div>
                                                                <label className="block text-sm font-medium mb-1">Semana M√°xima:</label>
                                                                <select
                                                                    value={badge.maxWeek || 1}
                                                                    onChange={(e) => {
                                                                        const newBadges = [...(weekContent.availableBadges || [])];
                                                                        newBadges[index] = { ...badge, maxWeek: parseInt(e.target.value) };
                                                                        setWeekContent({ ...weekContent, availableBadges: newBadges });
                                                                    }}
                                                                    className="input-field w-full p-2 rounded"
                                                                >
                                                                    {Array.from({ length: selectedCourse?.weeks || 16 }, (_, i) => i + 1).map(week => (
                                                                        <option key={week} value={week}>Semana {week}</option>
                                                                    ))}
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <button
                                                            onClick={() => {
                                                                const newBadges = (weekContent.availableBadges || []).filter((_, i) => i !== index);
                                                                setWeekContent({ ...weekContent, availableBadges: newBadges });
                                                            }}
                                                            className="mt-2 text-red-600 text-sm hover:text-red-800"
                                                        >
                                                            Eliminar Badge
                                                        </button>
                                                    </div>
                                                ))}
                                                <button
                                                    onClick={() => {
                                                        const newBadges = [...(weekContent.availableBadges || []), { name: '', description: '', maxWeek: 1 }];
                                                        setWeekContent({ ...weekContent, availableBadges: newBadges });
                                                    }}
                                                    className="w-full p-3 border-2 border-dashed border-gray-300 rounded text-gray-600 hover:border-gray-400 hover:text-gray-800"
                                                >
                                                    + Agregar Badge
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-bold mb-2">T√≠tulo</label>
                                            <input
                                                className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                                type="text"
                                                value={weekContent.title || ''}
                                                onChange={(e) => setWeekContent({ ...weekContent, title: e.target.value })}
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-bold mb-2">Descripci√≥n</label>
                                            <input
                                                className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                                type="text"
                                                value={weekContent.description || ''}
                                                onChange={(e) => setWeekContent({ ...weekContent, description: e.target.value })}
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-bold mb-2">Contenido</label>
                                            <textarea
                                                className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                                rows="4"
                                                value={weekContent.content || ''}
                                                onChange={(e) => setWeekContent({ ...weekContent, content: e.target.value })}
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-bold mb-2">Actividades</label>
                                            {(weekContent.activities || ['']).map((activity, index) => (
                                                <div key={index} className="flex gap-2 mb-2">
                                                    <input
                                                        className="input-field flex-1 py-2 px-3 rounded-lg focus:outline-none"
                                                        type="text"
                                                        value={activity}
                                                        onChange={(e) => {
                                                            const newActivities = [...(weekContent.activities || [''])];
                                                            newActivities[index] = e.target.value;
                                                            setWeekContent({ ...weekContent, activities: newActivities });
                                                        }}
                                                        placeholder="Actividad..."
                                                    />
                                                    <button
                                                        onClick={() => {
                                                            const newActivities = (weekContent.activities || ['']).filter((_, i) => i !== index);
                                                            setWeekContent({ ...weekContent, activities: newActivities });
                                                        }}
                                                        className="px-3 py-2 bg-red-100 text-red-600 rounded hover:bg-red-200"
                                                    >
                                                        ‚úï
                                                    </button>
                                                </div>
                                            ))}
                                            <button
                                                onClick={() => setWeekContent({ ...weekContent, activities: [...(weekContent.activities || ['']), ''] })}
                                                className="btn btn-secondary text-sm"
                                            >
                                                + Agregar Actividad
                                            </button>
                                        </div>


                                    </div>
                                )}

                                <div className="flex gap-4 mt-6">
                                    <button
                                        onClick={() => setShowEditContent(false)}
                                        className="btn btn-secondary"
                                    >
                                        Cancelar
                                    </button>
                                    <button
                                        onClick={saveWeekContent}
                                        className="btn btn-primary"
                                    >
                                        Guardar Contenido
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (showCreateCourse) {
                return (
                    <div className="min-h-screen p-4 md:p-8" style={{ backgroundColor: 'var(--bg-primary)' }}>
                        <div className="max-w-2xl mx-auto">
                            <div className="card rounded-xl p-6">
                                <h2 className="text-2xl font-bold mb-6">Crear Nuevo Curso</h2>

                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Universidad</label>
                                        <input
                                            className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                            type="text"
                                            placeholder="Nombre de la universidad"
                                            value={newCourse.university}
                                            onChange={(e) => setNewCourse({ ...newCourse, university: e.target.value })}
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-bold mb-2">Nombre del Curso</label>
                                        <input
                                            className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                            type="text"
                                            placeholder="Nombre del curso"
                                            value={newCourse.name}
                                            onChange={(e) => setNewCourse({ ...newCourse, name: e.target.value })}
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-bold mb-2">C√≥digo del Curso</label>
                                        <input
                                            className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                            type="text"
                                            placeholder="#SEMINARIO_2024"
                                            value={newCourse.code}
                                            onChange={(e) => {
                                                let value = e.target.value;
                                                if (value && !value.startsWith('#')) {
                                                    value = '#' + value;
                                                }
                                                setNewCourse({ ...newCourse, code: value });
                                            }}
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-bold mb-2">Descripci√≥n</label>
                                        <textarea
                                            className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                            rows="3"
                                            placeholder="Descripci√≥n del curso..."
                                            value={newCourse.description}
                                            onChange={(e) => setNewCourse({ ...newCourse, description: e.target.value })}
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-bold mb-2">N√∫mero de Semanas</label>
                                        <input
                                            className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                            type="number"
                                            min="1"
                                            max="20"
                                            value={newCourse.weeks}
                                            onChange={(e) => setNewCourse({ ...newCourse, weeks: parseInt(e.target.value) })}
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-bold mb-2">D√≠as y Jornada del Curso</label>
                                        <div className="flex flex-wrap gap-2">
                                            {courseDayOptions.map((dayOption) => {
                                                const isSelected = (newCourse.courseSchedule || []).some((item) => item.dayKey === dayOption.key);
                                                return (
                                                    <button
                                                        key={dayOption.key}
                                                        type="button"
                                                        onClick={() => setNewCourse({
                                                            ...newCourse,
                                                            courseSchedule: toggleScheduleDay(newCourse.courseSchedule || [], dayOption)
                                                        })}
                                                        className={`w-10 h-10 rounded-full text-sm font-bold border-2 transition-all ${isSelected
                                                            ? 'bg-blue-500 text-white border-blue-500'
                                                            : 'bg-transparent border-gray-300 text-gray-600 hover:border-blue-500 hover:text-blue-500'
                                                            }`}
                                                        title={dayOption.name}
                                                    >
                                                        {dayOption.label}
                                                    </button>
                                                );
                                            })}
                                        </div>

                                        {(newCourse.courseSchedule || []).length > 0 && (
                                            <div className="grid md:grid-cols-2 gap-3 mt-4">
                                                {normalizeCourseSchedule(newCourse.courseSchedule || []).map((scheduleItem) => (
                                                    <div key={scheduleItem.dayKey}>
                                                        <label className="block text-sm font-medium mb-1">
                                                            {scheduleItem.dayName}
                                                        </label>
                                                        <select
                                                            className="input-field w-full py-2 px-3 rounded-lg focus:outline-none"
                                                            value={scheduleItem.shift || 'DIURNO'}
                                                            onChange={(e) => setNewCourse({
                                                                ...newCourse,
                                                                courseSchedule: updateScheduleShift(newCourse.courseSchedule || [], scheduleItem.dayKey, e.target.value)
                                                            })}
                                                        >
                                                            {courseShiftOptions.map((shiftOption) => (
                                                                <option key={shiftOption} value={shiftOption}>{shiftOption}</option>
                                                            ))}
                                                        </select>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>

                                <div className="flex gap-4 mt-6">
                                    <button
                                        onClick={() => setShowCreateCourse(false)}
                                        className="btn btn-secondary"
                                    >
                                        Cancelar
                                    </button>
                                    <button
                                        onClick={createCourse}
                                        className="btn btn-primary"
                                    >
                                        Crear Curso
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen p-4 md:p-8" style={{ backgroundColor: 'var(--bg-primary)' }}>
                    <header className="card rounded-xl p-6 mb-8 animate-fadeIn">
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div className="flex-1">
                                <h1 className="text-3xl font-bold mb-2">Panel de Administraci√≥n</h1>
                                <p className="text-sm" style={{ color: 'var(--text-secondary)' }}>
                                    Profesor: {currentUser.email}
                                </p>
                                {selectedCourse && (
                                    <p className="text-xs" style={{ color: 'var(--text-secondary)' }}>
                                        Curso actual: {selectedCourse.name} ({selectedCourse.courseCode})
                                    </p>
                                )}
                            </div>
                            <div className="flex items-center gap-3">
                                <button
                                    onClick={() => setShowAttendance(true)}
                                    className="btn btn-secondary"
                                    title="Control de Asistencia"
                                    disabled={!selectedCourse}
                                >
                                    üìã
                                </button>
                                <button
                                    onClick={() => setShowProfile(true)}
                                    className="btn btn-secondary"
                                    title="Perfil de usuario"
                                >
                                    <User />
                                </button>
                                <button
                                    onClick={handleLogout}
                                    className="btn btn-secondary"
                                    title="Cerrar Sesi√≥n"
                                >
                                    Cerrar Sesi√≥n
                                </button>
                                <ThemeToggle />
                            </div>
                        </div>
                    </header>



                    {/* Pills de cursos */}
                    <div className="card rounded-xl p-6 mb-6">
                        <h2 className="text-xl font-bold mb-4">Mis Cursos</h2>
                        <div className="flex flex-wrap gap-3">
                            {courses.map(course => (
                                <div key={course.id} className="relative group">
                                    <button
                                        onClick={() => setSelectedCourse(course)}
                                        className={`px-4 py-2 rounded-full text-sm font-medium transition-all ${selectedCourse?.id === course.id
                                            ? 'bg-blue-500 text-white'
                                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                            }`}
                                    >
                                        {course.name}
                                    </button>
                                    {selectedCourse?.id === course.id && (
                                        <button
                                            onClick={() => setShowDeleteConfirm(course.id)}
                                            className="absolute -top-2 -right-2 w-5 h-5 bg-red-500 text-white rounded-full text-xs hover:bg-red-600 flex items-center justify-center"
                                            title="Eliminar curso"
                                        >
                                            √ó
                                        </button>
                                    )}
                                </div>
                            ))}
                            <button
                                onClick={() => setShowCreateCourse(true)}
                                className="px-4 py-2 rounded-full text-sm font-medium border-2 border-dashed border-blue-500 text-blue-500 hover:border-blue-600 hover:text-blue-600 transition-all bg-transparent"
                            >
                                + Crear Nuevo Curso
                            </button>
                        </div>
                        {courses.length === 0 && (
                            <p className="text-center py-8" style={{ color: 'var(--text-secondary)' }}>No tienes cursos creados a√∫n.</p>
                        )}
                    </div>

                    {selectedCourse && (
                        <div className="grid gap-6">
                            {/* Vista de contenido del curso */}
                            <div className="card rounded-xl p-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-xl font-bold">{selectedCourse.name}</h2>
                                    <button
                                        onClick={() => editWeekContent(0)}
                                        className="btn btn-secondary text-sm"
                                    >
                                        ‚úèÔ∏è Editar Informaci√≥n General
                                    </button>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                                    {Array.from({ length: selectedCourse.weeks }, (_, i) => i + 1).map(weekNum => {
                                        const weekData = selectedCourse.weeklyContent?.find(w => w.week === weekNum);
                                        return (
                                            <div key={weekNum} className="border rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer"
                                                onClick={() => {
                                                    setPreviewContent({ ...weekData, week: weekNum, title: weekData?.title || `Semana ${weekNum}` });
                                                    setShowContentPreview(true);
                                                }}>
                                                <h3 className="font-semibold text-sm mb-2">Semana {weekNum}</h3>
                                                <h4 className="font-medium mb-2 line-clamp-2">{weekData?.title || 'Sin t√≠tulo'}</h4>
                                                <p className="text-xs text-gray-600 mb-3 line-clamp-3">{weekData?.description || 'Sin descripci√≥n'}</p>
                                                <div className="flex justify-between items-center text-xs text-gray-500">
                                                    <span>{weekData?.activities?.length || 0} actividades</span>
                                                    <button
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            editWeekContent(weekNum);
                                                        }}
                                                        className="text-blue-600 hover:text-blue-800 font-medium"
                                                    >
                                                        Editar
                                                    </button>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>

                            <div className="card rounded-xl p-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-xl font-bold">Estudiantes Registrados ({students.length})</h2>
                                    <div className="flex items-center gap-4">
                                        {pendingStudents.length > 0 && (
                                            <button
                                                onClick={() => {
                                                    setShowPendingStudents(!showPendingStudents);
                                                    setShowRanking(false);
                                                }}
                                                className={`btn btn-secondary text-sm ${showPendingStudents
                                                    ? 'bg-orange-200 text-orange-900'
                                                    : 'bg-orange-100 text-orange-800 hover:bg-orange-200'
                                                    }`}
                                            >
                                                üìã {showPendingStudents ? 'Ocultar' : 'Pendientes'} ({pendingStudents.length})
                                            </button>
                                        )}
                                        <button
                                            onClick={() => {
                                                setShowRanking(!showRanking);
                                                setShowPendingStudents(false);
                                            }}
                                            className="btn btn-secondary text-sm"
                                        >
                                            {showRanking ? 'üë• Vista Normal' : 'üèÜ Ver Ranking'}
                                        </button>
                                        <div className="flex items-center gap-2">
                                            <p className="text-sm" style={{ color: 'var(--text-secondary)' }}>
                                                C√≥digo para compartir: <strong>{selectedCourse.courseCode}</strong>
                                            </p>
                                            <button
                                                onClick={() => {
                                                    setNewCourseCode(selectedCourse.courseCode);
                                                    setShowChangeCourseCode(true);
                                                }}
                                                className="text-blue-600 hover:text-blue-800 text-sm"
                                                title="Cambiar c√≥digo del curso"
                                            >
                                                ‚úèÔ∏è
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                {showPendingStudents ? (
                                    <div className="space-y-4">
                                        <div className="bg-orange-50 border border-orange-200 rounded-lg p-4">
                                            <h3 className="font-semibold text-orange-800 mb-2">Estudiantes Pendientes de Aprobaci√≥n</h3>
                                            <p className="text-sm text-orange-700 mb-4">Estos estudiantes se han registrado y esperan tu aprobaci√≥n para unirse al curso.</p>
                                        </div>
                                        {pendingStudents.map(student => (
                                            <div key={student.id} className="border rounded-lg p-4 bg-white">
                                                <div className="flex justify-between items-center">
                                                    <div>
                                                        <h4 className="font-semibold">{student.fullName}</h4>
                                                        <p className="text-sm text-gray-600">{student.email}</p>
                                                        <p className="text-xs text-gray-500">C√≥digo usado: {student.courseCode}</p>
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <button
                                                            onClick={() => approveStudent(student)}
                                                            className="px-3 py-1 bg-green-100 text-green-800 rounded hover:bg-green-200 text-sm"
                                                        >
                                                            ‚úì Aprobar
                                                        </button>
                                                        <button
                                                            onClick={() => rejectStudent(student.id)}
                                                            className="px-3 py-1 bg-red-100 text-red-800 rounded hover:bg-red-200 text-sm"
                                                        >
                                                            ‚úó Rechazar
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                ) : students.length === 0 ? (
                                    <p style={{ color: 'var(--text-secondary)' }}>No hay estudiantes registrados a√∫n.</p>
                                ) : showRanking ? (
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-sm">
                                            <thead>
                                                <tr className="border-b" style={{ borderColor: 'var(--border-color)' }}>
                                                    <th className="text-left p-3 font-semibold">#</th>
                                                    <th className="text-left p-3 font-semibold">Estudiante</th>
                                                    <th className="text-center p-3 font-semibold">Badges Ganados</th>
                                                    <th className="text-center p-3 font-semibold">Badges Asignados</th>
                                                    <th className="text-center p-3 font-semibold">Total</th>
                                                    <th className="text-left p-3 font-semibold">Detalle de Badges</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {students
                                                    .sort((a, b) => {
                                                        const aEarned = (a.badgesEarned || []).filter(badgeId => a.badgeStatus?.[badgeId] === 'earned').length;
                                                        const bEarned = (b.badgesEarned || []).filter(badgeId => b.badgeStatus?.[badgeId] === 'earned').length;
                                                        return bEarned - aEarned;
                                                    })
                                                    .map((student, index) => {
                                                        const earnedBadges = (student.badgesEarned || []).filter(badgeId => student.badgeStatus?.[badgeId] === 'earned');
                                                        const assignedBadges = (student.badgesEarned || []).filter(badgeId => student.badgeStatus?.[badgeId] === 'assigned');
                                                        return (
                                                            <tr key={student.id} className="border-b hover:bg-gray-50" style={{ borderColor: 'var(--border-color)' }}>
                                                                <td className="p-3 font-semibold">{index + 1}</td>
                                                                <td className="p-3">
                                                                    <div>
                                                                        <div className="font-medium">{student.fullName}</div>
                                                                        <div className="text-xs" style={{ color: 'var(--text-secondary)' }}>{student.email}</div>
                                                                    </div>
                                                                </td>
                                                                <td className="p-3 text-center">
                                                                    <span className="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">
                                                                        üèÜ {earnedBadges.length}
                                                                    </span>
                                                                </td>
                                                                <td className="p-3 text-center">
                                                                    <span className="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-medium">
                                                                        üî¥ {assignedBadges.length}
                                                                    </span>
                                                                </td>
                                                                <td className="p-3 text-center font-semibold">{(student.badgesEarned || []).length}</td>
                                                                <td className="p-3">
                                                                    <div className="flex flex-wrap gap-1">
                                                                        {(selectedCourse.availableBadges || []).map((badge, badgeIndex) => {
                                                                            const badgeId = `${badge.maxWeek}-${badgeIndex}`;
                                                                            const hasEarned = (student.badgesEarned || []).includes(badgeId);
                                                                            const badgeStatus = student.badgeStatus?.[badgeId];
                                                                            if (!hasEarned) return null;
                                                                            return (
                                                                                <span key={badgeId} className={`px-1 py-0.5 text-xs rounded ${badgeStatus === 'earned'
                                                                                    ? 'bg-green-100 text-green-800'
                                                                                    : 'bg-red-100 text-red-800'
                                                                                    }`}>
                                                                                    {badgeStatus === 'earned' ? 'üèÜ' : 'üî¥'} {badge.name}
                                                                                </span>
                                                                            );
                                                                        })}
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        );
                                                    })}
                                            </tbody>
                                        </table>
                                    </div>
                                ) : (
                                    <div className="space-y-4">
                                        {students.map(student => {
                                            const isExpanded = expandedStudent === student.id;
                                            return (
                                                <div key={student.id} className="border rounded-lg overflow-hidden" style={{ borderColor: 'var(--border-color)' }}>
                                                    <div
                                                        className="p-4 cursor-pointer hover:bg-gray-50 transition-colors"
                                                        onClick={() => setExpandedStudent(isExpanded ? null : student.id)}
                                                    >
                                                        <div className="flex justify-between items-center">
                                                            <div>
                                                                <h3 className="font-semibold">{student.fullName}</h3>
                                                                <p className="text-sm" style={{ color: 'var(--text-secondary)' }}>{student.email}</p>
                                                                <div className="text-sm mt-1" style={{ color: 'var(--text-secondary)' }}>
                                                                    Badges: {(student.badgesEarned || []).length}/20
                                                                </div>
                                                            </div>
                                                            <div className="flex items-center gap-2">
                                                                <button
                                                                    onClick={(e) => {
                                                                        e.stopPropagation();
                                                                        removeStudent(student.id);
                                                                    }}
                                                                    className="text-red-500 hover:text-red-700 px-2 py-1 rounded"
                                                                    title="Remover estudiante"
                                                                >
                                                                    üóëÔ∏è
                                                                </button>
                                                                <div className="text-gray-400">
                                                                    {isExpanded ? '‚ñ≤' : '‚ñº'}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    {isExpanded && (
                                                        <div className="px-4 pb-4 border-t" style={{ borderColor: 'var(--border-color)' }}>
                                                            <div className="mt-4">
                                                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                                                                    {(selectedCourse.availableBadges || []).sort((a, b) => a.maxWeek - b.maxWeek).map((badge, globalIndex) => {
                                                                        const badgeId = `${badge.maxWeek}-${globalIndex}`;
                                                                        const hasEarned = (student.badgesEarned || []).includes(badgeId);
                                                                        const badgeStatus = student.badgeStatus?.[badgeId];
                                                                        const isEarned = badgeStatus === 'earned';
                                                                        const isAssigned = badgeStatus === 'assigned';

                                                                        return (
                                                                            <div key={badgeId} className="border rounded p-2 flex flex-col">
                                                                                <div className="text-sm font-medium mb-1">{badge.name}</div>
                                                                                <div className="text-xs text-gray-600 mb-1">Semana {badge.maxWeek}</div>
                                                                                <div className="text-xs text-gray-600 mb-2 overflow-hidden" style={{
                                                                                    display: '-webkit-box',
                                                                                    WebkitLineClamp: 2,
                                                                                    WebkitBoxOrient: 'vertical'
                                                                                }}>{badge.description}</div>
                                                                                <div className="mt-auto">
                                                                                    {!hasEarned ? (
                                                                                        <div className="flex gap-1">
                                                                                            <button
                                                                                                onClick={() => assignBadge(student.id, badgeId, true)}
                                                                                                className="flex-1 px-2 py-1 bg-green-100 text-green-800 rounded text-xs hover:bg-green-200"
                                                                                            >
                                                                                                ‚úì Ganado
                                                                                            </button>
                                                                                            <button
                                                                                                onClick={() => assignBadge(student.id, badgeId, false)}
                                                                                                className="flex-1 px-2 py-1 bg-red-100 text-red-800 rounded text-xs hover:bg-red-200"
                                                                                            >
                                                                                                ‚Üí Asignar
                                                                                            </button>
                                                                                        </div>
                                                                                    ) : (
                                                                                        <button
                                                                                            onClick={() => changeBadgeStatus(student.id, badgeId, isEarned ? 'assigned' : 'earned')}
                                                                                            className={`w-full px-2 py-1 rounded text-xs hover:opacity-80 ${isEarned
                                                                                                ? 'bg-green-100 text-green-800'
                                                                                                : 'bg-red-100 text-red-800'
                                                                                                }`}
                                                                                            title={`Cambiar a ${isEarned ? 'asignado' : 'ganado'}`}
                                                                                        >
                                                                                            {isEarned ? 'üèÜ Ganado' : 'üî¥ Solo Asignado'}
                                                                                        </button>
                                                                                    )}
                                                                                </div>
                                                                            </div>
                                                                        );
                                                                    })}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Modal de Preview de Contenido */}
                    {showContentPreview && previewContent && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="card rounded-2xl max-w-4xl w-full max-h-[85vh] overflow-hidden" style={{ backgroundColor: 'var(--bg-secondary)' }}>
                                {/* Header */}
                                <div className="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-6">
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <div className="flex items-center gap-3 mb-2">
                                                <div className="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center font-bold">
                                                    {previewContent.week}
                                                </div>
                                                <h3 className="text-xl font-bold">{previewContent.title}</h3>
                                            </div>
                                            <p className="text-blue-100 text-sm">Vista previa del contenido semanal</p>
                                        </div>
                                        <button
                                            onClick={() => setShowContentPreview(false)}
                                            className="text-white hover:text-blue-200 text-2xl font-light w-8 h-8 flex items-center justify-center"
                                        >
                                            √ó
                                        </button>
                                    </div>
                                </div>

                                {/* Content */}
                                <div className="p-6 overflow-y-auto" style={{ maxHeight: 'calc(85vh - 200px)' }}>
                                    <div className="space-y-6">
                                        {/* Descripci√≥n */}
                                        <div className="bg-blue-50 rounded-xl p-4 border-l-4 border-blue-400">
                                            <div className="flex items-center gap-2 mb-3">
                                                <span className="text-blue-600 text-lg">üìù</span>
                                                <h4 className="font-semibold text-blue-800">Descripci√≥n</h4>
                                            </div>
                                            <p className="text-blue-700 leading-relaxed">{previewContent.description || 'Sin descripci√≥n'}</p>
                                        </div>

                                        {/* Contenido */}
                                        <div className="bg-green-50 rounded-xl p-4 border-l-4 border-green-400">
                                            <div className="flex items-center gap-2 mb-3">
                                                <span className="text-green-600 text-lg">üìö</span>
                                                <h4 className="font-semibold text-green-800">Contenido</h4>
                                            </div>
                                            <div className="text-green-700 leading-relaxed whitespace-pre-line">{previewContent.content || 'Sin contenido'}</div>
                                        </div>

                                        {/* Actividades */}
                                        {previewContent.activities && previewContent.activities.length > 0 && (
                                            <div className="bg-orange-50 rounded-xl p-4 border-l-4 border-orange-400">
                                                <div className="flex items-center gap-2 mb-3">
                                                    <span className="text-orange-600 text-lg">üéØ</span>
                                                    <h4 className="font-semibold text-orange-800">Actividades ({previewContent.activities.length})</h4>
                                                </div>
                                                <div className="space-y-2">
                                                    {previewContent.activities.map((activity, idx) => (
                                                        <div key={idx} className="flex items-start gap-3 p-2 bg-white rounded-lg">
                                                            <span className="text-orange-500 font-bold text-sm mt-1">{idx + 1}.</span>
                                                            <span className="text-orange-700 flex-1">{activity}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}

                                        {/* Badges */}
                                        {selectedCourse?.availableBadges?.filter(badge => badge.maxWeek === previewContent.week).length > 0 && (
                                            <div className="bg-purple-50 rounded-xl p-4 border-l-4 border-purple-400">
                                                <div className="flex items-center gap-2 mb-3">
                                                    <span className="text-purple-600 text-lg">üèÜ</span>
                                                    <h4 className="font-semibold text-purple-800">Badges Disponibles</h4>
                                                </div>
                                                <div className="grid gap-2">
                                                    {selectedCourse.availableBadges.filter(badge => badge.maxWeek === previewContent.week).map((badge, idx) => (
                                                        <div key={idx} className="bg-white rounded-lg p-3 border border-purple-200">
                                                            <div className="font-medium text-purple-800">{badge.name}</div>
                                                            <div className="text-sm text-purple-600 mt-1">{badge.description}</div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>

                                {/* Footer */}
                                <div className="border-t p-4 bg-gray-50 flex justify-end gap-3">
                                    <button
                                        onClick={() => setShowContentPreview(false)}
                                        className="btn btn-secondary"
                                    >
                                        Cerrar
                                    </button>
                                    <button
                                        onClick={() => {
                                            setShowContentPreview(false);
                                            editWeekContent(previewContent.week);
                                        }}
                                        className="btn btn-primary"
                                    >
                                        ‚úèÔ∏è Editar
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    <footer className="mt-8 text-center text-xs" style={{ color: 'var(--text-secondary)' }}>
                        Developed by<br />Leandro Fl√≥rez-Aristiz√°bal, Ph.D
                    </footer>
                </div>
            );
        }

        function CoursePage({ currentUser }) {
            const auth = firebase.auth();
            const db = firebase.firestore();
            const toast = useToast();
            const { theme } = useTheme();
            const isDarkMode = theme === 'dark';
            const [userData, setUserData] = React.useState(null);
            const [loading, setLoading] = React.useState(true);
            const [expandedWeek, setExpandedWeek] = React.useState(null);
            const [professorName, setProfessorName] = React.useState('');
            const [dynamicContent, setDynamicContent] = React.useState([]);
            const [courseInfo, setCourseInfo] = React.useState(null);
            const [courses, setCourses] = React.useState([]);
            const [selectedCourse, setSelectedCourse] = React.useState(null);
            const [showProfile, setShowProfile] = React.useState(false);
            const [showStudentCurrentPassword, setShowStudentCurrentPassword] = React.useState(false);
            const [showStudentNewPassword, setShowStudentNewPassword] = React.useState(false);
            const [showJoinCourse, setShowJoinCourse] = React.useState(false);
            const [joinCourseCode, setJoinCourseCode] = React.useState('');
            const [showQRScanner, setShowQRScanner] = React.useState(false);
            const [forceShowQR, setForceShowQR] = React.useState(false);
            const [showQRTimeWarning, setShowQRTimeWarning] = React.useState(false);
            const scannerRef = React.useRef(null);
            const [qrZoomSupported, setQrZoomSupported] = React.useState(false);
            const [qrZoomValue, setQrZoomValue] = React.useState(1);
            const [qrZoomMin, setQrZoomMin] = React.useState(1);
            const [qrZoomMax, setQrZoomMax] = React.useState(1);
            const [qrZoomStep, setQrZoomStep] = React.useState(0.1);
            const [qrNativeZoomMax, setQrNativeZoomMax] = React.useState(1);
            const [qrScannerErrorDetail, setQrScannerErrorDetail] = React.useState('');
            const [qrScannerAttemptLogs, setQrScannerAttemptLogs] = React.useState([]);
            const qrScannerStartInProgressRef = React.useRef(false);
            const pinchStartDistanceRef = React.useRef(null);
            const pinchStartZoomRef = React.useRef(1);
            const [profileData, setProfileData] = React.useState({
                fullName: '',
                currentPassword: '',
                newPassword: '',
                confirmPassword: ''
            });

            const getTouchDistance = (touches) => {
                if (!touches || touches.length < 2) {
                    return 0;
                }

                const [firstTouch, secondTouch] = touches;
                const deltaX = firstTouch.clientX - secondTouch.clientX;
                const deltaY = firstTouch.clientY - secondTouch.clientY;
                return Math.hypot(deltaX, deltaY);
            };

            const clampQRZoom = (zoomLevel) => {
                return Math.min(qrZoomMax, Math.max(qrZoomMin, zoomLevel));
            };

            const appendQRLog = (message) => {
                const now = new Date().toLocaleTimeString();
                const line = `[${now}] ${message}`;
                console.log('[QR-SCANNER]', line);
                setQrScannerAttemptLogs((prevLogs) => [...prevLogs, line]);
            };

            const formatQRError = (error) => {
                if (!error) {
                    return 'Error desconocido';
                }

                if (typeof error === 'string') {
                    return error;
                }

                const errorName = error?.name || 'Error';
                const errorMessage = error?.message || error?.toString?.() || 'Sin mensaje';
                return `${errorName}: ${errorMessage}`;
            };

            const applyQRZoom = async (zoomLevel) => {
                if (!scannerRef.current || !qrZoomSupported) {
                    return;
                }

                try {
                    const nativeMax = Math.max(1, qrNativeZoomMax);
                    const nativeZoomLevel = Math.min(zoomLevel, nativeMax);
                    const digitalScale = Math.max(1, zoomLevel / nativeZoomLevel);

                    if (nativeMax > 1) {
                        await scannerRef.current.applyVideoConstraints({
                            advanced: [{ zoom: nativeZoomLevel }]
                        });
                    }

                    const videoElement = document.querySelector('#qr-reader video');
                    if (videoElement) {
                        videoElement.style.transformOrigin = 'center center';
                        videoElement.style.transform = `scale(${digitalScale})`;
                    }
                } catch (error) {
                    console.error('Error aplicando zoom de c√°mara:', error);
                }
            };

            const handleQRZoomChange = async (zoomLevel) => {
                const numericZoom = Number(zoomLevel);
                const clampedZoom = clampQRZoom(numericZoom);
                setQrZoomValue(clampedZoom);
                await applyQRZoom(clampedZoom);
            };

            const handleQRPinchStart = (event) => {
                if (!qrZoomSupported || event.touches.length !== 2) {
                    return;
                }

                event.preventDefault();
                pinchStartDistanceRef.current = getTouchDistance(event.touches);
                pinchStartZoomRef.current = qrZoomValue;
            };

            const handleQRPinchMove = async (event) => {
                if (!qrZoomSupported || event.touches.length !== 2 || !pinchStartDistanceRef.current) {
                    return;
                }

                event.preventDefault();

                const currentDistance = getTouchDistance(event.touches);
                if (!currentDistance) {
                    return;
                }

                const scaleFactor = currentDistance / pinchStartDistanceRef.current;
                const targetZoom = pinchStartZoomRef.current * scaleFactor;
                const clampedTargetZoom = clampQRZoom(targetZoom);

                if (Math.abs(clampedTargetZoom - qrZoomValue) >= Math.max(qrZoomStep, 0.05)) {
                    setQrZoomValue(clampedTargetZoom);
                    await applyQRZoom(clampedTargetZoom);
                }
            };

            const handleQRPinchEnd = () => {
                pinchStartDistanceRef.current = null;
            };

            const handleJoinCourse = async (e) => {
                e.preventDefault();
                if (!joinCourseCode.startsWith('#')) {
                    toast.showToast('El c√≥digo debe comenzar con #', 'error');
                    return;
                }

                try {
                    // Verificar si ya est√° pendiente con este c√≥digo
                    const tempStudentDoc = await db.doc(`artifacts/seminario-investigacion-app/temp-students/${currentUser.uid}`).get();
                    if (tempStudentDoc.exists && tempStudentDoc.data().courseCode === joinCourseCode) {
                        toast.showToast('Ya tienes una solicitud pendiente para este curso', 'error');
                        return;
                    }

                    // Verificar si ya est√° aprobado en alg√∫n curso con este c√≥digo
                    const professorsSnapshot = await db.collection('artifacts/seminario-investigacion-app/professors').get();

                    for (const professorDoc of professorsSnapshot.docs) {
                        const coursesSnapshot = await db.collection(`artifacts/seminario-investigacion-app/professors/${professorDoc.id}/courses`)
                            .where('courseCode', '==', joinCourseCode)
                            .get();

                        for (const courseDoc of coursesSnapshot.docs) {
                            const studentDoc = await db.doc(`artifacts/seminario-investigacion-app/professors/${professorDoc.id}/courses/${courseDoc.id}/students/${currentUser.uid}`).get();

                            if (studentDoc.exists) {
                                toast.showToast('Ya est√°s registrado en este curso', 'error');
                                return;
                            }
                        }
                    }

                    await db.doc(`artifacts/seminario-investigacion-app/temp-students/${currentUser.uid}`)
                        .set({
                            email: currentUser.email,
                            fullName: userData?.fullName || currentUser.email.split('@')[0],
                            userType: 'student',
                            courseCode: joinCourseCode,
                            badgesEarned: [],
                            lastBadgeEarned: null,
                            createdAt: new Date()
                        });

                    toast.showToast('Solicitud enviada. Espera la aprobaci√≥n del profesor.', 'success');
                    setShowJoinCourse(false);
                    setJoinCourseCode('');
                    loadCourseData();
                } catch (error) {
                    console.error('Error uni√©ndose al curso:', error);
                    toast.showToast('Error enviando solicitud', 'error');
                }
            };

            const handleUpdateProfile = async (e) => {
                e.preventDefault();

                try {
                    if (profileData.newPassword) {
                        if (profileData.newPassword !== profileData.confirmPassword) {
                            toast.showToast('Las contrase√±as no coinciden', 'error');
                            return;
                        }

                        const credential = firebase.auth.EmailAuthProvider.credential(
                            currentUser.email,
                            profileData.currentPassword
                        );
                        await currentUser.reauthenticateWithCredential(credential);
                        await currentUser.updatePassword(profileData.newPassword);
                        toast.showToast('Contrase√±a actualizada', 'success');
                    }

                    if (profileData.fullName && profileData.fullName !== userData?.fullName) {
                        const tempDoc = await db.doc(`artifacts/seminario-investigacion-app/temp-students/${currentUser.uid}`).get();
                        if (tempDoc.exists) {
                            await db.doc(`artifacts/seminario-investigacion-app/temp-students/${currentUser.uid}`)
                                .update({ fullName: profileData.fullName });
                        }
                        toast.showToast('Nombre actualizado', 'success');
                    }

                    setShowProfile(false);
                    setProfileData({ fullName: '', currentPassword: '', newPassword: '', confirmPassword: '' });
                    loadCourseData();
                } catch (error) {
                    if (error.code === 'auth/wrong-password') {
                        toast.showToast('Contrase√±a actual incorrecta', 'error');
                    } else {
                        toast.showToast('Error actualizando perfil', 'error');
                    }
                }
            };

            const startQRScanner = (forceShow = false) => {
                // Verificar si es la hora correcta
                console.log('\n=== QR SCANNER ATTEMPT ===');
                console.log('selectedCourse completo:', selectedCourse);
                console.log('courseInfo:', courseInfo);
                console.log('courses:', courses);

                if (!selectedCourse) {
                    console.log('‚ùå FALLO: selectedCourse es null/undefined');
                    console.log('=== QR SCANNER ATTEMPT END ===\n');
                    toast.showToast('Por favor selecciona un curso primero', 'error');
                    return;
                }

                if (!selectedCourse.courseSchedule) {
                    console.log('‚ùå FALLO CR√çTICO: selectedCourse.courseSchedule NO EXISTE');
                    console.log('Claves disponibles en selectedCourse:', Object.keys(selectedCourse));
                    console.log('=== QR SCANNER ATTEMPT END ===\n');
                    toast.showToast('El curso no tiene horario configurado', 'error');
                    return;
                }

                const isCorrectTime = isCurrentClassTime(selectedCourse);
                console.log('Resultado de validaci√≥n de hora:', isCorrectTime);
                console.log('forceShow:', forceShow);

                if (!isCorrectTime && !forceShow) {
                    console.log('‚ö†Ô∏è Bloqueada apertura de c√°mara. Mostrando modal de advertencia.');
                    console.log('=== QR SCANNER ATTEMPT END ===\n');
                    setShowQRTimeWarning(true);
                    return;
                }

                if (qrScannerStartInProgressRef.current) {
                    appendQRLog('Inicio ignorado: el esc√°ner ya est√° arrancando.');
                    return;
                }

                console.log('‚úÖ Abriendo QR scanner');
                console.log('=== QR SCANNER ATTEMPT END ===\n');
                qrScannerStartInProgressRef.current = true;
                setShowQRScanner(true);
                setQrZoomSupported(false);
                setQrZoomValue(1);
                setQrZoomMin(1);
                setQrZoomMax(1);
                setQrZoomStep(0.1);
                setQrNativeZoomMax(1);
                setQrScannerErrorDetail('');
                setQrScannerAttemptLogs([]);
                // NO hacer console.clear() aqu√≠ para mantener los logs de validaci√≥n
                console.log('[QR-SCANNER] Iniciando diagn√≥stico de c√°mara...');
                pinchStartDistanceRef.current = null;
                pinchStartZoomRef.current = 1;

                setTimeout(async () => {
                    try {
                        if (scannerRef.current) {
                            appendQRLog('Liberando instancia anterior del esc√°ner...');
                            try {
                                await scannerRef.current.stop();
                            } catch (stopError) {
                                appendQRLog(`Stop previo omitido: ${formatQRError(stopError)}`);
                            }
                            try {
                                await scannerRef.current.clear();
                            } catch (clearError) {
                                appendQRLog(`Clear previo omitido: ${formatQRError(clearError)}`);
                            }
                            scannerRef.current = null;
                        }

                        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                            throw new Error('Este navegador no soporta acceso a c√°mara (mediaDevices).');
                        }

                        if (!window.isSecureContext && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                            throw new Error('La c√°mara requiere HTTPS. En m√≥vil usa https:// o localhost seguro.');
                        }

                        const scanConfig = {
                            fps: 15,
                            qrbox: { width: 280, height: 280 },
                            aspectRatio: 1
                        };

                        const cameraConstraintsFallback = [
                            {
                                facingMode: "environment",
                                width: { ideal: 1920 },
                                height: { ideal: 1080 },
                                advanced: [{ focusMode: "continuous" }]
                            },
                            {
                                facingMode: { ideal: "environment" },
                                width: { ideal: 1280 },
                                height: { ideal: 720 }
                            },
                            { facingMode: "environment" },
                            { facingMode: { ideal: "user" } }
                        ];

                        let startError = null;
                        let started = false;

                        for (let index = 0; index < cameraConstraintsFallback.length; index++) {
                            const cameraConfig = cameraConstraintsFallback[index];
                            const html5QrCode = new Html5Qrcode("qr-reader");
                            appendQRLog(`Intento ${index + 1}: ${JSON.stringify(cameraConfig)}`);

                            try {
                                await html5QrCode.start(
                                    cameraConfig,
                                    scanConfig,
                                    async (decodedText) => {
                                        try {
                                            const qrData = JSON.parse(decodedText);

                                            if (qrData.courseId && qrData.date && qrData.professorId) {
                                                await registerAttendance(qrData);
                                                html5QrCode.stop().finally(() => {
                                                    setShowQRScanner(false);
                                                });
                                            } else {
                                                toast.showToast('QR inv√°lido', 'error');
                                            }
                                        } catch (error) {
                                            console.error('Error procesando QR:', error);
                                        }
                                    }
                                );
                                started = true;
                                scannerRef.current = html5QrCode;
                                appendQRLog(`Intento ${index + 1}: c√°mara iniciada correctamente`);
                                break;
                            } catch (err) {
                                startError = err;
                                appendQRLog(`Intento ${index + 1}: ${formatQRError(err)}`);
                                try {
                                    await html5QrCode.clear();
                                } catch (clearError) {
                                    appendQRLog(`Intento ${index + 1}: clear omitido (${formatQRError(clearError)})`);
                                }
                            }
                        }

                        if (!started) {
                            throw startError || new Error('No se pudo iniciar la c√°mara');
                        }

                        const activeScanner = scannerRef.current;
                        setQrZoomSupported(true);
                        setQrZoomMin(1);
                        setQrZoomMax(20);
                        setQrZoomStep(0.5);
                        setQrZoomValue(1);

                        if (activeScanner && typeof activeScanner.getRunningTrackCapabilities === 'function') {
                            const capabilities = activeScanner.getRunningTrackCapabilities();
                            if (capabilities && capabilities.zoom) {
                                const minZoom = typeof capabilities.zoom.min === 'number' ? capabilities.zoom.min : 1;
                                const maxZoom = typeof capabilities.zoom.max === 'number' ? capabilities.zoom.max : 1;
                                const stepZoom = typeof capabilities.zoom.step === 'number' && capabilities.zoom.step > 0 ? capabilities.zoom.step : 0.1;
                                const initialZoom = Math.max(minZoom, 1);

                                setQrNativeZoomMax(maxZoom);
                                setQrZoomStep(Math.max(0.5, stepZoom));
                                setQrZoomValue(initialZoom);
                                appendQRLog(`Zoom nativo soportado: min ${minZoom}, max ${maxZoom}, step ${stepZoom}. Zoom total habilitado hasta 20x (h√≠brido).`);

                                try {
                                    await activeScanner.applyVideoConstraints({
                                        advanced: [{ zoom: initialZoom }]
                                    });
                                    appendQRLog(`Zoom inicial aplicado: ${initialZoom.toFixed(1)}x`);
                                } catch (zoomError) {
                                    console.error('Zoom no soportado en este dispositivo:', zoomError);
                                    appendQRLog(`No se pudo aplicar zoom inicial: ${zoomError?.name || 'Error'} - ${zoomError?.message || 'Sin mensaje'}`);
                                }
                            } else {
                                setQrNativeZoomMax(1);
                                appendQRLog('Este dispositivo no expone zoom nativo. Se usa zoom digital hasta 20x.');
                            }
                        }
                    } catch (err) {
                        console.error('Error iniciando esc√°ner:', err);
                        const fullError = formatQRError(err);
                        setQrScannerErrorDetail(fullError);
                        appendQRLog(`Fallo final: ${fullError}`);
                        toast.showToast('Error de c√°mara', 'error');
                        scannerRef.current = null;
                        appendQRLog('El modal permanece abierto para revisar diagn√≥stico y reintentar.');
                    } finally {
                        qrScannerStartInProgressRef.current = false;
                    }
                }, 100);
            };

            const stopQRScanner = () => {
                qrScannerStartInProgressRef.current = false;
                if (scannerRef.current) {
                    scannerRef.current.stop().then(() => {
                        scannerRef.current = null;
                        const videoElement = document.querySelector('#qr-reader video');
                        if (videoElement) {
                            videoElement.style.transform = 'scale(1)';
                        }
                        setQrScannerErrorDetail('');
                        setQrScannerAttemptLogs([]);
                        pinchStartDistanceRef.current = null;
                        pinchStartZoomRef.current = 1;
                        setShowQRScanner(false);
                    }).catch(err => {
                        console.error('Error deteniendo esc√°ner:', err);
                        scannerRef.current = null;
                        const videoElement = document.querySelector('#qr-reader video');
                        if (videoElement) {
                            videoElement.style.transform = 'scale(1)';
                        }
                        setQrScannerErrorDetail('');
                        setQrScannerAttemptLogs([]);
                        pinchStartDistanceRef.current = null;
                        pinchStartZoomRef.current = 1;
                        setShowQRScanner(false);
                    });
                } else {
                    setQrScannerErrorDetail('');
                    setQrScannerAttemptLogs([]);
                    pinchStartDistanceRef.current = null;
                    pinchStartZoomRef.current = 1;
                    setShowQRScanner(false);
                }
            };

            const registerAttendance = async (qrData) => {
                try {
                    // Verificar que el estudiante est√© matriculado en el curso
                    const professorCoursesRef = db.collection(`artifacts/seminario-investigacion-app/professors/${qrData.professorId}/courses/${qrData.courseId}/students`);
                    const studentDoc = await professorCoursesRef.doc(currentUser.uid).get();

                    if (!studentDoc.exists) {
                        toast.showToast('No est√°s matriculado en este curso', 'error');
                        return;
                    }

                    const attendanceRef = db.doc(`artifacts/seminario-investigacion-app/courses/${qrData.courseId}/attendance/${qrData.date}`);
                    const attendanceDoc = await attendanceRef.get();

                    const studentData = {
                        studentId: currentUser.uid,
                        studentName: userData?.fullName || currentUser.email,
                        timestamp: new Date()
                    };

                    if (attendanceDoc.exists) {
                        const existingData = attendanceDoc.data();
                        const students = existingData.students || [];

                        if (students.some(s => s.studentId === currentUser.uid)) {
                            toast.showToast('Ya registraste tu asistencia hoy', 'info');
                            return;
                        }

                        await attendanceRef.update({
                            students: [...students, studentData]
                        });
                    } else {
                        await attendanceRef.set({
                            date: qrData.date,
                            courseId: qrData.courseId,
                            students: [studentData]
                        });
                    }

                    toast.showToast('¬°Asistencia registrada exitosamente!', 'success');
                } catch (error) {
                    console.error('Error registrando asistencia:', error);
                    toast.showToast('Error registrando asistencia', 'error');
                }
            };

            const getShiftForHour = (hour) => {
                if (hour >= 6 && hour < 12) return 'DIURNO';
                if (hour >= 12 && hour < 18) return 'TARDE';
                if (hour >= 18 && hour < 22) return 'NOCTURNO';
                return null;
            };

            const getDefaultCourseForNow = (coursesArray = []) => {
                if (coursesArray.length === 0) return null;

                const now = new Date();
                const dayOfWeek = now.getDay();
                const hour = now.getHours();
                const currentShift = getShiftForHour(hour);

                const dayKeys = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
                const currentDayKey = dayKeys[dayOfWeek];

                // 1. Buscar curso de HOY con JORNADA ACTUAL
                if (currentShift) {
                    const todayMatchingShift = coursesArray.find((course) => {
                        const schedule = (course.courseSchedule || []);
                        return schedule.some((item) => item.dayKey === currentDayKey && item.shift === currentShift);
                    });
                    if (todayMatchingShift) return todayMatchingShift;
                }

                // 2. Buscar cualquier curso de HOY (sin importar jornada)
                const todayAny = coursesArray.find((course) => {
                    const schedule = (course.courseSchedule || []);
                    return schedule.some((item) => item.dayKey === currentDayKey);
                });
                if (todayAny) return todayAny;

                // 3. Buscar primer curso para jornada actual de cualquier d√≠a
                if (currentShift) {
                    const anyMatchingShift = coursesArray.find((course) => {
                        const schedule = (course.courseSchedule || []);
                        return schedule.some((item) => item.shift === currentShift);
                    });
                    if (anyMatchingShift) return anyMatchingShift;
                }

                // 4. Devolver el primer curso disponible
                return coursesArray[0];
            };

            const isCurrentClassTime = (course) => {
                const now = new Date();
                const dayOfWeek = now.getDay();
                const hour = now.getHours();
                const time = now.toLocaleTimeString();

                console.log(`\n=== VALIDATION START ===`);
                console.log(`Hora actual: ${time} (${hour}:00)`);
                console.log(`D√≠a: ${dayOfWeek} (SUN=0, SAT=6)`);

                if (!course) {
                    console.log('‚ùå FALLO: No hay curso seleccionado');
                    console.log(`=== VALIDATION END ===\n`);
                    return false;
                }

                if (!course.courseSchedule || course.courseSchedule.length === 0) {
                    console.log('‚ùå FALLO: El curso no tiene horario configurado');
                    console.log(`=== VALIDATION END ===\n`);
                    return false;
                }

                const dayKeys = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
                const currentDayKey = dayKeys[dayOfWeek];
                const currentShift = getShiftForHour(hour);

                console.log(`Curso: ${course.name}`);
                console.log(`Horario del curso:`, course.courseSchedule);
                console.log(`D√≠a de hoy: ${currentDayKey}`);
                console.log(`Jornada actual: ${currentShift}`);

                // Si no hay jornada activa, NO permitir QR
                if (!currentShift) {
                    console.log(`‚ùå BLOQUEADO: Fuera de horario (${hour}:00 no entra en ninguna jornada)`);
                    console.log(`=== VALIDATION END ===\n`);
                    return false;
                }

                // Verificar si el curso est√° programado para hoy
                const todaySchedule = course.courseSchedule.find((item) => item.dayKey === currentDayKey);

                if (!todaySchedule) {
                    const scheduledDays = course.courseSchedule.map(s => `${s.dayName} (${s.shift})`).join(', ');
                    console.log(`‚ùå BLOQUEADO: El curso se da en: ${scheduledDays}, pero hoy es ${currentDayKey}`);
                    console.log(`=== VALIDATION END ===\n`);
                    return false;
                }

                // Verificar si la jornada actual coincide
                if (todaySchedule.shift === currentShift) {
                    console.log(`‚úÖ PERMITIDO: Es ${currentDayKey} y la jornada es ${currentShift}`);
                    console.log(`=== VALIDATION END ===\n`);
                    return true;
                }

                console.log(`‚ùå BLOQUEADO: Es ${currentDayKey} pero la jornada esperada es ${todaySchedule.shift}, no ${currentShift}`);
                console.log(`=== VALIDATION END ===\n`);
                return false;
            };

            React.useEffect(() => {
                loadUserData();
                loadCourseData();
            }, []);

            React.useEffect(() => {
                if (selectedCourse) {
                    loadCourseContent(selectedCourse);
                }
            }, [selectedCourse]);

            const loadUserData = async () => {
                // Los datos del usuario se cargar√°n junto con los datos del curso
                setLoading(false);
            };

            const loadCourseData = async () => {
                try {
                    // Primero verificar si est√° en temp-students
                    const tempStudentDoc = await db.doc(`artifacts/seminario-investigacion-app/temp-students/${currentUser.uid}`).get();

                    if (tempStudentDoc.exists) {
                        // Estudiante pendiente de aprobaci√≥n
                        const tempData = tempStudentDoc.data();
                        setUserData({ ...tempData, isPending: true });
                        setProfessorName('Pendiente de aprobaci√≥n');
                        return;
                    }

                    // Buscar en todos los profesores para encontrar TODOS los cursos del estudiante
                    const professorsSnapshot = await db.collection('artifacts/seminario-investigacion-app/professors').get();
                    const studentCourses = [];

                    for (const professorDoc of professorsSnapshot.docs) {
                        const coursesSnapshot = await db.collection(`artifacts/seminario-investigacion-app/professors/${professorDoc.id}/courses`).get();

                        for (const courseDoc of coursesSnapshot.docs) {
                            const studentDoc = await db.doc(`artifacts/seminario-investigacion-app/professors/${professorDoc.id}/courses/${courseDoc.id}/students/${currentUser.uid}`).get();

                            if (studentDoc.exists) {
                                const courseData = courseDoc.data();
                                studentCourses.push({
                                    id: courseDoc.id,
                                    professorId: professorDoc.id,
                                    studentData: studentDoc.data(),
                                    ...courseData
                                });
                            }
                        }
                    }

                    if (studentCourses.length > 0) {
                        setCourses(studentCourses);

                        // Si no hay curso seleccionado, usar l√≥gica inteligente
                        if (!selectedCourse) {
                            const defaultCourse = getDefaultCourseForNow(studentCourses);
                            console.log('[LOAD-COURSES] Estableciendo curso por defecto:', {
                                name: defaultCourse?.name,
                                schedule: defaultCourse?.courseSchedule
                            });
                            setSelectedCourse(defaultCourse);
                        }

                        setUserData(studentCourses[0].studentData);
                    }

                } catch (error) {
                    console.error('Error cargando datos del curso:', error);
                    setProfessorName('Error cargando');
                }
            };

            const loadCourseContent = async (course) => {
                try {
                    if (!course) return;

                    setUserData(course.studentData);
                    setProfessorName(course.professorName || 'No asignado');
                    setCourseInfo(course);

                    // Crear contenido din√°mico
                    const contentArray = [];

                    contentArray.push({
                        id: 'info',
                        type: 'info',
                        title: 'Informaci√≥n General del Curso',
                        description: 'Datos del curso y badges disponibles',
                        unlocked: true
                    });

                    for (let i = 1; i <= course.weeks; i++) {
                        const weekData = course.weeklyContent?.find(w => w.week === i);
                        const weekBadges = course.availableBadges?.filter(badge => badge.maxWeek === i) || [];
                        contentArray.push({
                            id: i,
                            week: i,
                            title: weekData?.title || `Semana ${i}`,
                            description: weekData?.description || 'Contenido por definir',
                            content: weekData?.content || '',
                            activities: weekData?.activities || [],
                            badges: weekBadges,
                            unlocked: i === 1
                        });
                    }

                    setDynamicContent(contentArray);
                } catch (error) {
                    console.error('Error cargando contenido del curso:', error);
                }
            };

            const handleLogout = async () => {
                try {
                    await auth.signOut();
                    toast.showToast('¬°Hasta luego!', 'success');
                } catch (err) {
                    toast.showToast("Error al cerrar sesi√≥n. Intenta de nuevo.", 'error');
                }
            };

            const getBadgeStatus = (badgeId) => {
                if (!userData || !userData.badgesEarned) return false;
                return userData.badgesEarned.includes(badgeId);
            };

            const getBadgeStatusType = (badgeId) => {
                if (!userData || !userData.badgeStatus) return null;
                return userData.badgeStatus[badgeId] || null;
            };

            const getProgressPercentage = () => {
                if (!userData || !userData.badgesEarned) return 0;
                return Math.round((userData.badgesEarned.length / 20) * 100);
            };

            const isContentUnlocked = (content) => {
                if (content.unlocked) return true;
                // Cada semana se desbloquea si todas las semanas anteriores tienen todos sus badges ganados
                if (content.week && content.week > 1) {
                    for (let week = 1; week < content.week; week++) {
                        const weekBadges = dynamicContent.find(c => c.week === week)?.badges || [];
                        if (weekBadges.length === 0) continue; // Si no hay badges, continuar
                        const hasAllBadges = weekBadges.every((badge, index) => {
                            // Encontrar el √≠ndice global del badge en availableBadges
                            const globalIndex = courseInfo?.availableBadges?.findIndex(b => b.name === badge.name && b.maxWeek === week) ?? index;
                            const badgeId = `${week}-${globalIndex}`;
                            return getBadgeStatus(badgeId);
                        });
                        if (!hasAllBadges) {
                            return false; // Si no tiene todos los badges de alguna semana anterior, bloquear
                        }
                    }
                    return true;
                }
                return true;
            };

            if (loading) {
                return <LoadingSpinner />;
            }

            if (userData?.isPending) {
                return (
                    <div className="min-h-screen p-4 md:p-8" style={{ backgroundColor: 'var(--bg-primary)' }}>
                        <div className="max-w-2xl mx-auto">
                            <div className="card rounded-xl p-8 text-center">
                                <div className="mb-6">
                                    <div className="w-20 h-20 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <span className="text-3xl">‚è≥</span>
                                    </div>
                                    <h1 className="text-2xl font-bold mb-2">Registro Pendiente</h1>
                                    <p className="text-lg" style={{ color: 'var(--text-secondary)' }}>
                                        Hola, <strong>{userData.fullName}</strong>
                                    </p>
                                </div>

                                <div className="bg-orange-50 border border-orange-200 rounded-lg p-6 mb-6">
                                    <h2 className="font-semibold text-orange-800 mb-2">Tu registro est√° siendo revisado</h2>
                                    <p className="text-orange-700 mb-4">
                                        Te has registrado exitosamente con el c√≥digo <strong>{userData.courseCode}</strong>.
                                        El profesor debe aprobar tu solicitud antes de que puedas acceder al contenido del curso.
                                    </p>
                                    <p className="text-sm text-orange-600">
                                        Recibir√°s acceso una vez que el profesor apruebe tu registro.
                                        Puedes cerrar esta p√°gina y volver m√°s tarde.
                                    </p>
                                </div>

                                <div className="flex justify-center gap-3">
                                    <ThemeToggle />
                                    <button
                                        onClick={handleLogout}
                                        className="btn btn-secondary"
                                    >
                                        Cerrar Sesi√≥n
                                    </button>
                                </div>
                            </div>
                        </div>
                        <footer className="mt-8 text-center text-xs" style={{ color: 'var(--text-secondary)' }}>
                            Developed by<br />Leandro Fl√≥rez-Aristiz√°bal, Ph.D
                        </footer>
                    </div>
                );
            }

            return (
                <div className="min-h-screen p-4 md:p-8" style={{ backgroundColor: 'var(--bg-primary)' }}>
                    <header className="card rounded-xl p-6 mb-8 animate-fadeIn">
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div className="flex-1">
                                <h1 className="text-3xl font-bold mb-2" style={{ color: 'var(--text-primary)' }}>
                                    {courseInfo?.name || 'Cargando...'}
                                </h1>

                                {courses.length > 1 && (
                                    <div className="mb-4 flex flex-wrap gap-2">
                                        {courses.map((course, index) => (
                                            <button
                                                key={course.id}
                                                onClick={() => setSelectedCourse(course)}
                                                className={`px-4 py-2 rounded-full text-sm font-semibold transition-all ${selectedCourse?.id === course.id
                                                    ? 'bg-blue-500 text-white'
                                                    : 'bg-gray-200 text-gray-800 hover:bg-gray-300'
                                                    }`}
                                            >
                                                {course.name}
                                            </button>
                                        ))}
                                    </div>
                                )}

                                <div className="flex items-center gap-2 text-sm" style={{ color: 'var(--text-secondary)' }}>
                                    <User />
                                    <span>Hola, <strong>{userData?.fullName || currentUser.email.split('@')[0]}</strong></span>
                                </div>
                                <div className="mt-2">
                                    <div className="flex items-center gap-2 text-sm" style={{ color: 'var(--text-secondary)' }}>
                                        <span>Progreso: {getProgressPercentage()}% ({userData?.badgesEarned?.length || 0}/20 badges)</span>
                                    </div>
                                    <div className="w-full bg-gray-200 rounded-full h-2 mt-1">
                                        <div
                                            className="h-2 rounded-full transition-all duration-300"
                                            style={{
                                                width: `${getProgressPercentage()}%`,
                                                background: 'linear-gradient(90deg, #ef4444 0%, #f97316 25%, #eab308 50%, #22c55e 75%, #3b82f6 100%)'
                                            }}
                                        ></div>
                                    </div>
                                </div>
                            </div>
                            <div className="flex items-center gap-3">
                                <button
                                    onClick={() => setShowJoinCourse(true)}
                                    className="btn btn-secondary"
                                    title="Unirse a un curso"
                                >
                                    +
                                </button>
                                <button
                                    onClick={() => startQRScanner(false)}
                                    className="btn btn-secondary"
                                    title="Registrar asistencia"
                                >
                                    üì∑
                                </button>
                                <button
                                    onClick={() => setShowProfile(true)}
                                    className="btn btn-secondary"
                                    title="Perfil de usuario"
                                >
                                    <User />
                                </button>
                                <button
                                    onClick={handleLogout}
                                    className="btn btn-secondary"
                                    title="Cerrar sesi√≥n"
                                >
                                    Cerrar Sesi√≥n
                                </button>
                                <ThemeToggle />
                            </div>
                        </div>
                    </header>

                    {showQRTimeWarning && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="card rounded-xl p-6 w-full max-w-md">
                                <div className="flex items-start gap-3 mb-4">
                                    <div className="text-4xl">üïê</div>
                                    <div>
                                        <h3 className="text-lg font-bold">No es la hora de clase</h3>
                                        <p className="text-sm mt-1" style={{ color: 'var(--text-secondary)' }}>
                                            Est√°s intentando escanear en un horario distinto al programado.
                                        </p>
                                    </div>
                                </div>

                                <div className="bg-red-50 border border-red-200 rounded-lg p-3 mb-4">
                                    <p className="text-sm font-semibold text-red-900 mb-2">‚è∞ Hora actual:</p>
                                    <p className="text-lg font-bold text-red-700">{new Date().toLocaleTimeString()}</p>
                                </div>

                                {selectedCourse?.courseSchedule && (
                                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                                        <p className="text-sm font-semibold text-blue-900 mb-2">üìÖ Horario de tu clase:</p>
                                        <div className="text-sm text-blue-800 space-y-1">
                                            {selectedCourse.courseSchedule.map((item, idx) => (
                                                <div key={idx} className="flex justify-between items-center">
                                                    <span className="font-medium">{item.dayName}</span>
                                                    <span className="bg-blue-200 text-blue-900 px-2 py-1 rounded text-xs font-bold">{item.shift}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                <p className="text-sm text-gray-600 mb-4">
                                    üîì Puedes escanear igualmente si lo necesitas, pero recuerda que puede indicar asistencia en la hora incorrecta.
                                </p>

                                <div className="flex gap-3">
                                    <button
                                        onClick={() => setShowQRTimeWarning(false)}
                                        className="btn btn-secondary flex-1"
                                    >
                                        Cancelar
                                    </button>
                                    <button
                                        onClick={() => {
                                            setShowQRTimeWarning(false);
                                            startQRScanner(true);
                                        }}
                                        className="btn btn-primary flex-1"
                                    >
                                        Escanear
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showQRScanner && (
                        <div className="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4">
                            <div className="card rounded-xl p-6 w-full max-w-md">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-bold">Escanear QR de Asistencia</h3>
                                    <button onClick={stopQRScanner} className="text-2xl">√ó</button>
                                </div>
                                <div
                                    id="qr-reader"
                                    className="w-full"
                                    style={{ touchAction: 'none' }}
                                    onTouchStart={handleQRPinchStart}
                                    onTouchMove={handleQRPinchMove}
                                    onTouchEnd={handleQRPinchEnd}
                                    onTouchCancel={handleQRPinchEnd}
                                ></div>
                                {qrZoomSupported && (
                                    <div className="mt-4">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="text-sm font-semibold">Zoom de c√°mara</span>
                                            <span className="text-sm" style={{ color: 'var(--text-secondary)' }}>{qrZoomValue.toFixed(1)}x</span>
                                        </div>
                                        <div className="flex items-center justify-center gap-2 mb-3">
                                            {[1, 3, 5]
                                                .filter((zoomPreset) => zoomPreset >= qrZoomMin && zoomPreset <= qrZoomMax)
                                                .map((zoomPreset) => (
                                                    <button
                                                        key={zoomPreset}
                                                        type="button"
                                                        className="btn btn-secondary"
                                                        style={{
                                                            minWidth: '56px',
                                                            opacity: Math.abs(qrZoomValue - zoomPreset) < Math.max(qrZoomStep, 0.1) / 2 ? 1 : 0.8
                                                        }}
                                                        onClick={() => handleQRZoomChange(zoomPreset)}
                                                    >
                                                        {zoomPreset}x
                                                    </button>
                                                ))}
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <button
                                                type="button"
                                                className="btn btn-secondary"
                                                onClick={() => handleQRZoomChange(Math.max(qrZoomMin, qrZoomValue - qrZoomStep))}
                                            >
                                                -
                                            </button>
                                            <input
                                                type="range"
                                                min={qrZoomMin}
                                                max={qrZoomMax}
                                                step={qrZoomStep}
                                                value={qrZoomValue}
                                                onChange={(e) => handleQRZoomChange(e.target.value)}
                                                className="w-full"
                                            />
                                            <button
                                                type="button"
                                                className="btn btn-secondary"
                                                onClick={() => handleQRZoomChange(Math.min(qrZoomMax, qrZoomValue + qrZoomStep))}
                                            >
                                                +
                                            </button>
                                        </div>
                                    </div>
                                )}
                                <p className="text-sm text-center mt-4" style={{ color: 'var(--text-secondary)' }}>
                                    Apunta la c√°mara al c√≥digo QR del profesor. Usa este control para acercar la c√°mara sin hacer zoom del navegador.
                                </p>
                            </div>
                        </div>
                    )}

                    {showJoinCourse && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="card rounded-xl p-6 w-full max-w-md">
                                <h3 className="text-lg font-bold mb-4">Unirse a un Curso</h3>
                                <form onSubmit={handleJoinCourse}>
                                    <div className="mb-4">
                                        <label className="block text-sm font-bold mb-2">C√≥digo del Curso</label>
                                        <input
                                            className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                            type="text"
                                            placeholder="#codigo_del_profesor"
                                            value={joinCourseCode}
                                            onChange={(e) => {
                                                let value = e.target.value;
                                                if (value && !value.startsWith('#')) {
                                                    value = '#' + value;
                                                }
                                                setJoinCourseCode(value);
                                            }}
                                            required
                                        />
                                    </div>
                                    <div className="flex gap-3">
                                        <button
                                            type="button"
                                            onClick={() => {
                                                setShowJoinCourse(false);
                                                setJoinCourseCode('');
                                            }}
                                            className="btn btn-secondary flex-1"
                                        >
                                            Cancelar
                                        </button>
                                        <button
                                            type="submit"
                                            className="btn btn-primary flex-1"
                                        >
                                            Enviar Solicitud
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {showProfile && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="card rounded-xl p-6 w-full max-w-md">
                                <h3 className="text-lg font-bold mb-4">Perfil de Usuario</h3>
                                <form onSubmit={handleUpdateProfile}>
                                    <div className="mb-4">
                                        <label className="block text-sm font-bold mb-2">Nombre Completo</label>
                                        <input
                                            className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                            type="text"
                                            placeholder={userData?.fullName || 'Tu nombre completo'}
                                            value={profileData.fullName}
                                            onChange={(e) => setProfileData({ ...profileData, fullName: e.target.value })}
                                        />
                                    </div>

                                    <div className="border-t pt-4 mb-4">
                                        <h4 className="font-semibold mb-2">Cambiar Contrase√±a (Opcional)</h4>
                                        <div className="space-y-3">
                                            <div>
                                                <label className="block text-sm font-bold mb-2">Contrase√±a Actual</label>
                                                <div className="relative">
                                                    <input
                                                        className="input-field w-full py-2 px-3 pr-10 rounded-lg focus:outline-none"
                                                        type={showStudentCurrentPassword ? 'text' : 'password'}
                                                        placeholder="Contrase√±a actual"
                                                        value={profileData.currentPassword}
                                                        onChange={(e) => setProfileData({ ...profileData, currentPassword: e.target.value })}
                                                    />
                                                    <button
                                                        type="button"
                                                        className="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                                                        onClick={() => setShowStudentCurrentPassword(!showStudentCurrentPassword)}
                                                    >
                                                        {showStudentCurrentPassword ? 'üôâ' : 'üôà'}
                                                    </button>
                                                </div>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-bold mb-2">Nueva Contrase√±a</label>
                                                <div className="relative">
                                                    <input
                                                        className="input-field w-full py-2 px-3 pr-10 rounded-lg focus:outline-none"
                                                        type={showStudentNewPassword ? 'text' : 'password'}
                                                        placeholder="Nueva contrase√±a"
                                                        value={profileData.newPassword}
                                                        onChange={(e) => setProfileData({ ...profileData, newPassword: e.target.value })}
                                                    />
                                                    <button
                                                        type="button"
                                                        className="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                                                        onClick={() => setShowStudentNewPassword(!showStudentNewPassword)}
                                                    >
                                                        {showStudentNewPassword ? 'üôâ' : 'üôà'}
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="flex gap-3">
                                        <button
                                            type="button"
                                            onClick={() => {
                                                setShowProfile(false);
                                                setProfileData({ fullName: '', currentPassword: '', newPassword: '', confirmPassword: '' });
                                            }}
                                            className="btn btn-secondary flex-1"
                                        >
                                            Cancelar
                                        </button>
                                        <button
                                            type="submit"
                                            className="btn btn-primary flex-1"
                                        >
                                            Guardar
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    <main className="container mx-auto max-w-6xl">
                        <div className="grid gap-6">
                            {dynamicContent.map((content) => {
                                const unlocked = isContentUnlocked(content);
                                const isExpanded = expandedWeek === content.id;

                                return (
                                    <div key={content.id} className={`card rounded-xl overflow-hidden ${!unlocked ? 'opacity-50' : ''
                                        } ${content.type === 'info' ? 'bg-slate-100' : ''}`} style={content.type === 'info' ? { borderColor: 'var(--accent-color)' } : {}}>
                                        <div
                                            className={`p-6 transition-colors ${unlocked ? 'cursor-pointer' : 'cursor-not-allowed'
                                                }`}
                                            onClick={() => unlocked && setExpandedWeek(isExpanded ? null : content.id)}
                                        >
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center gap-4">
                                                    <div className={`w-12 h-12 min-w-12 rounded-full flex items-center justify-center text-white font-bold ${unlocked ? 'bg-blue-500' : 'bg-gray-400'
                                                        }`}>
                                                        {unlocked ? (content.type === 'info' ? 'üìö' : (content.week || (content.weeks === '2-5' ? '2' : content.weeks))) : 'üîí'}
                                                    </div>
                                                    <div>
                                                        <h3 className="text-lg font-semibold">
                                                            {content.type === 'info' ? content.title : (content.week ? `Semana ${content.week}: ${content.title}` : `Semanas ${content.weeks}: ${content.title}`)}
                                                        </h3>
                                                        <p className="text-sm" style={{ color: 'var(--text-secondary)' }}>
                                                            {content.description}
                                                        </p>
                                                        {!unlocked && (
                                                            <span className="inline-block mt-1 px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">
                                                                Bloqueado - Completa badge anterior
                                                            </span>
                                                        )}
                                                        {unlocked && content.badges && content.badges.length > 0 && (
                                                            <div className="mt-2 flex flex-wrap gap-1">
                                                                {content.badges.map((badge, index) => {
                                                                    // Encontrar el √≠ndice global del badge en availableBadges
                                                                    const globalIndex = courseInfo?.availableBadges?.findIndex(b => b.name === badge.name && b.maxWeek === content.week) ?? index;
                                                                    const badgeId = `${content.week}-${globalIndex}`;
                                                                    const badgeEarned = getBadgeStatus(badgeId);
                                                                    const badgeStatusType = getBadgeStatusType(badgeId);
                                                                    return (
                                                                        <span key={index} className={`px-2 py-1 text-xs rounded-full ${badgeEarned
                                                                            ? (badgeStatusType === 'earned'
                                                                                ? 'bg-green-100 text-green-800'
                                                                                : 'bg-red-100 text-red-800')
                                                                            : 'bg-gray-100 text-gray-600'
                                                                            }`}>
                                                                            {badgeEarned
                                                                                ? (badgeStatusType === 'earned' ? 'üèÜ' : 'üî¥')
                                                                                : '‚óã'} {badge.name}
                                                                        </span>
                                                                    );
                                                                })}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                                <div className="text-gray-400">
                                                    {unlocked ? (isExpanded ? '‚ñ≤' : '‚ñº') : ''}
                                                </div>
                                            </div>
                                        </div>

                                        {isExpanded && unlocked && (
                                            <div className="px-6 pb-6 border-t" style={{ borderColor: 'var(--border-color)' }}>
                                                <div className="mt-4">
                                                    {content.type === 'info' ? (
                                                        <div>
                                                            <div className="grid md:grid-cols-2 gap-6 mb-6">
                                                                <div>
                                                                    <h3 className="font-semibold mb-2 text-gray-800">Datos del Curso</h3>
                                                                    <ul className="space-y-1 text-sm text-gray-600">
                                                                        <li><strong>Universidad:</strong> {courseInfo?.university || 'Por definir'}</li>
                                                                        <li><strong>Nombre:</strong> {courseInfo?.courseName || courseInfo?.name || 'Por definir'}</li>
                                                                        <li><strong>C√≥digo:</strong> {courseInfo?.courseCode || 'Por definir'}</li>
                                                                        <li><strong>Periodo:</strong> {courseInfo?.period || 'Por definir'}</li>
                                                                        <li><strong>Grupo:</strong> {courseInfo?.group || 'Por definir'}</li>
                                                                        <li><strong>Programa/s:</strong> {courseInfo?.programs || 'Por definir'}</li>
                                                                        <li><strong>Intensidad Horaria:</strong> {courseInfo?.intensity || 'Por definir'}</li>
                                                                        <li><strong>Cr√©ditos:</strong> {courseInfo?.credits || 'Por definir'}</li>
                                                                        <li><strong>Docente:</strong> {professorName || 'Cargando...'}</li>
                                                                    </ul>
                                                                </div>
                                                                <div>
                                                                    <h3 className="font-semibold mb-2 text-gray-800">Introducci√≥n</h3>
                                                                    <p className="text-sm text-gray-600">
                                                                        {courseInfo?.introduction || 'Por definir'}
                                                                    </p>
                                                                </div>
                                                            </div>

                                                            <div className="mb-6">
                                                                <h3 className="font-semibold mb-2 text-gray-800">Acuerdos sobre el Uso de Inteligencia Artificial Generativa (IAG)</h3>
                                                                <p className="text-sm text-gray-600">
                                                                    {courseInfo?.iagAgreements || 'Por definir'}
                                                                </p>
                                                            </div>

                                                            <div>
                                                                <h3 className="font-semibold mb-3 text-gray-800">üèÜ Badges Disponibles en el Curso</h3>
                                                                {courseInfo?.availableBadges && courseInfo.availableBadges.length > 0 ? (
                                                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 text-xs">
                                                                        {courseInfo.availableBadges.map((badge, index) => (
                                                                            <div key={index} className="p-2 bg-white rounded border">
                                                                                <div className="font-bold text-green-600">{badge.name}</div>
                                                                                <div className="text-gray-600">{badge.description}</div>
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                ) : (
                                                                    <div className="p-4 bg-gray-50 rounded border text-center text-gray-600">
                                                                        <p>El profesor a√∫n no ha configurado los badges para este curso.</p>
                                                                        <p className="text-xs mt-1">Los badges aparecer√°n aqu√≠ una vez que sean definidos.</p>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    ) : (
                                                        <div>
                                                            {content.content && (
                                                                <div>
                                                                    <h4 className="font-semibold mb-2">Contenido:</h4>
                                                                    <p className="mb-4" style={{ color: 'var(--text-secondary)' }}>
                                                                        {content.content}
                                                                    </p>
                                                                </div>
                                                            )}

                                                            {content.activities && content.activities.length > 0 && (
                                                                <div>
                                                                    <h4 className="font-semibold mb-2">Actividades:</h4>
                                                                    <ul className="space-y-1 mb-6">
                                                                        {content.activities.map((activity, index) => (
                                                                            <li key={index} className="flex items-start gap-2">
                                                                                <span className="text-blue-500 mt-1">‚Ä¢</span>
                                                                                <span style={{ color: 'var(--text-secondary)' }}>{activity}</span>
                                                                            </li>
                                                                        ))}
                                                                    </ul>
                                                                </div>
                                                            )}

                                                            {content.badges && content.badges.length > 0 && (
                                                                <div>
                                                                    <h4 className="font-semibold mb-2">üèÜ Badges de esta Semana:</h4>
                                                                    <div className="grid gap-2">
                                                                        {content.badges.map((badge, index) => (
                                                                            <div key={index} className="p-2 bg-gray-50 rounded border">
                                                                                <div className="font-medium text-sm">{badge.name}</div>
                                                                                <div className="text-xs text-gray-600">{badge.description}</div>
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    )}

                                                    {content.weeks === "2-5" && (
                                                        <div className="mt-6">
                                                            <h4 className="font-semibold mb-3">üìã R√∫brica de Evaluaci√≥n</h4>
                                                            <div className="overflow-x-auto">
                                                                <table className="w-full text-sm border-collapse border" style={{ borderColor: 'var(--border-color)' }}>
                                                                    <thead>
                                                                        <tr className="bg-gray-50">
                                                                            <th className="border p-2 text-left font-semibold text-gray-800" style={{ borderColor: 'var(--border-color)' }}></th>
                                                                            <th className="border p-2 text-center font-semibold bg-green-100 text-gray-800" style={{ borderColor: 'var(--border-color)' }}>Excelente</th>
                                                                            <th className="border p-2 text-center font-semibold bg-yellow-100 text-gray-800" style={{ borderColor: 'var(--border-color)' }}>Bueno</th>
                                                                            <th className="border p-2 text-center font-semibold bg-orange-100 text-gray-800" style={{ borderColor: 'var(--border-color)' }}>Regular</th>
                                                                            <th className="border p-2 text-center font-semibold bg-red-100 text-gray-800" style={{ borderColor: 'var(--border-color)' }}>Necesita Mejorar</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                        <tr>
                                                                            <td className="border p-2 font-semibold bg-gray-50 text-gray-800" style={{ borderColor: 'var(--border-color)' }}>Creatividad</td>
                                                                            <td className="border p-2 text-xs bg-green-50 text-gray-800" style={{ borderColor: 'var(--border-color)' }}>Presenta el contenido de manera altamente innovadora y original. Utiliza recursos visuales y/o interactivos √∫nicos que captan la atenci√≥n. Demuestra un pensamiento fuera de lo convencional.</td>
                                                                            <td className="border p-2 text-xs bg-yellow-50 text-gray-800" style={{ borderColor: 'var(--border-color)' }}>Demuestra creatividad en la presentaci√≥n del contenido. Utiliza algunos recursos originales. Las ideas se presentan de forma interesante.</td>
                                                                            <td className="border p-2 text-xs bg-orange-50 text-gray-800" style={{ borderColor: 'var(--border-color)' }}>La presentaci√≥n es convencional pero correcta. Utiliza recursos comunes. Hay algunos intentos de originalidad.</td>
                                                                            <td className="border p-2 text-xs bg-red-50 text-gray-800" style={{ borderColor: 'var(--border-color)' }}>La presentaci√≥n carece de elementos creativos. Utiliza m√©todos muy b√°sicos o repetitivos. No hay originalidad en el enfoque.</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <td className="border p-2 font-semibold bg-gray-50 text-gray-800" style={{ borderColor: 'var(--border-color)' }}>Claridad</td>
                                                                            <td className="border p-2 text-xs bg-green-50 text-gray-800" style={{ borderColor: 'var(--border-color)' }}>La exposici√≥n es extraordinariamente clara y bien estructurada. Las ideas fluyen de manera l√≥gica y coherente. El lenguaje es preciso y adecuado. La informaci√≥n se transmite de forma efectiva.</td>
                                                                            <td className="border p-2 text-xs bg-yellow-50 text-gray-800" style={{ borderColor: 'var(--border-color)' }}>La exposici√≥n es clara y comprensible. La mayor√≠a de las ideas est√°n bien organizadas. El lenguaje es apropiado aunque con algunas imprecisiones.</td>
                                                                            <td className="border p-2 text-xs bg-orange-50 text-gray-800" style={{ borderColor: 'var(--border-color)' }}>La exposici√≥n es algo confusa en ciertos puntos. Algunas ideas no est√°n bien conectadas. El lenguaje puede ser impreciso o inadecuado ocasionalmente.</td>
                                                                            <td className="border p-2 text-xs bg-red-50 text-gray-800" style={{ borderColor: 'var(--border-color)' }}>La exposici√≥n es dif√≠cil de seguir. Las ideas est√°n desorganizadas. El lenguaje es confuso o inapropiado frecuentemente.</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <td className="border p-2 font-semibold bg-gray-50 text-gray-800" style={{ borderColor: 'var(--border-color)' }}>Conclusiones</td>
                                                                            <td className="border p-2 text-xs bg-green-50 text-gray-800" style={{ borderColor: 'var(--border-color)' }}>Las conclusiones son profundas y bien fundamentadas. Formula preguntas originales y estimulantes que generan discusi√≥n significativa. Demuestra una comprensi√≥n excepcional del tema.</td>
                                                                            <td className="border p-2 text-xs bg-yellow-50 text-gray-800" style={{ borderColor: 'var(--border-color)' }}>Las conclusiones son v√°lidas y est√°n bien presentadas. Las preguntas son relevantes y promueven cierta discusi√≥n. Demuestra buena comprensi√≥n del tema.</td>
                                                                            <td className="border p-2 text-xs bg-orange-50 text-gray-800" style={{ borderColor: 'var(--border-color)' }}>Las conclusiones son b√°sicas o superficiales. Las preguntas son simples o poco elaboradas. Demuestra comprensi√≥n parcial del tema.</td>
                                                                            <td className="border p-2 text-xs bg-red-50 text-gray-800" style={{ borderColor: 'var(--border-color)' }}>Las conclusiones son d√©biles o ausentes. Las preguntas son irrelevantes o no se formulan. Demuestra poca comprensi√≥n del tema.</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <td className="border p-2 font-semibold bg-gray-50 text-gray-800" style={{ borderColor: 'var(--border-color)' }}>Preguntas</td>
                                                                            <td className="border p-2 text-xs bg-green-50 text-gray-800" style={{ borderColor: 'var(--border-color)' }}>Participa activamente en todas las exposiciones. Hace comentarios constructivos y preguntas relevantes. Demuestra inter√©s genuino y respeto por el trabajo de otros.</td>
                                                                            <td className="border p-2 text-xs bg-yellow-50 text-gray-800" style={{ borderColor: 'var(--border-color)' }}>Participa regularmente en las exposiciones. Hace algunos comentarios y preguntas √∫tiles. Muestra inter√©s por el trabajo de otros.</td>
                                                                            <td className="border p-2 text-xs bg-orange-50 text-gray-800" style={{ borderColor: 'var(--border-color)' }}>Participa ocasionalmente en las exposiciones. Los comentarios son limitados o poco elaborados. Muestra inter√©s intermitente.</td>
                                                                            <td className="border p-2 text-xs bg-red-50 text-gray-800" style={{ borderColor: 'var(--border-color)' }}>Raramente participa en las exposiciones. No hace comentarios ni preguntas. Muestra poco inter√©s por el trabajo de otros.</td>
                                                                        </tr>
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </main>
                    <footer className="mt-8 text-center text-xs" style={{ color: 'var(--text-secondary)' }}>
                        Developed by<br />Leandro Fl√≥rez-Aristiz√°bal, Ph.D
                    </footer>
                </div>
            );
        }

        function AppContent() {
            const [currentUser, setCurrentUser] = React.useState(null);
            const [userData, setUserData] = React.useState(null);
            const [authReady, setAuthReady] = React.useState(false);
            const toast = useToast();

            const firebaseConfig = {
                apiKey: "AIzaSyBEKzy25wj-qIVJcyqkCors2b8zPostu7E",
                authDomain: "seminario-de-investigaci-283c8.firebaseapp.com",
                projectId: "seminario-de-investigaci-283c8",
                storageBucket: "seminario-de-investigaci-283c8.firebasestorage.app",
                messagingSenderId: "253114435967",
                appId: "1:253114435967:web:b83b9413f663f283b7724a",
                measurementId: "G-7J76P5D7Z3"
            };

            React.useEffect(() => {
                firebase.initializeApp(firebaseConfig);
                const auth = firebase.auth();

                const unsubscribe = auth.onAuthStateChanged(async (user) => {
                    setCurrentUser(user);

                    if (user) {
                        try {
                            const db = firebase.firestore();

                            // Primero buscar en profesores
                            let userDoc = await db.doc(`artifacts/seminario-investigacion-app/professors/${user.uid}/profile/data`).get();

                            if (userDoc.exists) {
                                setUserData({ ...userDoc.data(), userType: 'professor' });
                            } else {
                                setUserData({ userType: 'student' });
                            }
                        } catch (error) {
                            console.error('Error cargando datos del usuario:', error);
                        }
                    } else {
                        setUserData(null);
                    }

                    setAuthReady(true);
                });

                return () => unsubscribe();
            }, []);

            if (!authReady) {
                return <LoadingSpinner />;
            }

            return (
                <>
                    {currentUser ? (
                        userData?.userType === 'professor' ? (
                            <AdminDashboard currentUser={currentUser} />
                        ) : (
                            <CoursePage currentUser={currentUser} />
                        )
                    ) : (
                        <AuthPage />
                    )}
                </>
            );
        }

        function App() {
            return (
                <ToastProvider>
                    <AppContent />
                </ToastProvider>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>

</html>