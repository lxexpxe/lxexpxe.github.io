<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seminario de Investigaci√≥n</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f9fafb;
            --bg-secondary: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --accent-color: #4D96FF;
            --success-color: #10b981;
            --error-color: #ef4444;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        [data-theme="dark"] {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --border-color: #374151;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3), 0 1px 2px 0 rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .spinner {
            border: 4px solid rgba(77, 150, 255, 0.2);
            border-left-color: var(--accent-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes slideDown {
            from { opacity: 0; max-height: 0; }
            to { opacity: 1; max-height: 1000px; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-slideDown { animation: slideDown 0.3s ease-out; }
        .animate-fadeIn { animation: fadeIn 0.5s ease-out; }
        
        .card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }
        
        .input-field {
            background-color: var(--bg-secondary);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }
        
        .input-field:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(77, 150, 255, 0.1);
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-color), #3b82f6);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn-secondary {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
        }
        
        .theme-toggle {
            background-color: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 9999px;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .theme-toggle:hover {
            border-color: var(--accent-color);
        }
        
        .toast {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 600;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        
        .toast-success { background-color: var(--success-color); }
        .toast-error { background-color: var(--error-color); }
        .toast-info { background-color: var(--accent-color); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const ToastContext = React.createContext();
        
        function ToastProvider({ children }) {
            const [toasts, setToasts] = React.useState([]);
            
            const showToast = (message, type = 'success') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
                setTimeout(() => {
                    setToasts(prev => prev.filter(toast => toast.id !== id));
                }, 3000);
            };
            
            return React.createElement(ToastContext.Provider, { value: { showToast } }, [
                children,
                React.createElement('div', { key: 'toasts' }, 
                    toasts.map(toast => 
                        React.createElement('div', {
                            key: toast.id,
                            className: `toast toast-${toast.type}`
                        }, toast.message)
                    )
                )
            ]);
        }
        
        const useToast = () => React.useContext(ToastContext);
        
        function useTheme() {
            const [theme, setTheme] = React.useState(() => 
                localStorage.getItem('theme') || 'light'
            );
            
            React.useEffect(() => {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
            }, [theme]);
            
            const toggleTheme = () => {
                setTheme(prev => prev === 'light' ? 'dark' : 'light');
            };
            
            return { theme, toggleTheme };
        }
        
        function ThemeToggle() {
            const { theme, toggleTheme } = useTheme();
            return React.createElement('button', {
                className: 'theme-toggle',
                onClick: toggleTheme,
                title: `Cambiar a tema ${theme === 'light' ? 'oscuro' : 'claro'}`
            }, theme === 'light' ? 'üåô' : '‚òÄÔ∏è');
        }
        
        const User = ({ className = '' }) => React.createElement('span', { className }, 'üë§');
        const LogOut = ({ className = '' }) => React.createElement('span', { className }, 'üö™');
        const Loader2 = ({ className = '' }) => React.createElement('div', { className: `spinner ${className}` });

        const LoadingSpinner = () => (
          <div className="flex justify-center items-center py-8 animate-fadeIn">
            <div className="spinner"></div>
            <p className="ml-3" style={{color: 'var(--text-secondary)'}}>Cargando...</p>
          </div>
        );
        
        function AuthPage() {
            const toast = useToast();
            const auth = firebase.auth();
            const db = firebase.firestore();
            const [isLogin, setIsLogin] = React.useState(true);
            const [email, setEmail] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [fullName, setFullName] = React.useState('');
            const [loading, setLoading] = React.useState(false);
            const [showCodeVerification, setShowCodeVerification] = React.useState(false);
            const [verificationCode, setVerificationCode] = React.useState('');
            const [generatedCode, setGeneratedCode] = React.useState('');
            const [pendingUserData, setPendingUserData] = React.useState(null);
            const [userRole, setUserRole] = React.useState('student');
            const [courseCode, setCourseCode] = React.useState('');
            
            const validateEmail = (email) => {
                const icesiBothPattern = /^[a-zA-Z0-9._%+-]+@(icesi\.edu\.co|u\.icesi\.edu\.co)$/;
                return icesiBothPattern.test(email);
            };

            const generateCode = () => Math.floor(100000 + Math.random() * 900000).toString();

            const sendVerificationEmail = async (email, code, fullName) => {
                try {
                    emailjs.init('145MnHTSSDkBVKZAU');
                    
                    const templateParams = {
                        to_name: fullName || email.split('@')[0],
                        to_email: email,
                        verification_code: code,
                        from_name: 'Seminario de Investigaci√≥n'
                    };
                    
                    const result = await emailjs.send(
                        'service_7u1zcni',
                        'template_1129sv3',
                        templateParams
                    );
                    
                    toast.showToast('C√≥digo enviado a tu correo', 'success');
                } catch (error) {
                    console.error('Error enviando email:', error);
                    console.log(`C√≥digo de verificaci√≥n para ${email}: ${code}`);
                    toast.showToast(`Error enviando email. C√≥digo (desarrollo): ${code}`, 'info');
                }
            };

            const handleAuth = async (e) => {
                e.preventDefault();
                setLoading(true);

                if (!validateEmail(email)) {
                    toast.showToast('Usa tu correo institucional (@icesi.edu.co o @u.icesi.edu.co)', 'error');
                    setLoading(false);
                    return;
                }

                try {
                    if (isLogin) {
                        const result = await auth.signInWithEmailAndPassword(email, password);
                        toast.showToast('¬°Bienvenido de vuelta!', 'success');
                    } else {
                        const code = generateCode();
                        setGeneratedCode(code);
                        
                        if (userRole === 'student' && !courseCode.startsWith('#')) {
                            toast.showToast('Los estudiantes deben ingresar un c√≥digo de curso v√°lido (#codigo)', 'error');
                            setLoading(false);
                            return;
                        }
                        
                        if (userRole === 'professor' && !courseCode.startsWith('#')) {
                            toast.showToast('Los profesores deben crear un c√≥digo de curso (#codigo)', 'error');
                            setLoading(false);
                            return;
                        }
                        
                        setPendingUserData({
                            email,
                            password,
                            fullName,
                            userType: userRole,
                            courseCode
                        });
                        
                        await sendVerificationEmail(email, code, fullName);
                        setShowCodeVerification(true);
                    }
                } catch (err) {
                    console.error('Error en handleAuth:', err);
                    let errorMessage = 'Error de autenticaci√≥n. Por favor, intenta de nuevo.';
                    
                    if (err.code === 'auth/invalid-email') {
                        errorMessage = 'El correo electr√≥nico no tiene un formato v√°lido.';
                    } else if (err.code === 'auth/user-not-found') {
                        errorMessage = 'Usuario no encontrado. Verifica tu correo o crea una cuenta.';
                    } else if (err.code === 'auth/wrong-password') {
                        errorMessage = 'Contrase√±a incorrecta.';
                    } else if (err.code === 'auth/email-already-in-use') {
                        errorMessage = 'Este correo ya est√° registrado.';
                    } else if (err.code === 'auth/weak-password') {
                        errorMessage = 'La contrase√±a es demasiado d√©bil. Debe tener al menos 6 caracteres.';
                    }
                    
                    toast.showToast(errorMessage, 'error');
                } finally {
                    setLoading(false);
                }
            };

            const handleVerifyCode = async (e) => {
                e.preventDefault();
                setLoading(true);

                if (verificationCode !== generatedCode) {
                    toast.showToast('C√≥digo incorrecto', 'error');
                    setLoading(false);
                    return;
                }

                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(
                        pendingUserData.email,
                        pendingUserData.password
                    );
                    const user = userCredential.user;
                    
                    const appId = 'seminario-investigacion-app';
                    const userDocRef = db.doc(`artifacts/${appId}/users/${user.uid}`);
                    
                    const userData = {
                        email: pendingUserData.email,
                        fullName: pendingUserData.fullName,
                        userType: pendingUserData.userType,
                        emailVerified: true,
                        createdAt: new Date(),
                        courseCode: pendingUserData.courseCode
                    };

                    if (pendingUserData.userType === 'student') {
                        userData.badgesEarned = [];
                        userData.lastBadgeEarned = null;
                    } else {
                        // Crear documento del curso si es profesor
                        const courseDocRef = db.collection('artifacts/seminario-investigacion-app/courses').doc();
                        await courseDocRef.set({
                            courseCode: pendingUserData.courseCode,
                            professorId: user.uid,
                            professorEmail: pendingUserData.email,
                            professorName: pendingUserData.fullName,
                            createdAt: new Date(),
                            studentsCount: 0
                        });
                    }
                    
                    await userDocRef.set(userData);
                    
                    toast.showToast('¬°Cuenta creada exitosamente! Bienvenido.', 'success');
                    
                    setShowCodeVerification(false);
                    setVerificationCode('');
                    setGeneratedCode('');
                    setPendingUserData(null);
                } catch (err) {
                    console.error('Error creando cuenta:', err);
                    let errorMessage = 'Error creando la cuenta';
                    
                    if (err.code === 'auth/email-already-in-use') {
                        errorMessage = 'Este correo ya est√° registrado';
                    } else if (err.code === 'permission-denied') {
                        errorMessage = 'Error de permisos en Firestore. Verifica las reglas de seguridad.';
                    }
                    
                    toast.showToast(errorMessage, 'error');
                } finally {
                    setLoading(false);
                }
            };

            if (showCodeVerification) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4" style={{backgroundColor: 'var(--bg-primary)'}}>
                        <div className="card rounded-2xl p-8 w-full max-w-md animate-fadeIn">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-3xl font-bold" style={{color: 'var(--text-primary)'}}>
                                    Verificar C√≥digo
                                </h2>
                                <ThemeToggle />
                            </div>
                            
                            <div className="text-center mb-6">
                                <p className="text-sm" style={{color: 'var(--text-secondary)'}}>
                                    Ingresa el c√≥digo de 6 d√≠gitos enviado a <strong>{pendingUserData?.email}</strong>
                                </p>
                            </div>
                            
                            <form onSubmit={handleVerifyCode}>
                                <div className="mb-6">
                                    <input
                                        className="input-field w-full py-3 px-4 rounded-lg focus:outline-none text-center text-2xl tracking-widest"
                                        type="text"
                                        placeholder="000000"
                                        value={verificationCode}
                                        onChange={(e) => setVerificationCode(e.target.value.replace(/\D/g, '').slice(0, 6))}
                                        maxLength="6"
                                        required
                                    />
                                </div>
                                
                                <div className="flex flex-col gap-4">
                                    <button
                                        className="btn btn-primary w-full"
                                        type="submit"
                                        disabled={loading || verificationCode.length !== 6}
                                    >
                                        {loading && <Loader2 className="w-5 h-5" />}
                                        Verificar y Crear Cuenta
                                    </button>
                                    
                                    <button
                                        className="btn btn-secondary w-full"
                                        type="button"
                                        onClick={() => {
                                            setShowCodeVerification(false);
                                            setVerificationCode('');
                                            setGeneratedCode('');
                                            setPendingUserData(null);
                                        }}
                                    >
                                        Volver
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen flex items-center justify-center p-4" style={{backgroundColor: 'var(--bg-primary)'}}>
                    <div className="card rounded-2xl p-8 w-full max-w-md animate-fadeIn">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-3xl font-bold" style={{color: 'var(--text-primary)'}}>
                                {isLogin ? 'Iniciar Sesi√≥n' : 'Crear Cuenta'}
                            </h2>
                            <ThemeToggle />
                        </div>
                        
                        <form onSubmit={handleAuth}>
                            <div className="mb-4">
                                <label className="block text-sm font-bold mb-2" style={{color: 'var(--text-primary)'}}>
                                    Correo Institucional
                                </label>
                                <input
                                    className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                    type="email"
                                    placeholder="correo@icesi.edu.co o @u.icesi.edu.co"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    required
                                />
                            </div>
                            
                            {!isLogin && (
                                <>
                                    <div className="mb-4">
                                        <label className="block text-sm font-bold mb-2" style={{color: 'var(--text-primary)'}}>
                                            Nombre Completo
                                        </label>
                                        <input
                                            className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                            type="text"
                                            placeholder="Tu Nombre Completo"
                                            value={fullName}
                                            onChange={(e) => setFullName(e.target.value)}
                                            required
                                        />
                                    </div>
                                    
                                    <div className="mb-4">
                                        <label className="block text-sm font-bold mb-2" style={{color: 'var(--text-primary)'}}>
                                            Tipo de Usuario
                                        </label>
                                        <select
                                            className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                            value={userRole}
                                            onChange={(e) => setUserRole(e.target.value)}
                                            required
                                        >
                                            <option value="student">Estudiante</option>
                                            <option value="professor">Profesor</option>
                                        </select>
                                    </div>
                                    
                                    <div className="mb-4">
                                        <label className="block text-sm font-bold mb-2" style={{color: 'var(--text-primary)'}}>
                                            {userRole === 'professor' ? 'Crear C√≥digo de Curso' : 'C√≥digo de Curso'}
                                        </label>
                                        <input
                                            className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                            type="text"
                                            placeholder={userRole === 'professor' ? '#MI_CURSO_2024' : '#codigo_del_profesor'}
                                            value={courseCode}
                                            onChange={(e) => {
                                                let value = e.target.value;
                                                if (value && !value.startsWith('#')) {
                                                    value = '#' + value;
                                                }
                                                setCourseCode(value);
                                            }}
                                            required
                                        />
                                        <p className="text-xs mt-1" style={{color: 'var(--text-secondary)'}}>
                                            {userRole === 'professor' 
                                                ? 'Crea un c√≥digo √∫nico para tu curso (ej: #SEMINARIO_2024)'
                                                : 'Ingresa el c√≥digo que te proporcion√≥ tu profesor'
                                            }
                                        </p>
                                    </div>
                                </>
                            )}
                            
                            <div className="mb-4">
                                <label className="block text-sm font-bold mb-2" style={{color: 'var(--text-primary)'}}>
                                    Contrase√±a
                                </label>
                                <input
                                    className="input-field w-full py-3 px-4 rounded-lg focus:outline-none"
                                    type="password"
                                    placeholder="M√≠nimo 6 caracteres"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    required
                                />
                            </div>
                            
                            <div className="flex flex-col gap-4 mt-6">
                                <button
                                    className="btn btn-primary w-full"
                                    type="submit"
                                    disabled={loading}
                                >
                                    {loading && <Loader2 className="w-5 h-5" />}
                                    {isLogin ? 'Iniciar Sesi√≥n' : 'Enviar C√≥digo'}
                                </button>
                                
                                <button
                                    className="btn btn-secondary w-full"
                                    type="button"
                                    onClick={() => {
                                        setIsLogin(!isLogin);
                                        setEmail('');
                                        setPassword('');
                                        setFullName('');
                                        setUserRole('student');
                                        setCourseCode('');
                                    }}
                                >
                                    {isLogin ? '¬øNo tienes cuenta? Reg√≠strate' : '¬øYa tienes cuenta? Inicia Sesi√≥n'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function AdminDashboard({ currentUser }) {
            const auth = firebase.auth();
            const db = firebase.firestore();
            const toast = useToast();
            const [students, setStudents] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [userData, setUserData] = React.useState(null);
            const [expandedStudent, setExpandedStudent] = React.useState(null);

            const badges = [
                { id: 1, name: 'Badge de Iniciaci√≥n', description: 'Por completar la primera lectura, reflexionar sobre tus intereses iniciales y formar parte de un equipo (Semana 1)' },
                { id: 2, name: 'Badge de Maestro Expositor', description: 'Por exponer sobre tu tema asignado en las Semanas 2-5 (se gana una sola vez al realizar tu exposici√≥n grupal)' },
                { id: 3, name: 'Badge de Participaci√≥n Activa: Novato', description: 'Por participar activamente en el debate y taller de la Semana 2' },
                { id: 4, name: 'Badge de Participaci√≥n Activa: Aprendiz', description: 'Por participar activamente en el debate y taller de la Semana 3' },
                { id: 5, name: 'Badge de Participaci√≥n Activa: Avanzado', description: 'Por participar activamente en el debate y taller de la Semana 4' },
                { id: 6, name: 'Badge de Participaci√≥n Activa: M√°ster', description: 'Por participar activamente en el debate y reflexi√≥n de la Semana 5' },
                { id: 7, name: 'Badge de Cuestionador Perspicaz', description: 'Por formular preguntas desafiantes y relevantes durante el periodo de exposiciones (Semanas 2-5)' },
                { id: 8, name: 'Badge de Clarificador del Saber', description: 'Por responder correctamente y con claridad a las preguntas de los compa√±eros durante el periodo de exposiciones (Semanas 2-5)' },
                { id: 9, name: 'Badge de Conector de Conceptos', description: 'Por sintetizar y establecer conexiones perspicaces entre los diferentes temas expuestos durante el periodo de exposiciones (Semanas 2-5)' },
                { id: 10, name: 'Badge de Sembrador de Ideas', description: 'Por identificar una problem√°tica y comenzar tu b√∫squeda preliminar (Semana 6)' },
                { id: 11, name: 'Badge de Art√≠fice de Preguntas', description: 'Por formular una pregunta de investigaci√≥n bien definida y su planteamiento (Semana 7)' },
                { id: 12, name: 'Badge de Bibliotecario Experto', description: 'Por iniciar tu revisi√≥n bibliogr√°fica y definir objetivos claros (Semana 8)' },
                { id: 13, name: 'Badge de Arquitecto de Proyectos', description: 'Por consolidar tu primera propuesta de investigaci√≥n (Semana 9)' },
                { id: 14, name: 'Badge de Estratega Metodol√≥gico', description: 'Por dise√±ar tu metodolog√≠a y definir conceptos clave (Semana 10)' },
                { id: 15, name: 'Badge de Constructor de Instrumentos', description: 'Por desarrollar tus herramientas de recolecci√≥n de datos (Semana 11)' },
                { id: 16, name: 'Badge de Recolector de Datos', description: 'Por iniciar y organizar tu recolecci√≥n de datos (Semana 12)' },
                { id: 17, name: 'Badge de Int√©rprete Cualitativo', description: 'Por realizar tu primer an√°lisis cualitativo (Semana 13)' },
                { id: 18, name: 'Badge de Analista Cuantitativo', description: 'Por realizar tu primer an√°lisis cuantitativo (Semana 14)' },
                { id: 19, name: 'Badge de Narrador Visual', description: 'Por dise√±ar tus visualizaciones y empezar a redactar tu informe (Semana 15)' },
                { id: 20, name: 'Badge de Investigador √âlite', description: 'Por completar y presentar tu proyecto final de investigaci√≥n (Semana 16)' }
            ];

            React.useEffect(() => {
                loadStudents();
                loadUserData();
            }, []);

            const loadUserData = async () => {
                try {
                    const userDoc = await db.doc(`artifacts/seminario-investigacion-app/users/${currentUser.uid}`).get();
                    if (userDoc.exists) {
                        setUserData(userDoc.data());
                    }
                } catch (error) {
                    console.error('Error cargando datos del usuario:', error);
                }
            };

            const loadStudents = async () => {
                try {
                    const userDoc = await db.doc(`artifacts/seminario-investigacion-app/users/${currentUser.uid}`).get();
                    if (userDoc.exists) {
                        const professorData = userDoc.data();
                        const courseCode = professorData.courseCode;
                        
                        const studentsQuery = await db.collection('artifacts/seminario-investigacion-app/users')
                            .where('userType', '==', 'student')
                            .where('courseCode', '==', courseCode)
                            .get();
                        
                        const studentsData = studentsQuery.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        
                        setStudents(studentsData);
                    }
                } catch (error) {
                    console.error('Error cargando estudiantes:', error);
                    toast.showToast('Error cargando estudiantes', 'error');
                } finally {
                    setLoading(false);
                }
            };

            const assignBadge = async (studentId, badgeId) => {
                try {
                    const studentRef = db.doc(`artifacts/seminario-investigacion-app/users/${studentId}`);
                    const studentDoc = await studentRef.get();
                    
                    if (studentDoc.exists) {
                        const studentData = studentDoc.data();
                        const currentBadges = studentData.badgesEarned || [];
                        
                        if (!currentBadges.includes(badgeId)) {
                            await studentRef.update({
                                badgesEarned: [...currentBadges, badgeId],
                                lastBadgeEarned: new Date()
                            });
                            
                            toast.showToast('Badge asignado exitosamente', 'success');
                            loadStudents();
                        } else {
                            toast.showToast('El estudiante ya tiene este badge', 'error');
                        }
                    }
                } catch (error) {
                    console.error('Error asignando badge:', error);
                    toast.showToast('Error asignando badge', 'error');
                }
            };

            const handleLogout = async () => {
                try {
                    await auth.signOut();
                    toast.showToast('¬°Hasta luego!', 'success');
                } catch (err) {
                    toast.showToast("Error al cerrar sesi√≥n. Intenta de nuevo.", 'error');
                }
            };

            if (loading) {
                return <LoadingSpinner />;
            }

            return (
                <div className="min-h-screen p-4 md:p-8" style={{backgroundColor: 'var(--bg-primary)'}}>
                    <header className="card rounded-xl p-6 mb-8 animate-fadeIn">
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div>
                                <h1 className="text-3xl font-bold mb-2">Panel de Administraci√≥n</h1>
                                <p className="text-sm" style={{color: 'var(--text-secondary)'}}>
                                    Profesor: {currentUser.email}
                                </p>
                                <p className="text-xs" style={{color: 'var(--text-secondary)'}}>
                                    C√≥digo de curso: {userData?.courseCode}
                                </p>
                            </div>
                            <div className="flex items-center gap-3">
                                <ThemeToggle />
                                <button
                                    onClick={handleLogout}
                                    className="btn btn-secondary flex items-center gap-2"
                                >
                                    <LogOut />
                                    Cerrar Sesi√≥n
                                </button>
                            </div>
                        </div>
                    </header>
                    
                    <div className="grid gap-6">
                        <div className="card rounded-xl p-6">
                            <h2 className="text-xl font-bold mb-4">Estudiantes Registrados ({students.length})</h2>
                            
                            {students.length === 0 ? (
                                <p style={{color: 'var(--text-secondary)'}}>No hay estudiantes registrados a√∫n.</p>
                            ) : (
                                <div className="space-y-4">
                                    {students.map(student => {
                                        const isExpanded = expandedStudent === student.id;
                                        return (
                                            <div key={student.id} className="border rounded-lg overflow-hidden" style={{borderColor: 'var(--border-color)'}}>
                                                <div 
                                                    className="p-4 cursor-pointer hover:bg-gray-50 transition-colors"
                                                    onClick={() => setExpandedStudent(isExpanded ? null : student.id)}
                                                >
                                                    <div className="flex justify-between items-center">
                                                        <div>
                                                            <h3 className="font-semibold">{student.fullName}</h3>
                                                            <p className="text-sm" style={{color: 'var(--text-secondary)'}}>{student.email}</p>
                                                            <div className="text-sm mt-1" style={{color: 'var(--text-secondary)'}}>
                                                                Badges: {(student.badgesEarned || []).length}/20
                                                            </div>
                                                        </div>
                                                        <div className="text-gray-400">
                                                            {isExpanded ? '‚ñ≤' : '‚ñº'}
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                {isExpanded && (
                                                    <div className="px-4 pb-4 border-t" style={{borderColor: 'var(--border-color)'}}>
                                                        <div className="mt-4">
                                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-2">
                                                                {badges.map(badge => {
                                                                    const hasEarned = (student.badgesEarned || []).includes(badge.id);
                                                                    return (
                                                                        <button
                                                                            key={badge.id}
                                                                            onClick={() => !hasEarned && assignBadge(student.id, badge.id)}
                                                                            className={`p-3 rounded text-left text-sm transition-colors ${
                                                                                hasEarned 
                                                                                    ? 'bg-green-100 text-green-800 border border-green-200' 
                                                                                    : 'bg-gray-100 text-gray-600 border border-gray-200 hover:bg-blue-50'
                                                                            }`}
                                                                            disabled={hasEarned}
                                                                            title={badge.description}
                                                                        >
                                                                            <div className="flex items-start gap-2">
                                                                                <span className="text-lg">{hasEarned ? '‚úì' : '+'}</span>
                                                                                <div>
                                                                                    <div className="font-medium">{badge.name}</div>
                                                                                    <div className="text-xs opacity-75 mt-1">{badge.description}</div>
                                                                                </div>
                                                                            </div>
                                                                        </button>
                                                                    );
                                                                })}
                                                            </div>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        function CoursePage({ currentUser }) {
            const auth = firebase.auth();
            const db = firebase.firestore();
            const toast = useToast();
            const { theme } = useTheme();
            const isDarkMode = theme === 'dark';
            const [userData, setUserData] = React.useState(null);
            const [loading, setLoading] = React.useState(true);
            const [expandedWeek, setExpandedWeek] = React.useState(null);
            const [professorName, setProfessorName] = React.useState('');

            const courseContent = [
                {
                    id: 1,
                    week: 1,
                    title: "Misi√≥n de Inicio - Descubriendo el Territorio de la Investigaci√≥n",
                    description: "Fundamentos de la investigaci√≥n en dise√±o e innovaci√≥n",
                    content: "Presentaci√≥n del curso, acuerdos sobre IA, introducci√≥n a la investigaci√≥n aplicada en dise√±o, innovaci√≥n y experiencia de usuario. Identificaci√≥n de diferentes campos y tipos de investigaci√≥n desde la disciplina del dise√±o.",
                    activities: [
                        "C√≠rculo de Expectativas: Compartir expectativas del curso",
                        "Exploraci√≥n de Casos Inspiradores: An√°lisis de proyectos de investigaci√≥n en dise√±o",
                        "Formaci√≥n de Equipos: Organizaci√≥n en grupos para exposiciones",
                        "Diario del Investigador: Reflexionar sobre 3 preguntas de investigaci√≥n"
                    ],
                    badge: "Iniciaci√≥n",
                    unlocked: true
                },
                {
                    id: 2,
                    weeks: "2-5",
                    title: "Unidad 1: Reconocer los enfoques y rutas de investigaci√≥n",
                    description: "Fundamentos cient√≠ficos y metodol√≥gicos",
                    content: "Exposiciones grupales sobre conceptos fundamentales: Ciencia, Investigaci√≥n cient√≠fica, Tipos de investigaci√≥n cient√≠fica, M√©todo cient√≠fico, Hip√≥tesis, Experimento cient√≠fico, e Investigaci√≥n en Dise√±o. Cada equipo tendr√° 15 minutos para presentar de manera creativa e innovadora. La evaluaci√≥n se realizar√° mediante una r√∫brica que considera creatividad, claridad, conclusiones y participaci√≥n.",
                    activities: [
                        "Semana 2: Exposiciones sobre 'Ciencia' e 'Investigaci√≥n Cient√≠fica'",
                        "Semana 3: Exposiciones sobre 'Tipos de Investigaci√≥n' y 'M√©todo Cient√≠fico'",
                        "Semana 4: Exposiciones sobre 'Hip√≥tesis' y 'Experimento Cient√≠fico'",
                        "Semana 5: Exposici√≥n sobre 'Investigaci√≥n en Dise√±o' y s√≠ntesis",
                        "Debates y reflexiones despu√©s de cada exposici√≥n",
                        "An√°lisis de conexiones con ejemplos de dise√±o"
                    ],
                    badges: ["Maestro Expositor", "Participaci√≥n Activa: Novato", "Participaci√≥n Activa: Aprendiz", "Participaci√≥n Activa: Avanzado", "Participaci√≥n Activa: M√°ster", "Cuestionador Perspicaz", "Clarificador del Saber", "Conector de Conceptos"],
                    unlocked: false,
                    requiredBadge: 1
                },
                {
                    id: 6,
                    week: 6,
                    title: "Misi√≥n de Ideaci√≥n - Sembrando Ideas, Cosechando Problemas",
                    description: "Unidad 2: Planteamiento de la investigaci√≥n",
                    content: "C√≥mo surgen las ideas de investigaci√≥n en el campo del dise√±o e innovaci√≥n: observaci√≥n, tendencias, necesidades no satisfechas, brechas en el conocimiento. T√©cnicas de problematizaci√≥n: '5 Porqu√©s', Diagrama de Ishikawa, √Årbol de Problemas.",
                    activities: [
                        "Tormenta de Ideas Creativa y Problem√°tica (60 min)",
                        "Taller: Descomponiendo el Problema (60 min)",
                        "El Problema del H√©roe: Seleccionar problem√°tica para proyecto",
                        "Mapa Mental del Problema: Visualizar causas, efectos y actores"
                    ],
                    badge: "Sembrador de Ideas",
                    unlocked: false,
                    requiredBadge: 2
                },
                {
                    id: 7,
                    week: 7,
                    title: "Misi√≥n de Precisi√≥n - Afinando la Pregunta Correcta",
                    description: "Formulaci√≥n de preguntas de investigaci√≥n",
                    content: "An√°lisis de problemas en diversos contextos: identificaci√≥n de la poblaci√≥n, el contexto y el alcance. Delimitaci√≥n de problemas de investigaci√≥n: de lo general a lo espec√≠fico. Formulaci√≥n de preguntas de investigaci√≥n con caracter√≠sticas claras, concisas, factibles, relevantes y √©ticas.",
                    activities: [
                        "Taller de Preguntas Poderosas (90 min)",
                        "El Embudo de la Investigaci√≥n (30 min)",
                        "El Enigma Resuelto: Redactar planteamiento del problema",
                        "Definir pregunta de investigaci√≥n final"
                    ],
                    badge: "Art√≠fice de Preguntas",
                    unlocked: false,
                    requiredBadge: 10
                },
                {
                    id: 8,
                    week: 8,
                    title: "Misi√≥n de Fundamentaci√≥n - Construyendo los Pilares del Conocimiento",
                    description: "Revisi√≥n de literatura y objetivos de investigaci√≥n",
                    content: "Revisi√≥n de literatura cient√≠fica: importancia, tipos de fuentes, bases de datos acad√©micas. Estrategias de b√∫squeda sistem√°tica: palabras clave, operadores booleanos, filtros. Formulaci√≥n de objetivos de investigaci√≥n SMART.",
                    activities: [
                        "Cazadores de Conocimiento: Laboratorio de B√∫squeda (75 min)",
                        "Objetivos SMART: Taller de Precisi√≥n (45 min)",
                        "La Biblioteca del Investigador: Revisi√≥n bibliogr√°fica profunda",
                        "Marco Conceptual Preliminar: Identificar conceptos clave"
                    ],
                    badge: "Bibliotecario Experto",
                    unlocked: false,
                    requiredBadge: 11
                },
                {
                    id: 9,
                    week: 9,
                    title: "Misi√≥n de Planificaci√≥n - El Mapa del Tesoro de tu Proyecto",
                    description: "Estructura de la propuesta de investigaci√≥n",
                    content: "Justificaci√≥n de la investigaci√≥n: relevancia te√≥rica, pr√°ctica, social, metodol√≥gica. Alcance y limitaciones del estudio. Estructura completa de la propuesta de investigaci√≥n con todos sus componentes.",
                    activities: [
                        "El Argumento Persuasivo: Taller de Justificaci√≥n (60 min)",
                        "Presentaci√≥n Preliminar del Mapa (60 min)",
                        "El Borrador del Explorador: Consolidar propuesta completa",
                        "Retroalimentaci√≥n constructiva entre compa√±eros"
                    ],
                    badge: "Arquitecto de Proyectos",
                    unlocked: false,
                    requiredBadge: 12
                },
                {
                    id: 10,
                    week: 10,
                    title: "Misi√≥n de Dise√±o - Creando tu Estrategia de Recolecci√≥n",
                    description: "Dise√±o metodol√≥gico y poblaci√≥n de estudio",
                    content: "Dise√±o metodol√≥gico: Selecci√≥n del tipo de estudio. Poblaci√≥n y muestra: criterios de inclusi√≥n y exclusi√≥n, m√©todos de muestreo. Definici√≥n de conceptos clave y operacionalizaci√≥n de variables. Consideraciones sobre validez y fiabilidad.",
                    activities: [
                        "El Laboratorio Metodol√≥gico (90 min)",
                        "Debate: ¬øCu√°ntos y Qui√©nes? (30 min)",
                        "El Arsenal del Investigador: Profundizar marco conceptual",
                        "Esquema Metodol√≥gico Detallado: Desarrollar metodolog√≠a completa"
                    ],
                    badge: "Estratega Metodol√≥gico",
                    unlocked: false,
                    requiredBadge: 13
                },
                {
                    id: 11,
                    week: 11,
                    title: "Misi√≥n de Herramientas - Construyendo tus Instrumentos",
                    description: "T√©cnicas e instrumentos de recolecci√≥n de datos",
                    content: "T√©cnicas de recolecci√≥n de datos cualitativos: entrevistas, grupos focales, observaci√≥n, diarios de campo. T√©cnicas cuantitativas: encuestas, experimentos, pruebas de usabilidad. Dise√±o de instrumentos: redacci√≥n de preguntas, estructura, validaci√≥n.",
                    activities: [
                        "Caja de Herramientas del Investigador: Taller de Dise√±o de Instrumentos (90 min)",
                        "Mini-Simulaci√≥n de Recolecci√≥n (30 min)",
                        "El Kit de Recolecci√≥n: Desarrollar borradores completos",
                        "Ejercicios de role-play y pruebas entre compa√±eros"
                    ],
                    badge: "Constructor de Instrumentos",
                    unlocked: false,
                    requiredBadge: 14
                },
                {
                    id: 12,
                    week: 12,
                    title: "Misi√≥n de Campo - Recolectando los Datos (¬°La Aventura Comienza!)",
                    description: "Ejecuci√≥n de la recolecci√≥n de datos",
                    content: "Ejecuci√≥n de la recolecci√≥n de datos: preparaci√≥n log√≠stica, gesti√≥n de participantes, √©tica en la pr√°ctica. Organizaci√≥n de datos cualitativos y cuantitativos. Manejo de imprevistos durante la recolecci√≥n.",
                    activities: [
                        "Expedici√≥n de Datos: Desaf√≠os y Soluciones (60 min)",
                        "Taller: Organizando el Tesoro (60 min)",
                        "El Diario del Explorador: Iniciar recolecci√≥n de datos",
                        "Base de Datos Preliminar: Organizar datos recolectados"
                    ],
                    badge: "Recolector de Datos",
                    unlocked: false,
                    requiredBadge: 15
                },
                {
                    id: 13,
                    week: 13,
                    title: "Misi√≥n de Descifrado - An√°lisis Cualitativo",
                    description: "Unidad 3: Ejecuci√≥n de la investigaci√≥n",
                    content: "Introducci√≥n al an√°lisis de datos cualitativos: el proceso interpretativo. T√©cnicas de an√°lisis cualitativo: codificaci√≥n, an√°lisis tem√°tico, an√°lisis de contenido. Herramientas para el an√°lisis cualitativo. Interpretaci√≥n de resultados cualitativos.",
                    activities: [
                        "El Detective Cualitativo: Taller de Codificaci√≥n (90 min)",
                        "Discusi√≥n: Historias que los Datos Cuentan (30 min)",
                        "Primeros Hallazgos Cualitativos: An√°lisis preliminar",
                        "Identificar 3-5 temas o categor√≠as emergentes clave"
                    ],
                    badge: "Int√©rprete Cualitativo",
                    unlocked: false,
                    requiredBadge: 16
                },
                {
                    id: 14,
                    week: 14,
                    title: "Misi√≥n de Cuantificaci√≥n - An√°lisis Cuantitativo",
                    description: "An√°lisis de datos cuantitativos",
                    content: "Introducci√≥n al an√°lisis de datos cuantitativos: estad√≠sticas descriptivas. Estad√≠sticas inferenciales b√°sicas. Herramientas para el an√°lisis cuantitativo. Interpretaci√≥n de resultados cuantitativos: patrones, tendencias y relaciones.",
                    activities: [
                        "El Mago de los N√∫meros: Taller de An√°lisis Descriptivo (90 min)",
                        "Debate: ¬øQu√© Nos Dicen los N√∫meros? (30 min)",
                        "Primeros Hallazgos Cuantitativos: An√°lisis preliminar",
                        "Generar 3-5 gr√°ficos o tablas con hallazgos relevantes"
                    ],
                    badge: "Analista Cuantitativo",
                    unlocked: false,
                    requiredBadge: 17
                },
                {
                    id: 15,
                    week: 15,
                    title: "Misi√≥n de Narrativa - Contando tu Historia con Datos",
                    description: "Unidad 4: Presentaci√≥n de resultados",
                    content: "Principios de visualizaci√≥n de datos: claridad, precisi√≥n, integridad, est√©tica. Herramientas de visualizaci√≥n. Estructura del informe final de investigaci√≥n. Redacci√≥n acad√©mica y estilo.",
                    activities: [
                        "El Artista de Datos: Taller de Visualizaci√≥n (90 min)",
                        "Construyendo el Esqueleto del Informe (30 min)",
                        "El Primer Cap√≠tulo: Empezar a redactar informe final",
                        "Crear visualizaciones impactantes para resultados"
                    ],
                    badge: "Narrador Visual",
                    unlocked: false,
                    requiredBadge: 18
                },
                {
                    id: 16,
                    week: 16,
                    title: "Misi√≥n de Impacto - Preparando tu Gran Revelaci√≥n (Entrega Final)",
                    description: "Presentaci√≥n y defensa del proyecto final",
                    content: "Comunicaci√≥n efectiva de resultados de investigaci√≥n: adaptaci√≥n del mensaje a la audiencia, claridad y concisi√≥n. Dise√±o de presentaciones orales. Consideraciones √©ticas en la comunicaci√≥n de resultados. Presentaci√≥n y defensa formal del proyecto.",
                    activities: [
                        "La Defensa del Proyecto (120 min)",
                        "Presentaci√≥n ante profesor y compa√±eros",
                        "Sesi√≥n de preguntas y respuestas",
                        "¬°Disfruta de tu √©xito y celebra tus logros!"
                    ],
                    badge: "Investigador √âlite",
                    unlocked: false,
                    requiredBadge: 19
                }
            ];

            React.useEffect(() => {
                loadUserData();
                loadProfessorName();
            }, []);

            const loadUserData = async () => {
                try {
                    const userDoc = await db.doc(`artifacts/seminario-investigacion-app/users/${currentUser.uid}`).get();
                    if (userDoc.exists) {
                        setUserData(userDoc.data());
                    }
                } catch (error) {
                    console.error('Error cargando datos del usuario:', error);
                } finally {
                    setLoading(false);
                }
            };
            
            const loadProfessorName = async () => {
                try {
                    const userDoc = await db.doc(`artifacts/seminario-investigacion-app/users/${currentUser.uid}`).get();
                    if (userDoc.exists) {
                        const studentData = userDoc.data();
                        const courseCode = studentData.courseCode;
                        
                        const coursesQuery = await db.collection('artifacts/seminario-investigacion-app/courses')
                            .where('courseCode', '==', courseCode)
                            .limit(1)
                            .get();
                        
                        if (!coursesQuery.empty) {
                            const courseData = coursesQuery.docs[0].data();
                            setProfessorName(courseData.professorName || 'No asignado');
                        }
                    }
                } catch (error) {
                    console.error('Error cargando nombre del profesor:', error);
                }
            };

            const handleLogout = async () => {
                try {
                    await auth.signOut();
                    toast.showToast('¬°Hasta luego!', 'success');
                } catch (err) {
                    toast.showToast("Error al cerrar sesi√≥n. Intenta de nuevo.", 'error');
                }
            };

            const getBadgeStatus = (badgeId) => {
                if (!userData || !userData.badgesEarned) return false;
                return userData.badgesEarned.includes(badgeId);
            };

            const getProgressPercentage = () => {
                if (!userData || !userData.badgesEarned) return 0;
                return Math.round((userData.badgesEarned.length / 20) * 100);
            };

            const isContentUnlocked = (content) => {
                if (content.unlocked) return true;
                if (!content.requiredBadge) return true;
                if (content.requiredBadge === 2) {
                    // Week 6 unlocks only after getting badges 1-9 (all from weeks 1-5)
                    const requiredBadges = [1, 2, 3, 4, 5, 6, 7, 8, 9];
                    return requiredBadges.every(badgeId => getBadgeStatus(badgeId));
                }
                return getBadgeStatus(content.requiredBadge);
            };

            if (loading) {
                return <LoadingSpinner />;
            }

            return (
                <div className="min-h-screen p-4 md:p-8" style={{backgroundColor: 'var(--bg-primary)'}}>
                    <header className="card rounded-xl p-6 mb-8 animate-fadeIn">
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div className="flex-1">
                                <h1 className="text-3xl font-bold mb-2" style={{color: 'var(--text-primary)'}}>
                                    Seminario de Investigaci√≥n
                                </h1>
                                <div className="flex items-center gap-2 text-sm" style={{color: 'var(--text-secondary)'}}>
                                    <User />
                                    <span>Hola, <strong>{userData?.fullName || currentUser.email.split('@')[0]}</strong></span>
                                </div>
                                <div className="mt-2">
                                    <div className="flex items-center gap-2 text-sm" style={{color: 'var(--text-secondary)'}}>
                                        <span>Progreso: {getProgressPercentage()}% ({userData?.badgesEarned?.length || 0}/20 badges)</span>
                                    </div>
                                    <div className="w-full bg-gray-200 rounded-full h-2 mt-1">
                                        <div 
                                            className="h-2 rounded-full transition-all duration-300" 
                                            style={{
                                                width: `${getProgressPercentage()}%`,
                                                background: 'linear-gradient(90deg, #ef4444 0%, #f97316 25%, #eab308 50%, #22c55e 75%, #3b82f6 100%)'
                                            }}
                                        ></div>
                                    </div>
                                </div>
                            </div>
                            <div className="flex items-center gap-3">
                                <ThemeToggle />
                                <button
                                    onClick={handleLogout}
                                    className="btn btn-secondary flex items-center gap-2"
                                    title="Cerrar sesi√≥n"
                                >
                                    <LogOut />
                                    <span className="hidden md:inline">Cerrar Sesi√≥n</span>
                                </button>
                            </div>
                        </div>
                    </header>

                    <main className="container mx-auto max-w-6xl">
                        <div className="grid gap-6">
                            {/* Tarjeta de Informaci√≥n General del Curso */}
                            <div className="card rounded-xl overflow-hidden bg-slate-100" style={{
                                borderColor: 'var(--accent-color)'
                            }}>
                                <div 
                                    className="p-6 cursor-pointer transition-colors"
                                    onClick={() => setExpandedWeek(expandedWeek === 'info' ? null : 'info')}
                                >
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center gap-4">
                                            <div className="w-12 h-12 min-w-12 rounded-full flex items-center justify-center text-white font-bold bg-blue-500">
                                                üìö
                                            </div>
                                            <div>
                                                <h2 className="text-xl font-bold text-blue-600">
                                                    Informaci√≥n General del Curso
                                                </h2>
                                                <p className="text-sm text-gray-600">
                                                    Datos del curso y badges disponibles
                                                </p>
                                            </div>
                                        </div>
                                        <div className="text-gray-400">
                                            {expandedWeek === 'info' ? '‚ñ≤' : '‚ñº'}
                                        </div>
                                    </div>
                                </div>
                                
                                {expandedWeek === 'info' && (
                                    <div className="px-6 pb-6 border-t" style={{borderColor: isDarkMode ? '#475569' : 'var(--border-color)'}}>
                                        <div className="mt-4">
                                            <div className="grid md:grid-cols-2 gap-6 mb-6">
                                                <div>
                                                    <h3 className="font-semibold mb-2 text-gray-800">Datos del Curso</h3>
                                                    <ul className="space-y-1 text-sm text-gray-600">
                                                        <li><strong>Nombre:</strong> Seminario de Investigaci√≥n</li>
                                                        <li><strong>C√≥digo:</strong> 12266-DIS</li>
                                                        <li><strong>Periodo:</strong> 202520</li>
                                                        <li><strong>NRE:</strong> 12318</li>
                                                        <li><strong>Grupo:</strong> 001</li>
                                                        <li><strong>Programas:</strong> DIS 03, DMI 03</li>
                                                        <li><strong>Intensidad:</strong> 2 horas semanales</li>
                                                        <li><strong>Cr√©ditos:</strong> 2</li>
                                                        <li><strong>Docente:</strong> {professorName}</li>
                                                    </ul>
                                                </div>
                                                <div>
                                                    <h3 className="font-semibold mb-2 text-gray-800">Introducci√≥n</h3>
                                                    <p className="text-sm text-gray-600">
                                                        El Seminario de Investigaci√≥n est√° dise√±ado para que los estudiantes desarrollen capacidades en investigaci√≥n aplicada al campo del dise√±o, la innovaci√≥n y la experiencia de usuario. Este curso integra la exploraci√≥n de problem√°ticas con el desarrollo de habilidades en investigaci√≥n, preparando a los estudiantes para abordar desaf√≠os desde una perspectiva acad√©mica y pr√°ctica.
                                                    </p>
                                                </div>
                                            </div>
                                            
                                            <div className="mb-6">
                                                <h3 className="font-semibold mb-2 text-gray-800">Acuerdos sobre el Uso de Inteligencia Artificial Generativa (IAG)</h3>
                                                <p className="text-sm text-gray-600">
                                                    Este curso promueve un uso √©tico, cr√≠tico y transparente de las tecnolog√≠as de IAG, permitiendo su aplicaci√≥n en las actividades formativas y evaluativas de acuerdo con los niveles de uso que especifique el profesor. Se debe tener en cuenta que la clasificaci√≥n de cada mecanismo o actividad se refiere al m√°ximo nivel posible de uso de IAG que se espera de los estudiantes en dicho mecanismo o actividad. Durante el desarrollo de la asignatura, cuando se le indique, el estudiante deber√° aplicar y declarar el nivel de uso de la IAG seg√∫n la escala establecida, verificando la calidad, veracidad y pertinencia del contenido generado. Este acuerdo tiene como prop√≥sito fortalecer una relaci√≥n formativa, reflexiva y dial√≥gica con la IAG, orientada al desarrollo de capacidades creativas, investigativas y colaborativas.
                                                </p>
                                            </div>
                                            
                                            <div>
                                                <h3 className="font-semibold mb-3 text-gray-800">üèÜ Badges Disponibles en el Curso</h3>
                                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 text-xs">
                                                    <div className="p-2 bg-white rounded border">
                                                        <div className="font-medium text-blue-600">Badge de Iniciaci√≥n</div>
                                                        <div className="text-gray-600">Semana 1 - Inicio del curso</div>
                                                    </div>
                                                    <div className="p-2 bg-white rounded border">
                                                        <div className="font-medium text-purple-600">Badge de Maestro Expositor</div>
                                                        <div className="text-gray-600">Semanas 2-5 - Exposici√≥n grupal</div>
                                                    </div>
                                                    <div className="p-2 bg-white rounded border">
                                                        <div className="font-medium text-green-600">Badges de Participaci√≥n Activa</div>
                                                        <div className="text-gray-600">Novato, Aprendiz, Avanzado, M√°ster</div>
                                                    </div>
                                                    <div className="p-2 bg-white rounded border">
                                                        <div className="font-medium text-orange-600">Badge de Cuestionador Perspicaz</div>
                                                        <div className="text-gray-600">Preguntas desafiantes</div>
                                                    </div>
                                                    <div className="p-2 bg-white rounded border">
                                                        <div className="font-medium text-teal-600">Badge de Clarificador del Saber</div>
                                                        <div className="text-gray-600">Respuestas claras</div>
                                                    </div>
                                                    <div className="p-2 bg-white rounded border">
                                                        <div className="font-medium text-indigo-600">Badge de Conector de Conceptos</div>
                                                        <div className="text-gray-600">S√≠ntesis y conexiones</div>
                                                    </div>
                                                    <div className="p-2 bg-white rounded border">
                                                        <div className="font-medium text-red-600">Badges de Investigaci√≥n</div>
                                                        <div className="text-gray-600">Semanas 6-16 - Proyecto final</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                            {courseContent.map((content) => {
                                const unlocked = isContentUnlocked(content);
                                const isExpanded = expandedWeek === content.id;
                                
                                return (
                                    <div key={content.id} className={`card rounded-xl overflow-hidden ${
                                        !unlocked ? 'opacity-50' : ''
                                    }`}>
                                        <div 
                                            className={`p-6 transition-colors ${
                                                unlocked ? 'cursor-pointer' : 'cursor-not-allowed'
                                            }`}
                                            onClick={() => unlocked && setExpandedWeek(isExpanded ? null : content.id)}
                                        >
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center gap-4">
                                                    <div className={`w-12 h-12 min-w-12 rounded-full flex items-center justify-center text-white font-bold ${
                                                        unlocked ? 'bg-blue-500' : 'bg-gray-400'
                                                    }`}>
                                                        {unlocked ? (content.week || (content.weeks === '2-5' ? '2' : content.weeks)) : 'üîí'}
                                                    </div>
                                                    <div>
                                                        <h3 className="text-lg font-semibold">
                                                            {content.week ? `Semana ${content.week}` : `Semanas ${content.weeks}`}: {content.title}
                                                        </h3>
                                                        <p className="text-sm" style={{color: 'var(--text-secondary)'}}>
                                                            {content.description}
                                                        </p>
                                                        {!unlocked && (
                                                            <span className="inline-block mt-1 px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">
                                                                Bloqueado - Completa badge anterior
                                                            </span>
                                                        )}
                                                        {unlocked && content.badge && (
                                                            <span className={`inline-block mt-1 px-2 py-1 text-xs rounded-full ${
                                                                getBadgeStatus(content.id === 1 ? 1 : content.id + 4) 
                                                                    ? 'bg-green-100 text-green-800' 
                                                                    : 'bg-gray-100 text-gray-600'
                                                            }`}>
                                                                {getBadgeStatus(content.id === 1 ? 1 : content.id + 4) ? 'üèÜ' : '‚óã'} {content.badge}
                                                            </span>
                                                        )}
                                                        {unlocked && content.badges && (
                                                            <div className="mt-2 flex flex-wrap gap-1">
                                                                {content.badges.map((badge, index) => {
                                                                    const badgeId = content.weeks === "2-5" ? index + 2 : index + 1;
                                                                    const badgeEarned = getBadgeStatus(badgeId);
                                                                    return (
                                                                        <span key={index} className={`px-2 py-1 text-xs rounded-full ${
                                                                            badgeEarned 
                                                                                ? 'bg-green-100 text-green-800' 
                                                                                : 'bg-gray-100 text-gray-600'
                                                                        }`}>
                                                                            {badgeEarned ? 'üèÜ' : '‚óã'} {badge}
                                                                        </span>
                                                                    );
                                                                })}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                                <div className="text-gray-400">
                                                    {unlocked ? (isExpanded ? '‚ñ≤' : '‚ñº') : ''}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {isExpanded && unlocked && (
                                            <div className="px-6 pb-6 border-t" style={{borderColor: 'var(--border-color)'}}>
                                                <div className="mt-4">
                                                    <h4 className="font-semibold mb-2">Contenido:</h4>
                                                    <p className="mb-4" style={{color: 'var(--text-secondary)'}}>
                                                        {content.content}
                                                    </p>
                                                    
                                                    <h4 className="font-semibold mb-2">Actividades:</h4>
                                                    <ul className="space-y-1 mb-6">
                                                        {content.activities.map((activity, index) => (
                                                            <li key={index} className="flex items-start gap-2">
                                                                <span className="text-blue-500 mt-1">‚Ä¢</span>
                                                                <span style={{color: 'var(--text-secondary)'}}>{activity}</span>
                                                            </li>
                                                        ))}
                                                    </ul>
                                                    
                                                    {content.weeks === "2-5" && (
                                                        <div className="mt-6">
                                                            <h4 className="font-semibold mb-3">üìã R√∫brica de Evaluaci√≥n</h4>
                                                            <div className="overflow-x-auto">
                                                                <table className="w-full text-sm border-collapse border" style={{borderColor: 'var(--border-color)'}}>
                                                                    <thead>
                                                                        <tr className="bg-gray-50">
                                                                            <th className="border p-2 text-left font-semibold text-gray-800" style={{borderColor: 'var(--border-color)'}}></th>
                                                                            <th className="border p-2 text-center font-semibold bg-green-100 text-gray-800" style={{borderColor: 'var(--border-color)'}}>Excelente</th>
                                                                            <th className="border p-2 text-center font-semibold bg-yellow-100 text-gray-800" style={{borderColor: 'var(--border-color)'}}>Bueno</th>
                                                                            <th className="border p-2 text-center font-semibold bg-orange-100 text-gray-800" style={{borderColor: 'var(--border-color)'}}>Regular</th>
                                                                            <th className="border p-2 text-center font-semibold bg-red-100 text-gray-800" style={{borderColor: 'var(--border-color)'}}>Necesita Mejorar</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                        <tr>
                                                                            <td className="border p-2 font-semibold bg-gray-50 text-gray-800" style={{borderColor: 'var(--border-color)'}}>Creatividad</td>
                                                                            <td className="border p-2 text-xs bg-green-50 text-gray-800" style={{borderColor: 'var(--border-color)'}}>Presenta el contenido de manera altamente innovadora y original. Utiliza recursos visuales y/o interactivos √∫nicos que captan la atenci√≥n. Demuestra un pensamiento fuera de lo convencional.</td>
                                                                            <td className="border p-2 text-xs bg-yellow-50 text-gray-800" style={{borderColor: 'var(--border-color)'}}>Demuestra creatividad en la presentaci√≥n del contenido. Utiliza algunos recursos originales. Las ideas se presentan de forma interesante.</td>
                                                                            <td className="border p-2 text-xs bg-orange-50 text-gray-800" style={{borderColor: 'var(--border-color)'}}>La presentaci√≥n es convencional pero correcta. Utiliza recursos comunes. Hay algunos intentos de originalidad.</td>
                                                                            <td className="border p-2 text-xs bg-red-50 text-gray-800" style={{borderColor: 'var(--border-color)'}}>La presentaci√≥n carece de elementos creativos. Utiliza m√©todos muy b√°sicos o repetitivos. No hay originalidad en el enfoque.</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <td className="border p-2 font-semibold bg-gray-50 text-gray-800" style={{borderColor: 'var(--border-color)'}}>Claridad</td>
                                                                            <td className="border p-2 text-xs bg-green-50 text-gray-800" style={{borderColor: 'var(--border-color)'}}>La exposici√≥n es extraordinariamente clara y bien estructurada. Las ideas fluyen de manera l√≥gica y coherente. El lenguaje es preciso y adecuado. La informaci√≥n se transmite de forma efectiva.</td>
                                                                            <td className="border p-2 text-xs bg-yellow-50 text-gray-800" style={{borderColor: 'var(--border-color)'}}>La exposici√≥n es clara y comprensible. La mayor√≠a de las ideas est√°n bien organizadas. El lenguaje es apropiado aunque con algunas imprecisiones.</td>
                                                                            <td className="border p-2 text-xs bg-orange-50 text-gray-800" style={{borderColor: 'var(--border-color)'}}>La exposici√≥n es algo confusa en ciertos puntos. Algunas ideas no est√°n bien conectadas. El lenguaje puede ser impreciso o inadecuado ocasionalmente.</td>
                                                                            <td className="border p-2 text-xs bg-red-50 text-gray-800" style={{borderColor: 'var(--border-color)'}}>La exposici√≥n es dif√≠cil de seguir. Las ideas est√°n desorganizadas. El lenguaje es confuso o inapropiado frecuentemente.</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <td className="border p-2 font-semibold bg-gray-50 text-gray-800" style={{borderColor: 'var(--border-color)'}}>Conclusiones</td>
                                                                            <td className="border p-2 text-xs bg-green-50 text-gray-800" style={{borderColor: 'var(--border-color)'}}>Las conclusiones son profundas y bien fundamentadas. Formula preguntas originales y estimulantes que generan discusi√≥n significativa. Demuestra una comprensi√≥n excepcional del tema.</td>
                                                                            <td className="border p-2 text-xs bg-yellow-50 text-gray-800" style={{borderColor: 'var(--border-color)'}}>Las conclusiones son v√°lidas y est√°n bien presentadas. Las preguntas son relevantes y promueven cierta discusi√≥n. Demuestra buena comprensi√≥n del tema.</td>
                                                                            <td className="border p-2 text-xs bg-orange-50 text-gray-800" style={{borderColor: 'var(--border-color)'}}>Las conclusiones son b√°sicas o superficiales. Las preguntas son simples o poco elaboradas. Demuestra comprensi√≥n parcial del tema.</td>
                                                                            <td className="border p-2 text-xs bg-red-50 text-gray-800" style={{borderColor: 'var(--border-color)'}}>Las conclusiones son d√©biles o ausentes. Las preguntas son irrelevantes o no se formulan. Demuestra poca comprensi√≥n del tema.</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <td className="border p-2 font-semibold bg-gray-50 text-gray-800" style={{borderColor: 'var(--border-color)'}}>Preguntas</td>
                                                                            <td className="border p-2 text-xs bg-green-50 text-gray-800" style={{borderColor: 'var(--border-color)'}}>Participa activamente en todas las exposiciones. Hace comentarios constructivos y preguntas relevantes. Demuestra inter√©s genuino y respeto por el trabajo de otros.</td>
                                                                            <td className="border p-2 text-xs bg-yellow-50 text-gray-800" style={{borderColor: 'var(--border-color)'}}>Participa regularmente en las exposiciones. Hace algunos comentarios y preguntas √∫tiles. Muestra inter√©s por el trabajo de otros.</td>
                                                                            <td className="border p-2 text-xs bg-orange-50 text-gray-800" style={{borderColor: 'var(--border-color)'}}>Participa ocasionalmente en las exposiciones. Los comentarios son limitados o poco elaborados. Muestra inter√©s intermitente.</td>
                                                                            <td className="border p-2 text-xs bg-red-50 text-gray-800" style={{borderColor: 'var(--border-color)'}}>Raramente participa en las exposiciones. No hace comentarios ni preguntas. Muestra poco inter√©s por el trabajo de otros.</td>
                                                                        </tr>
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </main>
                </div>
            );
        }

        function AppContent() {
            const [currentUser, setCurrentUser] = React.useState(null);
            const [userData, setUserData] = React.useState(null);
            const [authReady, setAuthReady] = React.useState(false);
            const toast = useToast();

            const firebaseConfig = {
                apiKey: "AIzaSyBEKzy25wj-qIVJcyqkCors2b8zPostu7E",
                authDomain: "seminario-de-investigaci-283c8.firebaseapp.com",
                projectId: "seminario-de-investigaci-283c8",
                storageBucket: "seminario-de-investigaci-283c8.firebasestorage.app",
                messagingSenderId: "253114435967",
                appId: "1:253114435967:web:b83b9413f663f283b7724a",
                measurementId: "G-7J76P5D7Z3"
            };

            React.useEffect(() => {
                firebase.initializeApp(firebaseConfig);
                const auth = firebase.auth();
                
                const unsubscribe = auth.onAuthStateChanged(async (user) => {
                    setCurrentUser(user);
                    
                    if (user) {
                        try {
                            const db = firebase.firestore();
                            const userDoc = await db.doc(`artifacts/seminario-investigacion-app/users/${user.uid}`).get();
                            if (userDoc.exists) {
                                setUserData(userDoc.data());
                            }
                        } catch (error) {
                            console.error('Error cargando datos del usuario:', error);
                        }
                    } else {
                        setUserData(null);
                    }
                    
                    setAuthReady(true);
                });
                
                return () => unsubscribe();
            }, []);

            if (!authReady) {
                return <LoadingSpinner />;
            }

            return (
                <>
                    {currentUser ? (
                        userData?.userType === 'professor' ? (
                            <AdminDashboard currentUser={currentUser} />
                        ) : (
                            <CoursePage currentUser={currentUser} />
                        )
                    ) : (
                        <AuthPage />
                    )}
                </>
            );
        }
        
        function App() {
            return (
                <ToastProvider>
                    <AppContent />
                </ToastProvider>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>